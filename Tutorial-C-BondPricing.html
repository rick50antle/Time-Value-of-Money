<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutorial C: Bond Pricing (Premiums &amp; Discounts)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .hide-mobile { }
        @media (max-width: 600px) { .hide-mobile { display: none; } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
/**
 * Tutorial C: Bond Pricing (Premiums & Discounts)
 * ACCT 2700 - Foundations of Accounting & Valuation
 * Yale School of Management
 */

// LucideIcon helper component
const LucideIcon = ({ name, size = 24, color = 'currentColor', style = {} }) => {
    const iconRef = React.useRef(null);
    React.useEffect(() => {
        if (iconRef.current && lucide[name]) {
            iconRef.current.innerHTML = '';
            const svg = lucide.createElement(lucide[name]);
            svg.setAttribute('width', size);
            svg.setAttribute('height', size);
            svg.setAttribute('stroke', color);
            iconRef.current.appendChild(svg);
        }
    }, [name, size, color]);
    return <span ref={iconRef} style={{ display: 'inline-flex', alignItems: 'center', ...style }} />;
};

// CONSTANTS
const CONSTANTS = {
  FACE_VALUE: 100,
  COUPON_RATE: 0.06,
  PERIODS: 3,
  RATE_AT_PAR: 0.06,
  RATE_DISCOUNT: 0.08,
  RATE_PREMIUM: 0.04,
  COUPON_PAYMENT: 6.00,
  FINAL_PAYMENT: 106.00,
  PRICE_AT_PAR: 100.00,
  PRICE_AT_DISCOUNT: 94.85,
  PRICE_AT_PREMIUM: 105.55,
  PV_COUPON_1_AT_PAR: 5.66,
  PV_COUPON_2_AT_PAR: 5.34,
  PV_FINAL_AT_PAR: 89.00,
  PV_COUPON_1_AT_DISCOUNT: 5.56,
  PV_COUPON_2_AT_DISCOUNT: 5.14,
  PV_FINAL_AT_DISCOUNT: 84.15,
  PV_COUPON_1_AT_PREMIUM: 5.77,
  PV_COUPON_2_AT_PREMIUM: 5.55,
  PV_FINAL_AT_PREMIUM: 94.23,
  TOLERANCE: 0.05,
  ESTIMATED_CORE_TIME: 15,
  ESTIMATED_FULL_TIME: 20,
};

// COLORS
const COLORS = {
  primary: '#00356b',
  primaryLight: '#1a4a7a',
  primaryDark: '#002548',
  background: '#f8fafc',
  surface: '#ffffff',
  surfaceAlt: '#f1f5f9',
  border: '#e2e8f0',
  borderDark: '#cbd5e1',
  textPrimary: '#1e293b',
  textSecondary: '#64748b',
  textMuted: '#94a3b8',
  accent: '#0369a1',
  accentLight: '#e0f2fe',
  gold: '#ca8a04',
  goldLight: '#fef9c3',
  goldBorder: '#eab308',
  success: '#16a34a',
  successBg: '#f0fdf4',
  successBorder: '#86efac',
  warning: '#d97706',
  warningBg: '#fffbeb',
  warningBorder: '#fcd34d',
  error: '#dc2626',
  errorBg: '#fef2f2',
  rabbitHole: '#7c3aed',
  rabbitHoleLight: '#ede9fe',
  rabbitHoleBorder: '#a78bfa',
  celebrationBg: 'linear-gradient(135deg, #fef9c3 0%, #fef3c7 50%, #fde68a 100%)',
};

// TUTORIAL STRUCTURE
const PARTS = [
  { id: 'puzzleRevisited', title: 'The Puzzle Revisited', steps: 2 },
  { id: 'bondAnatomy', title: 'Bond Anatomy', steps: 4 },
  { id: 'couponEqualsInterest', title: 'When Coupon = Interest', steps: 3 },
  { id: 'buildingSpreadsheet', title: 'Building the Spreadsheet', steps: 5 },
  { id: 'interestGreaterThanCoupon', title: 'Interest > Coupon', steps: 3 },
  { id: 'interestLessThanCoupon', title: 'Interest < Coupon', steps: 3 },
  { id: 'summary', title: 'Summary', steps: 2 },
  { id: 'complete', title: 'Complete', steps: 1 },
];

// RABBIT HOLES DATA
const RABBIT_HOLES = {
  irvingFisher: {
    id: 'irvingFisher',
    title: 'Irving Fisher: Genius Who Went Broke',
    partId: 'bondAnatomy',
    content: `Irving Fisher (1867-1947) was a Yale economist who essentially invented the modern theory of present value and interest rates. His 1930 book "The Theory of Interest" remains foundational to how we think about bonds and valuation.

Fisher was the first to clearly articulate that a bond's value is simply the present value of its promised cash flows — the insight we're building toward in this tutorial.

Here's the twist: Fisher was also a stock market speculator. In 1929, just before the crash, he famously declared that stock prices had reached "a permanently high plateau." He lost his fortune in the crash and had to be bailed out by Yale and relatives.

This isn't a story about Fisher being stupid — he was brilliant. It's a reminder that understanding financial theory doesn't immunize you from financial mistakes. Even the person who pioneered bond valuation couldn't predict the market.`
  },
  fieldTrip: {
    id: 'fieldTrip',
    title: 'The 4th Floor Field Trip',
    partId: 'bondAnatomy',
    content: `There are actual, physical bond certificates on the 4th floor of the Yale School of Management building. These historical artifacts show what "coupon bonds" literally meant.

Old bond certificates had small paper coupons attached along the edge — like tear-off tickets. When an interest payment was due, you would physically clip off the coupon with scissors and present it to a bank for payment. That's why we still call the interest payments on bonds "coupons" — even though everything is electronic now.

The word "coupon" comes from the French "couper," meaning "to cut." You literally cut off each coupon as it came due.

Looking at these old certificates, you can see the rows of coupons along the edge, each printed with a date and amount. It makes the abstract concept of "promised cash flows" very concrete — someone designed and printed these promises on paper.`
  },
  zeroCoupon: {
    id: 'zeroCoupon',
    title: 'Zero-Coupon Bonds: The Simplest Case',
    partId: 'buildingSpreadsheet',
    content: `What if a bond paid no coupons at all? Just the face value at maturity?

This is called a zero-coupon bond (or "zero" for short). It's actually the simplest case to analyze:

• No coupon payments along the way
• Just one cash flow: the face value at maturity
• Price = Face Value ÷ (1 + r)^n

Here's the key insight: A zero-coupon bond ALWAYS sells at a discount to its face value (assuming positive interest rates). There's no coupon "bonus" to make it worth more.

Example: A 3-period zero with $100 face value at 6%:
Price = $100 ÷ 1.06³ = $83.96

Sound familiar? That's the same present value calculation we did in the earlier tutorials! A zero-coupon bond is just a single future payment — the simplest possible bond.

Treasury Bills (T-Bills) work this way. You might buy a $10,000 T-Bill for $9,800 and receive $10,000 at maturity. The $200 difference is your interest.`
  },
};

const TOTAL_RABBIT_HOLES = Object.keys(RABBIT_HOLES).length;

// GLOSSARY DATA
const GLOSSARY = {
  bond: { term: 'Bond', definition: 'A promise to pay periodic coupon payments plus the face value at maturity. Essentially, an annuity plus a lump sum.' },
  faceValue: { term: 'Face Value (Par Value)', definition: 'The amount a bond pays at maturity; also the base for calculating coupon payments. Typically $100 or $1,000.' },
  couponRate: { term: 'Coupon Rate', definition: 'The percentage stated on a bond that determines the size of coupon payments. This is contractual language describing promised cash flows — NOT an interest rate. The coupon rate is fixed when the bond is issued.' },
  couponPayment: { term: 'Coupon Payment', definition: 'The periodic payment a bond makes, calculated as Face Value × Coupon Rate. For a $100 bond with 6% coupon rate, the coupon payment is $6.' },
  maturity: { term: 'Maturity', definition: 'The date when a bond expires and the face value is returned to the bondholder.' },
  interestRate: { term: 'Interest Rate (Discount Rate)', definition: 'The market price of borrowing money through time. This determines what promised cash flows are WORTH today. Unlike the coupon rate, the interest rate changes constantly with market conditions.' },
  parBond: { term: 'At Par', definition: 'When a bond\'s price equals its face value. This happens when the coupon rate equals the market interest rate.' },
  discountBond: { term: 'At Discount', definition: 'When a bond\'s price is below its face value. This happens when the market interest rate is higher than the coupon rate. Note: "discount" doesn\'t mean bargain — it\'s just terminology for price below face value.' },
  premiumBond: { term: 'At Premium', definition: 'When a bond\'s price is above its face value. This happens when the market interest rate is lower than the coupon rate.' },
  presentValue: { term: 'Present Value (PV)', definition: 'The value today of future cash flows, discounted at a given interest rate.' },
  discountFactor: { term: 'Discount Factor', definition: 'The multiplier used to convert a future value to present value. For period n at rate r: 1/(1+r)^n' },
};

// SOUND SYSTEM
const playSound = (type) => {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);
    switch (type) {
      case 'success':
        oscillator.frequency.setValueAtTime(523.25, ctx.currentTime);
        oscillator.frequency.setValueAtTime(659.25, ctx.currentTime + 0.1);
        oscillator.frequency.setValueAtTime(783.99, ctx.currentTime + 0.2);
        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.4);
        break;
      case 'softNope':
        oscillator.frequency.setValueAtTime(783.99, ctx.currentTime);
        oscillator.frequency.setValueAtTime(659.25, ctx.currentTime + 0.15);
        gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.3);
        break;
      case 'click':
        oscillator.frequency.setValueAtTime(600, ctx.currentTime);
        gainNode.gain.setValueAtTime(0.15, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.08);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.08);
        break;
      case 'rabbitHole':
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(880, ctx.currentTime);
        oscillator.frequency.setValueAtTime(932.33, ctx.currentTime + 0.05);
        oscillator.frequency.setValueAtTime(880, ctx.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.25);
        break;
      case 'insight':
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(523.25, ctx.currentTime);
        oscillator.frequency.setValueAtTime(659.25, ctx.currentTime + 0.15);
        oscillator.frequency.setValueAtTime(783.99, ctx.currentTime + 0.3);
        oscillator.frequency.setValueAtTime(1046.50, ctx.currentTime + 0.45);
        gainNode.gain.setValueAtTime(0.25, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.6);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.6);
        break;
      case 'celebration':
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(523.25, ctx.currentTime);
        oscillator.frequency.setValueAtTime(659.25, ctx.currentTime + 0.1);
        oscillator.frequency.setValueAtTime(783.99, ctx.currentTime + 0.2);
        oscillator.frequency.setValueAtTime(1046.50, ctx.currentTime + 0.3);
        oscillator.frequency.setValueAtTime(1318.51, ctx.currentTime + 0.4);
        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.8);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.8);
        break;
      default:
        break;
    }
    setTimeout(() => ctx.close(), 1000);
  } catch (e) {}
};

// UTILITY FUNCTIONS
const formatCurrency = (value) => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  }).format(value);
};

const parseUserInput = (input) => {
  const cleaned = String(input).replace(/[$,\s]/g, '');
  return parseFloat(cleaned);
};

const checkAnswer = (userValue, correctValue, tolerance = CONSTANTS.TOLERANCE) => {
  return Math.abs(userValue - correctValue) <= tolerance;
};

const calculateProgress = (currentPartIndex, currentStep) => {
  const totalSteps = PARTS.reduce((sum, p) => sum + p.steps, 0);
  if (currentPartIndex === PARTS.length - 1) return 100;
  const completedSteps = PARTS.slice(0, currentPartIndex).reduce((sum, p) => sum + p.steps, 0) + currentStep;
  return Math.round((completedSteps / totalSteps) * 100);
};

// Header Component
const Header = ({ currentPartIndex, currentStep, exploredRabbitHoles, totalRabbitHoles, onGlossaryClick, onRestartClick, onHeaderClick, soundEnabled, onSoundToggle }) => {
  const progress = calculateProgress(currentPartIndex, currentStep);
  const currentPart = PARTS[currentPartIndex];
  return (
    <header style={{ background: COLORS.primary, color: 'white', padding: '16px 24px', position: 'sticky', top: 0, zIndex: 100 }}>
      <div style={{ maxWidth: '800px', margin: '0 auto' }}>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px', flexWrap: 'wrap', gap: '8px' }}>
          <h1 onClick={onHeaderClick} style={{ fontSize: '18px', fontWeight: '600', margin: 0, cursor: 'default', userSelect: 'none' }}>Bond Pricing</h1>
          <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
            <button onClick={onSoundToggle} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '6px', padding: '6px', cursor: 'pointer', color: 'white', display: 'flex', alignItems: 'center' }} title={soundEnabled ? 'Mute sounds' : 'Enable sounds'}>
              {soundEnabled ? <LucideIcon name="Volume2" size={18} /> : <LucideIcon name="VolumeX" size={18} />}
            </button>
            <div style={{ display: 'flex', alignItems: 'center', gap: '4px', background: COLORS.rabbitHoleLight, color: COLORS.rabbitHole, padding: '4px 10px', borderRadius: '12px', fontSize: '13px', fontWeight: '500' }}>
              <LucideIcon name="Rabbit" size={14} />
              {exploredRabbitHoles.length}/{totalRabbitHoles}
            </div>
            <button onClick={onGlossaryClick} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '6px', padding: '6px 10px', cursor: 'pointer', color: 'white', display: 'flex', alignItems: 'center', gap: '4px', fontSize: '13px' }}>
              <LucideIcon name="BookOpen" size={16} />
              <span className="hide-mobile">Glossary</span>
            </button>
            <button onClick={onRestartClick} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '6px', padding: '6px', cursor: 'pointer', color: 'white', display: 'flex', alignItems: 'center' }} title="Restart tutorial">
              <LucideIcon name="RotateCcw" size={18} />
            </button>
          </div>
        </div>
        <div>
          <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '13px', marginBottom: '6px', opacity: 0.9 }}>
            <span>Part {currentPartIndex + 1}: {currentPart.title}</span>
            <span>{progress}% complete</span>
          </div>
          <div style={{ background: 'rgba(255,255,255,0.2)', borderRadius: '4px', height: '6px', overflow: 'hidden' }}>
            <div style={{ background: COLORS.goldBorder, height: '100%', width: `${progress}%`, transition: 'width 0.3s ease', borderRadius: '4px' }} />
          </div>
        </div>
      </div>
    </header>
  );
};

// NavButtons Component
const NavButtons = ({ onBack, onContinue, canGoBack, canContinue, continueLabel = 'Continue', soundEnabled }) => {
  const handleContinue = () => { if (soundEnabled) playSound('click'); onContinue(); };
  const handleBack = () => { if (soundEnabled) playSound('click'); onBack(); };
  return (
    <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '32px', paddingTop: '24px', borderTop: `1px solid ${COLORS.border}` }}>
      <button onClick={handleBack} disabled={!canGoBack} style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '10px 20px', border: `1px solid ${COLORS.border}`, borderRadius: '8px', background: 'white', color: canGoBack ? COLORS.textPrimary : COLORS.textMuted, cursor: canGoBack ? 'pointer' : 'not-allowed', fontSize: '15px', opacity: canGoBack ? 1 : 0.5 }}>
        <LucideIcon name="ChevronLeft" size={18} />
        Back
      </button>
      <button onClick={handleContinue} disabled={!canContinue} style={{ display: 'flex', alignItems: 'center', gap: '6px', padding: '10px 24px', border: 'none', borderRadius: '8px', background: canContinue ? COLORS.primary : COLORS.textMuted, color: 'white', cursor: canContinue ? 'pointer' : 'not-allowed', fontSize: '15px', fontWeight: '500' }}>
        {continueLabel}
        <LucideIcon name="ChevronRight" size={18} />
      </button>
    </div>
  );
};

// ChoiceButton Component
const ChoiceButton = ({ label, selected, correct, submitted, onClick, disabled }) => {
  let background = 'white';
  let borderColor = COLORS.border;
  let textColor = COLORS.textPrimary;
  if (selected && !submitted) { background = COLORS.accentLight; borderColor = COLORS.accent; }
  else if (submitted) {
    if (correct) { background = COLORS.successBg; borderColor = COLORS.successBorder; }
    else if (selected && !correct) { background = COLORS.warningBg; borderColor = COLORS.warningBorder; }
    else { textColor = COLORS.textMuted; }
  }
  return (
    <button onClick={onClick} disabled={disabled || submitted} style={{ display: 'flex', alignItems: 'center', gap: '12px', width: '100%', padding: '14px 16px', border: `2px solid ${borderColor}`, borderRadius: '10px', background, color: textColor, cursor: disabled || submitted ? 'default' : 'pointer', fontSize: '15px', textAlign: 'left', transition: 'all 0.2s ease', marginBottom: '8px' }}>
      {submitted && correct && <LucideIcon name="Check" size={20} color={COLORS.success} />}
      {submitted && selected && !correct && <LucideIcon name="X" size={20} color={COLORS.warning} />}
      {!submitted && <div style={{ width: '20px', height: '20px', borderRadius: '50%', border: `2px solid ${selected ? COLORS.accent : COLORS.border}`, background: selected ? COLORS.accent : 'white', flexShrink: 0 }} />}
      <span>{label}</span>
    </button>
  );
};

// CalculationBox Component
const CalculationBox = ({ prompt, correctAnswer, hint1, hint2, onCorrect, soundEnabled, tolerance = CONSTANTS.TOLERANCE, disabled = false }) => {
  const [input, setInput] = React.useState('');
  const [attempts, setAttempts] = React.useState(0);
  const [isCorrect, setIsCorrect] = React.useState(false);
  const [showHint, setShowHint] = React.useState(null);
  const handleCheck = () => {
    if (disabled || isCorrect) return;
    const userValue = parseUserInput(input);
    if (isNaN(userValue)) { setShowHint('Please enter a valid number'); return; }
    if (checkAnswer(userValue, correctAnswer, tolerance)) {
      setIsCorrect(true);
      if (soundEnabled) playSound('success');
      onCorrect?.();
    } else {
      const newAttempts = attempts + 1;
      setAttempts(newAttempts);
      if (soundEnabled) playSound('softNope');
      if (newAttempts >= 3) { setShowHint(`The answer is ${formatCurrency(correctAnswer)}`); setIsCorrect(true); onCorrect?.(); }
      else if (newAttempts === 2 && hint2) { setShowHint(hint2); }
      else if (hint1) { setShowHint(hint1); }
    }
  };
  return (
    <div style={{ background: COLORS.surfaceAlt, border: `1px solid ${COLORS.border}`, borderRadius: '12px', padding: '20px', marginTop: '16px', opacity: disabled ? 0.6 : 1 }}>
      <p style={{ margin: '0 0 16px 0', fontSize: '15px', color: COLORS.textPrimary, fontFamily: 'monospace' }}>{prompt}</p>
      <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
        <div style={{ position: 'relative', flex: 1 }}>
          <span style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: COLORS.textMuted }}>$</span>
          <input type="text" value={input} onChange={(e) => setInput(e.target.value)} disabled={isCorrect || disabled} placeholder="0.00" style={{ width: '100%', padding: '12px 12px 12px 28px', border: `2px solid ${isCorrect ? COLORS.successBorder : COLORS.border}`, borderRadius: '8px', fontSize: '16px', fontFamily: 'monospace', background: isCorrect ? COLORS.successBg : 'white', boxSizing: 'border-box' }} onKeyDown={(e) => e.key === 'Enter' && !isCorrect && handleCheck()} />
        </div>
        <button onClick={handleCheck} disabled={isCorrect || !input || disabled} style={{ padding: '12px 20px', border: 'none', borderRadius: '8px', background: isCorrect ? COLORS.success : COLORS.primary, color: 'white', fontSize: '15px', fontWeight: '500', cursor: isCorrect || !input || disabled ? 'default' : 'pointer', display: 'flex', alignItems: 'center', gap: '6px', flexShrink: 0 }}>
          {isCorrect ? <LucideIcon name="Check" size={18} /> : 'Check'}
        </button>
      </div>
      {showHint && (
        <p style={{ marginTop: '12px', padding: '10px 12px', background: isCorrect && attempts >= 3 ? COLORS.warningBg : COLORS.accentLight, borderRadius: '6px', fontSize: '14px', color: isCorrect && attempts >= 3 ? COLORS.warning : COLORS.accent }}>{showHint}</p>
      )}
    </div>
  );
};

// InsightBox Component
const InsightBox = ({ children, icon, celebration = false }) => (
  <div style={{ background: celebration ? COLORS.celebrationBg : COLORS.goldLight, border: `2px solid ${COLORS.goldBorder}`, borderRadius: '12px', padding: celebration ? '24px' : '20px', marginTop: '20px', marginBottom: '20px', boxShadow: celebration ? '0 4px 12px rgba(202, 138, 4, 0.2)' : 'none' }}>
    <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-start' }}>
      {celebration ? <LucideIcon name="Sparkles" size={28} color={COLORS.gold} style={{ flexShrink: 0, marginTop: '2px' }} /> : (icon || <LucideIcon name="TrendingUp" size={24} color={COLORS.gold} style={{ flexShrink: 0, marginTop: '2px' }} />)}
      <div style={{ fontSize: celebration ? '17px' : '16px', lineHeight: '1.6', color: COLORS.textPrimary }}>{children}</div>
    </div>
  </div>
);

// BondCashFlowDiagram Component
const BondCashFlowDiagram = ({ cashFlows = [6, 6, 106], highlightIndex = null, showLabels = true }) => {
  return (
    <div style={{ background: COLORS.surfaceAlt, borderRadius: '12px', padding: '24px', marginTop: '16px', marginBottom: '16px' }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end', position: 'relative', minHeight: '100px', paddingBottom: '50px', marginBottom: '8px' }}>
        <div style={{ position: 'absolute', bottom: '25px', left: '10%', right: '10%', height: '3px', background: COLORS.borderDark }} />
        <div style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', position: 'relative' }}>
          <div style={{ width: '14px', height: '14px', borderRadius: '50%', background: COLORS.textSecondary, position: 'absolute', bottom: '18px' }} />
          <span style={{ position: 'absolute', bottom: '-5px', fontSize: '13px', color: COLORS.textSecondary, fontWeight: '500' }}>Time 0</span>
        </div>
        {cashFlows.map((amount, index) => {
          const isHighlighted = highlightIndex === index;
          const isFinal = index === cashFlows.length - 1;
          return (
            <div key={index} style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', position: 'relative' }}>
              <div style={{ background: isFinal ? COLORS.goldLight : 'white', border: `2px solid ${isFinal ? COLORS.goldBorder : isHighlighted ? COLORS.primary : COLORS.border}`, borderRadius: '8px', padding: '8px 12px', marginBottom: '8px', boxShadow: isHighlighted ? `0 0 0 3px ${COLORS.accentLight}` : 'none' }}>
                <div style={{ fontFamily: 'monospace', fontSize: '16px', fontWeight: '600', color: isFinal ? COLORS.gold : COLORS.textPrimary }}>{formatCurrency(amount)}</div>
                {showLabels && <div style={{ fontSize: '11px', color: COLORS.textSecondary, textAlign: 'center', marginTop: '2px' }}>{isFinal ? 'Coupon + Face' : 'Coupon'}</div>}
              </div>
              <div style={{ width: '2px', height: '15px', background: isFinal ? COLORS.goldBorder : COLORS.borderDark }} />
              <div style={{ width: '14px', height: '14px', borderRadius: '50%', background: isFinal ? COLORS.gold : COLORS.textSecondary, position: 'absolute', bottom: '18px' }} />
              <span style={{ position: 'absolute', bottom: '-5px', fontSize: '13px', color: COLORS.textSecondary, fontWeight: '500' }}>Time {index + 1}</span>
            </div>
          );
        })}
      </div>
      <div style={{ display: 'flex', justifyContent: 'center', gap: '24px', marginTop: '16px', paddingTop: '12px', borderTop: `1px solid ${COLORS.border}` }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '13px', color: COLORS.textSecondary }}>
          <div style={{ width: '12px', height: '12px', background: 'white', border: `2px solid ${COLORS.border}`, borderRadius: '4px' }} />
          Coupon Payment
        </div>
        <div style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '13px', color: COLORS.textSecondary }}>
          <div style={{ width: '12px', height: '12px', background: COLORS.goldLight, border: `2px solid ${COLORS.goldBorder}`, borderRadius: '4px' }} />
          Final Payment
        </div>
      </div>
    </div>
  );
};

// SpreadsheetBuilder Component
const SpreadsheetBuilder = ({ cashFlows = [6, 6, 106], interestRate = 0.06, revealedPVs = [], highlightRow = null, showTotal = true, totalRevealed = false }) => {
  const rows = cashFlows.map((cf, index) => {
    const period = index + 1;
    const discountFactor = 1 / Math.pow(1 + interestRate, period);
    const pv = cf * discountFactor;
    return { period, cashFlow: cf, discountFactor, pv };
  });
  const total = rows.reduce((sum, row) => sum + row.pv, 0);
  const formatDiscountFactor = (period) => {
    const ratePercent = Math.round(interestRate * 100);
    if (period === 1) return `1/1.${ratePercent.toString().padStart(2, '0')}`;
    return `1/1.${ratePercent.toString().padStart(2, '0')}${period === 2 ? '\u00B2' : '\u00B3'}`;
  };
  return (
    <div style={{ background: 'white', border: `1px solid ${COLORS.border}`, borderRadius: '12px', overflow: 'hidden', marginTop: '16px', marginBottom: '16px', fontFamily: 'monospace', fontSize: '14px' }}>
      <div style={{ display: 'grid', gridTemplateColumns: '70px 100px 130px 110px', background: COLORS.surfaceAlt, borderBottom: `2px solid ${COLORS.border}`, fontWeight: '600', fontSize: '13px' }}>
        <div style={{ padding: '12px 8px', borderRight: `1px solid ${COLORS.border}`, textAlign: 'center' }}>Period</div>
        <div style={{ padding: '12px 8px', borderRight: `1px solid ${COLORS.border}`, textAlign: 'center' }}>Cash Flow</div>
        <div style={{ padding: '12px 8px', borderRight: `1px solid ${COLORS.border}`, textAlign: 'center' }}>Discount Factor</div>
        <div style={{ padding: '12px 8px', textAlign: 'center' }}>Present Value</div>
      </div>
      {rows.map((row, index) => {
        const isHighlighted = highlightRow === index;
        const isRevealed = revealedPVs.includes(index);
        const isFinal = index === rows.length - 1;
        return (
          <div key={index} style={{ display: 'grid', gridTemplateColumns: '70px 100px 130px 110px', borderBottom: `1px solid ${COLORS.border}`, background: isHighlighted ? COLORS.accentLight : 'white', transition: 'background 0.2s ease' }}>
            <div style={{ padding: '14px 8px', borderRight: `1px solid ${COLORS.border}`, textAlign: 'center', color: COLORS.textPrimary }}>{row.period}</div>
            <div style={{ padding: '14px 8px', borderRight: `1px solid ${COLORS.border}`, textAlign: 'right', color: isFinal ? COLORS.gold : COLORS.textPrimary, fontWeight: isFinal ? '600' : '400' }}>{formatCurrency(row.cashFlow)}</div>
            <div style={{ padding: '14px 8px', borderRight: `1px solid ${COLORS.border}`, textAlign: 'center', color: COLORS.textSecondary, fontSize: '13px' }}>{formatDiscountFactor(row.period)}</div>
            <div style={{ padding: '14px 8px', textAlign: 'right', color: isRevealed ? COLORS.success : COLORS.textMuted, fontWeight: isRevealed ? '600' : '400' }}>{isRevealed ? formatCurrency(row.pv) : '?'}</div>
          </div>
        );
      })}
      {showTotal && (
        <div style={{ display: 'grid', gridTemplateColumns: '70px 100px 130px 110px', background: totalRevealed ? COLORS.goldLight : COLORS.surfaceAlt, fontWeight: '600', transition: 'background 0.3s ease' }}>
          <div style={{ padding: '14px 8px', borderRight: `1px solid ${COLORS.border}`, color: COLORS.textPrimary }}>Total</div>
          <div style={{ padding: '14px 8px', borderRight: `1px solid ${COLORS.border}` }}></div>
          <div style={{ padding: '14px 8px', borderRight: `1px solid ${COLORS.border}` }}></div>
          <div style={{ padding: '14px 8px', textAlign: 'right', color: totalRevealed ? COLORS.gold : COLORS.textMuted }}>{totalRevealed ? formatCurrency(total) : '?'}</div>
        </div>
      )}
    </div>
  );
};

// RabbitHoleButton Component
const RabbitHoleButton = ({ rabbitHole, explored, onClick, soundEnabled }) => {
  const handleClick = () => { if (soundEnabled) playSound('rabbitHole'); onClick(); };
  return (
    <button onClick={handleClick} style={{ display: 'flex', alignItems: 'center', gap: '10px', width: '100%', padding: '14px 16px', border: `2px dashed ${COLORS.rabbitHoleBorder}`, borderRadius: '10px', background: explored ? COLORS.rabbitHoleLight : 'white', color: COLORS.rabbitHole, cursor: 'pointer', fontSize: '14px', textAlign: 'left', marginTop: '16px', transition: 'all 0.2s ease' }}>
      <LucideIcon name="Rabbit" size={20} style={{ flexShrink: 0 }} />
      <span style={{ flex: 1 }}>{rabbitHole.title}</span>
      {explored && <LucideIcon name="Check" size={18} />}
    </button>
  );
};

// RabbitHoleModal Component
const RabbitHoleModal = ({ rabbitHole, onClose }) => {
  if (!rabbitHole) return null;
  return (
    <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px', zIndex: 1000 }}>
      <div style={{ background: 'white', borderRadius: '16px', maxWidth: '600px', maxHeight: '80vh', overflow: 'auto', boxShadow: '0 20px 60px rgba(0,0,0,0.3)', width: '100%' }}>
        <div style={{ background: COLORS.rabbitHole, color: 'white', padding: '20px 24px', display: 'flex', alignItems: 'center', gap: '12px' }}>
          <LucideIcon name="Rabbit" size={24} />
          <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600' }}>{rabbitHole.title}</h2>
        </div>
        <div style={{ padding: '24px', fontSize: '15px', lineHeight: '1.7', color: COLORS.textPrimary }}>
          {rabbitHole.content.split('\n\n').map((paragraph, i) => (
            <p key={i} style={{ margin: i === 0 ? 0 : '16px 0 0 0' }}>{paragraph}</p>
          ))}
        </div>
        <div style={{ padding: '16px 24px', borderTop: `1px solid ${COLORS.border}`, display: 'flex', justifyContent: 'flex-end' }}>
          <button onClick={onClose} style={{ padding: '10px 24px', border: 'none', borderRadius: '8px', background: COLORS.rabbitHole, color: 'white', fontSize: '15px', fontWeight: '500', cursor: 'pointer' }}>Back to Tutorial</button>
        </div>
      </div>
    </div>
  );
};

// GlossaryModal Component
const GlossaryModal = ({ onClose }) => (
  <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px', zIndex: 1000 }}>
    <div style={{ background: 'white', borderRadius: '16px', maxWidth: '600px', maxHeight: '80vh', overflow: 'auto', boxShadow: '0 20px 60px rgba(0,0,0,0.3)', width: '100%' }}>
      <div style={{ background: COLORS.primary, color: 'white', padding: '20px 24px', display: 'flex', alignItems: 'center', gap: '12px' }}>
        <LucideIcon name="BookOpen" size={24} />
        <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600' }}>Glossary</h2>
      </div>
      <div style={{ padding: '16px 24px' }}>
        {Object.values(GLOSSARY).map((item, i) => (
          <div key={item.term} style={{ padding: '16px 0', borderBottom: i < Object.values(GLOSSARY).length - 1 ? `1px solid ${COLORS.border}` : 'none' }}>
            <h3 style={{ margin: '0 0 6px 0', fontSize: '16px', fontWeight: '600', color: COLORS.primary }}>{item.term}</h3>
            <p style={{ margin: 0, fontSize: '14px', lineHeight: '1.5', color: COLORS.textSecondary }}>{item.definition}</p>
          </div>
        ))}
      </div>
      <div style={{ padding: '16px 24px', borderTop: `1px solid ${COLORS.border}`, display: 'flex', justifyContent: 'flex-end' }}>
        <button onClick={onClose} style={{ padding: '10px 24px', border: 'none', borderRadius: '8px', background: COLORS.primary, color: 'white', fontSize: '15px', fontWeight: '500', cursor: 'pointer' }}>Close</button>
      </div>
    </div>
  </div>
);

// RestartConfirmModal Component
const RestartConfirmModal = ({ onConfirm, onCancel }) => (
  <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '20px', zIndex: 1000 }}>
    <div style={{ background: 'white', borderRadius: '16px', maxWidth: '400px', boxShadow: '0 20px 60px rgba(0,0,0,0.3)', width: '100%', overflow: 'hidden' }}>
      <div style={{ background: COLORS.warning, color: 'white', padding: '20px 24px', display: 'flex', alignItems: 'center', gap: '12px' }}>
        <LucideIcon name="AlertCircle" size={24} />
        <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600' }}>Restart Tutorial?</h2>
      </div>
      <div style={{ padding: '24px' }}>
        <p style={{ margin: 0, fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary }}>Are you sure you want to restart? All progress will be lost, including calculations and explored rabbit holes.</p>
      </div>
      <div style={{ padding: '16px 24px', borderTop: `1px solid ${COLORS.border}`, display: 'flex', justifyContent: 'flex-end', gap: '12px' }}>
        <button onClick={onCancel} style={{ padding: '10px 20px', border: `1px solid ${COLORS.border}`, borderRadius: '8px', background: 'white', color: COLORS.textPrimary, fontSize: '15px', cursor: 'pointer' }}>Cancel</button>
        <button onClick={onConfirm} style={{ padding: '10px 20px', border: 'none', borderRadius: '8px', background: COLORS.warning, color: 'white', fontSize: '15px', fontWeight: '500', cursor: 'pointer' }}>Restart</button>
      </div>
    </div>
  </div>
);

// DevModePanel Component
const DevModePanel = ({ onJumpToPart, currentPartIndex, onClose }) => (
  <div style={{ position: 'fixed', bottom: '20px', right: '20px', background: 'white', border: `2px solid ${COLORS.warning}`, borderRadius: '12px', padding: '16px', boxShadow: '0 10px 40px rgba(0,0,0,0.15)', zIndex: 999, maxHeight: '400px', overflow: 'auto' }}>
    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
      <h3 style={{ margin: 0, fontSize: '14px', color: COLORS.warning, fontWeight: '600' }}>Dev Mode</h3>
      <button onClick={onClose} style={{ background: 'none', border: 'none', cursor: 'pointer', color: COLORS.textMuted, padding: '4px' }}>
        <LucideIcon name="X" size={18} />
      </button>
    </div>
    <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
      {PARTS.map((part, index) => (
        <button key={part.id} onClick={() => onJumpToPart(index)} style={{ padding: '8px 12px', border: `1px solid ${index === currentPartIndex ? COLORS.warning : COLORS.border}`, borderRadius: '6px', background: index === currentPartIndex ? COLORS.warningBg : 'white', color: COLORS.textPrimary, fontSize: '13px', textAlign: 'left', cursor: 'pointer' }}>
          {index + 1}. {part.title}
        </button>
      ))}
    </div>
  </div>
);

// MAIN TUTORIAL COMPONENT
const Tutorial02D = () => {
  const [currentPartIndex, setCurrentPartIndex] = React.useState(0);
  const [currentStep, setCurrentStep] = React.useState(0);
  const [soundEnabled, setSoundEnabled] = React.useState(true);
  const [showGlossary, setShowGlossary] = React.useState(false);
  const [showRestartConfirm, setShowRestartConfirm] = React.useState(false);
  const [activeRabbitHole, setActiveRabbitHole] = React.useState(null);
  const [exploredRabbitHoles, setExploredRabbitHoles] = React.useState([]);
  const [completedSteps, setCompletedSteps] = React.useState({});
  const [userChoices, setUserChoices] = React.useState({});
  const [calculations, setCalculations] = React.useState({});
  const [revealedPVs, setRevealedPVs] = React.useState([]);
  const [totalRevealed, setTotalRevealed] = React.useState(false);
  const [devMode, setDevMode] = React.useState(false);
  const [headerClickCount, setHeaderClickCount] = React.useState(0);
  const [lastClickTime, setLastClickTime] = React.useState(0);

  React.useEffect(() => {
    if (soundEnabled && currentPartIndex === 5 && currentStep === 2) {
      playSound('celebration');
    }
  }, [currentPartIndex, currentStep, soundEnabled]);

  const markStepComplete = React.useCallback((stepKey) => {
    setCompletedSteps(prev => ({ ...prev, [stepKey]: true }));
  }, []);

  const handleContinue = React.useCallback(() => {
    const currentPart = PARTS[currentPartIndex];
    if (currentStep < currentPart.steps - 1) { setCurrentStep(prev => prev + 1); }
    else if (currentPartIndex < PARTS.length - 1) { setCurrentPartIndex(prev => prev + 1); setCurrentStep(0); }
    if (soundEnabled) playSound('click');
  }, [currentPartIndex, currentStep, soundEnabled]);

  const handleBack = React.useCallback(() => {
    if (currentStep > 0) { setCurrentStep(prev => prev - 1); }
    else if (currentPartIndex > 0) {
      const prevPartIndex = currentPartIndex - 1;
      setCurrentPartIndex(prevPartIndex);
      setCurrentStep(PARTS[prevPartIndex].steps - 1);
    }
    if (soundEnabled) playSound('click');
  }, [currentPartIndex, currentStep, soundEnabled]);

  const handleRestart = React.useCallback(() => {
    setCurrentPartIndex(0); setCurrentStep(0); setExploredRabbitHoles([]); setCompletedSteps({});
    setUserChoices({}); setCalculations({}); setRevealedPVs([]); setTotalRevealed(false); setShowRestartConfirm(false);
  }, []);

  const handleRabbitHoleClick = React.useCallback((rabbitHoleId) => {
    setActiveRabbitHole(RABBIT_HOLES[rabbitHoleId]);
    if (!exploredRabbitHoles.includes(rabbitHoleId)) {
      setExploredRabbitHoles(prev => [...prev, rabbitHoleId]);
    }
  }, [exploredRabbitHoles]);

  const handleHeaderClick = React.useCallback(() => {
    const now = Date.now();
    if (now - lastClickTime < 500) {
      const newCount = headerClickCount + 1;
      setHeaderClickCount(newCount);
      if (newCount >= 3) { setDevMode(prev => !prev); setHeaderClickCount(0); }
    } else { setHeaderClickCount(1); }
    setLastClickTime(now);
  }, [headerClickCount, lastClickTime]);

  const handleJumpToPart = React.useCallback((partIndex) => {
    setCurrentPartIndex(partIndex); setCurrentStep(0);
  }, []);

  const currentPart = PARTS[currentPartIndex];
  const canGoBack = currentPartIndex > 0 || currentStep > 0;
  const totalRabbitHoles = Object.keys(RABBIT_HOLES).length;

  const canContinue = (() => {
    if (currentPartIndex === 1 && currentStep === 2) return completedSteps['part1_couponVsInterest'] === true;
    if (currentPartIndex === 3 && currentStep === 2) return completedSteps['pv1'] === true;
    if (currentPartIndex === 3 && currentStep === 3) return completedSteps['pv2'] === true && completedSteps['pv3'] === true;
    if (currentPartIndex === 3 && currentStep === 4) return completedSteps['pvTotal'] === true;
    return true;
  })();

  // Part renderers
  const renderPart0 = () => {
    if (currentStep === 0) {
      return (
        <div>
          <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>The Puzzle Revisited</h2>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>At the end of the last tutorial, we asked a puzzling question:</p>
          <div style={{ background: COLORS.goldLight, border: `2px solid ${COLORS.goldBorder}`, borderRadius: '12px', padding: '20px', margin: '20px 0', fontSize: '18px', fontStyle: 'italic', color: COLORS.textPrimary, textAlign: 'center' }}>"A bond promises to pay you exactly $100 at maturity. Why would anyone ever pay MORE than $100 for it?"</div>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>This seems irrational. If you're going to get $100 back, why pay $105? Or $110?</p>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '16px' }}>Let's figure this out.</p>
        </div>
      );
    } else {
      return (
        <div>
          <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>The Key to the Answer</h2>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>The answer lies in understanding what a bond <em>actually</em> promises.</p>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '16px' }}>If a bond sells for more than its face value, it must be giving you something more than just the face value at maturity. Coupon bonds do exactly that.</p>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '16px', fontWeight: '500' }}>Let's look at the complete picture.</p>
        </div>
      );
    }
  };

  const renderPart1 = () => {
    if (currentStep === 0) {
      return (
        <div>
          <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>What Is a Bond?</h2>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>A bond is a promise to make specific future cash payments. There are different types:</p>
          <ul style={{ fontSize: '16px', lineHeight: '1.8', color: COLORS.textPrimary, marginTop: '16px', paddingLeft: '24px' }}>
            <li><strong>Coupon bonds</strong> pay periodic interest plus face value at maturity</li>
            <li><strong>Zero-coupon bonds</strong> pay only the face value at maturity</li>
            <li><strong>Perpetuities</strong> pay interest forever, with no maturity</li>
          </ul>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '20px' }}>We'll focus on <strong>coupon bonds</strong> — the most common type and the one that reveals the key insight about how coupon rates and interest rates interact.</p>
          <div style={{ background: COLORS.surfaceAlt, borderRadius: '12px', padding: '20px', marginTop: '24px' }}>
            <p style={{ margin: 0, fontSize: '15px', color: COLORS.textSecondary }}><strong>A coupon bond</strong> promises TWO things:</p>
            <ol style={{ margin: '12px 0 0 0', paddingLeft: '24px', color: COLORS.textPrimary, lineHeight: '1.8' }}>
              <li>Periodic <strong>coupon payments</strong> — like an annuity</li>
              <li>The <strong>face value</strong> at maturity — a single payment at the end</li>
            </ol>
            <p style={{ margin: '12px 0 0 0', fontSize: '15px', color: COLORS.textSecondary, fontStyle: 'italic' }}>Think of it as: an annuity PLUS a balloon payment.</p>
          </div>
        </div>
      );
    }
    if (currentStep === 1) {
      return (
        <div>
          <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>A Coupon Bond Has Three Key Features</h2>
          <div style={{ background: COLORS.surfaceAlt, borderRadius: '12px', padding: '24px', marginBottom: '24px' }}>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
              <div style={{ display: 'flex', alignItems: 'baseline', gap: '12px' }}>
                <span style={{ background: COLORS.primary, color: 'white', borderRadius: '50%', width: '28px', height: '28px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px', fontWeight: '600', flexShrink: 0 }}>1</span>
                <div><strong style={{ color: COLORS.textPrimary }}>Face Value:</strong><span style={{ color: COLORS.textPrimary, marginLeft: '8px' }}>$100</span><p style={{ margin: '4px 0 0 0', fontSize: '14px', color: COLORS.textSecondary }}>The amount paid at maturity; also the base for calculating coupon payments</p></div>
              </div>
              <div style={{ display: 'flex', alignItems: 'baseline', gap: '12px' }}>
                <span style={{ background: COLORS.primary, color: 'white', borderRadius: '50%', width: '28px', height: '28px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px', fontWeight: '600', flexShrink: 0 }}>2</span>
                <div><strong style={{ color: COLORS.textPrimary }}>Maturity:</strong><span style={{ color: COLORS.textPrimary, marginLeft: '8px' }}>3 periods</span><p style={{ margin: '4px 0 0 0', fontSize: '14px', color: COLORS.textSecondary }}>When the bond expires and face value is returned</p></div>
              </div>
              <div style={{ display: 'flex', alignItems: 'baseline', gap: '12px' }}>
                <span style={{ background: COLORS.primary, color: 'white', borderRadius: '50%', width: '28px', height: '28px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px', fontWeight: '600', flexShrink: 0 }}>3</span>
                <div><strong style={{ color: COLORS.textPrimary }}>Coupon Rate:</strong><span style={{ color: COLORS.textPrimary, marginLeft: '8px' }}>6% per period</span><p style={{ margin: '4px 0 0 0', fontSize: '14px', color: COLORS.textSecondary }}>Determines the size of each coupon payment</p></div>
              </div>
            </div>
          </div>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>From these three features, we can figure out exactly what cash flows the bond promises:</p>
          <div style={{ background: 'white', border: `1px solid ${COLORS.border}`, borderRadius: '8px', padding: '16px', marginTop: '16px', fontFamily: 'monospace' }}>
            <p style={{ margin: '0 0 8px 0', color: COLORS.textSecondary, fontSize: '14px' }}>Coupon Payment = Face Value x Coupon Rate</p>
            <p style={{ margin: 0, color: COLORS.textPrimary, fontSize: '16px' }}>$100 x 6% = <strong>$6 per period</strong></p>
          </div>
        </div>
      );
    }
    if (currentStep === 2) {
      const choiceKey = 'part1_couponVsInterest';
      const isAnswered = completedSteps[choiceKey];
      const selectedChoice = userChoices[choiceKey];
      return (
        <div>
          <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>The Critical Distinction</h2>
          <div style={{ background: COLORS.warningBg, border: `2px solid ${COLORS.warningBorder}`, borderRadius: '12px', padding: '16px', marginBottom: '20px' }}>
            <p style={{ margin: 0, fontSize: '16px', color: COLORS.textPrimary, fontWeight: '500' }}>Pay close attention - this is where people get confused.</p>
          </div>
          <p style={{ fontSize: '18px', lineHeight: '1.7', color: COLORS.textPrimary, fontWeight: '600', marginBottom: '20px' }}>The <span style={{ color: COLORS.accent }}>Coupon Rate</span> and the <span style={{ color: COLORS.gold }}>Interest Rate</span> are NOT the same thing.</p>
          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '24px' }}>
            <div style={{ background: COLORS.accentLight, border: `2px solid ${COLORS.accent}`, borderRadius: '12px', padding: '16px' }}>
              <h4 style={{ margin: '0 0 12px 0', color: COLORS.accent }}>Coupon Rate</h4>
              <ul style={{ margin: 0, paddingLeft: '18px', fontSize: '14px', lineHeight: '1.8', color: COLORS.textPrimary }}>
                <li>Stated on the bond</li><li>Fixed when bond is issued</li><li>Determines payment <strong>SIZE</strong></li><li>"What you're promised"</li>
              </ul>
            </div>
            <div style={{ background: COLORS.goldLight, border: `2px solid ${COLORS.goldBorder}`, borderRadius: '12px', padding: '16px' }}>
              <h4 style={{ margin: '0 0 12px 0', color: COLORS.gold }}>Interest Rate</h4>
              <ul style={{ margin: 0, paddingLeft: '18px', fontSize: '14px', lineHeight: '1.8', color: COLORS.textPrimary }}>
                <li>Determined by the market</li><li>Changes every day</li><li>Determines payment <strong>VALUE</strong></li><li>"What that promise is worth"</li>
              </ul>
            </div>
          </div>
          <div style={{ background: COLORS.surfaceAlt, borderRadius: '8px', padding: '16px', marginBottom: '24px', borderLeft: `4px solid ${COLORS.primary}` }}>
            <p style={{ margin: 0, fontSize: '15px', color: COLORS.textPrimary, fontStyle: 'italic' }}>"The coupon rate is just language describing the cash flows you're promised. The interest rate determines the economics of what those promises are worth."</p>
          </div>
          <p style={{ fontSize: '16px', color: COLORS.textPrimary, marginBottom: '16px', fontWeight: '500' }}>If the coupon rate determines the cash flows, and the interest rate determines value, what happens when these two rates are different?</p>
          <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
            <ChoiceButton label="The bond sells for exactly its face value" selected={selectedChoice === 'A'} correct={false} submitted={isAnswered} onClick={() => { if (!isAnswered) setUserChoices(prev => ({ ...prev, [choiceKey]: 'A' })); }} />
            <ChoiceButton label="The bond sells for more or less than face value" selected={selectedChoice === 'B'} correct={true} submitted={isAnswered} onClick={() => { if (!isAnswered) setUserChoices(prev => ({ ...prev, [choiceKey]: 'B' })); }} />
            <ChoiceButton label="The bond defaults" selected={selectedChoice === 'C'} correct={false} submitted={isAnswered} onClick={() => { if (!isAnswered) setUserChoices(prev => ({ ...prev, [choiceKey]: 'C' })); }} />
          </div>
          {selectedChoice && !isAnswered && (
            <button onClick={() => { markStepComplete(choiceKey); if (soundEnabled) playSound(selectedChoice === 'B' ? 'success' : 'softNope'); }} style={{ marginTop: '16px', padding: '12px 24px', background: COLORS.primary, color: 'white', border: 'none', borderRadius: '8px', fontSize: '15px', fontWeight: '500', cursor: 'pointer' }}>Check Answer</button>
          )}
          {isAnswered && (
            <div style={{ marginTop: '16px', padding: '16px', background: selectedChoice === 'B' ? COLORS.successBg : COLORS.warningBg, borderRadius: '8px' }}>
              <p style={{ margin: 0, color: COLORS.textPrimary, fontSize: '15px' }}>{selectedChoice === 'B' ? "Exactly! When coupon rate and interest rate differ, the bond's price adjusts. We'll see exactly how this works." : "Not quite. The bond doesn't default just because rates differ — instead, its price adjusts to reflect the difference. Let's see how."}</p>
            </div>
          )}
        </div>
      );
    }
    return (
      <div>
        <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>The Promised Cash Flows</h2>
        <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>Let's be crystal clear about what this bond promises:</p>
        <BondCashFlowDiagram cashFlows={[6, 6, 106]} />
        <div style={{ background: COLORS.surfaceAlt, borderRadius: '12px', padding: '20px', marginTop: '8px' }}>
          <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', fontFamily: 'monospace' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', color: COLORS.textPrimary }}><span>Time 1:</span><span><strong>$6</strong> (coupon payment)</span></div>
            <div style={{ display: 'flex', justifyContent: 'space-between', color: COLORS.textPrimary }}><span>Time 2:</span><span><strong>$6</strong> (coupon payment)</span></div>
            <div style={{ display: 'flex', justifyContent: 'space-between', color: COLORS.gold, fontWeight: '600' }}><span>Time 3:</span><span><strong>$106</strong> (coupon + face value)</span></div>
          </div>
        </div>
        <InsightBox>
          <p style={{ margin: 0 }}><strong>These cash flows are FIXED.</strong> They don't change — they're written into the bond contract.</p>
          <p style={{ margin: '12px 0 0 0' }}>What CAN change is what these cash flows are <strong>worth</strong> — and that depends on the market interest rate.</p>
        </InsightBox>
        <RabbitHoleButton rabbitHole={RABBIT_HOLES.irvingFisher} explored={exploredRabbitHoles.includes('irvingFisher')} onClick={() => handleRabbitHoleClick('irvingFisher')} soundEnabled={soundEnabled} />
        <RabbitHoleButton rabbitHole={RABBIT_HOLES.fieldTrip} explored={exploredRabbitHoles.includes('fieldTrip')} onClick={() => handleRabbitHoleClick('fieldTrip')} soundEnabled={soundEnabled} />
      </div>
    );
  };

  const renderPart2 = () => {
    if (currentStep === 0) {
      return (
        <div>
          <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>The Simple Case First</h2>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>Let's start with the simplest scenario:</p>
          <div style={{ background: COLORS.surfaceAlt, borderRadius: '12px', padding: '20px', margin: '20px 0' }}>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}><span style={{ color: COLORS.textSecondary }}>Our bond:</span><span style={{ color: COLORS.textPrimary, fontWeight: '500' }}>$100 face, 6% coupon, 3 periods</span></div>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', paddingTop: '12px', borderTop: `1px solid ${COLORS.border}` }}><span style={{ color: COLORS.textSecondary }}>Market interest rate:</span><span style={{ color: COLORS.gold, fontWeight: '600', fontSize: '18px' }}>also 6% per period</span></div>
            </div>
          </div>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>When the coupon rate equals the market interest rate, something elegant happens.</p>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '16px', fontWeight: '500' }}>Let's calculate what this bond is worth.</p>
          <BondCashFlowDiagram cashFlows={[6, 6, 106]} />
        </div>
      );
    }
    if (currentStep === 1) {
      return (
        <div>
          <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>The Calculation</h2>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>To find the bond's value, we discount each cash flow back to today:</p>
          <div style={{ background: COLORS.surfaceAlt, borderRadius: '12px', padding: '24px', margin: '20px 0', fontFamily: 'monospace', fontSize: '16px', textAlign: 'center' }}>
            <p style={{ margin: 0, color: COLORS.textPrimary }}>PV = <span style={{ color: COLORS.accent }}>$6/(1.06)</span> + <span style={{ color: COLORS.accent }}>$6/(1.06)^2</span> + <span style={{ color: COLORS.gold }}>$106/(1.06)^3</span></p>
          </div>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>This is exactly what we learned in the last tutorial — discount each payment back to Time 0, then add them up.</p>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '16px', fontWeight: '500' }}>We'll build this calculation step by step in a spreadsheet.</p>
        </div>
      );
    }
    return (
      <div>
        <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>A Sneak Peek at the Answer</h2>
        <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>Before we do the calculations, let's think about what we expect to find.</p>
        <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '16px' }}>If you invest $100 at 6% per period, you'd earn $6 per period in interest.</p>
        <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '16px' }}>This bond pays exactly $6 per period.</p>
        <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '16px' }}>So the bond should be worth exactly $100.</p>
        <InsightBox>
          <p style={{ margin: 0 }}><strong>When coupon rate = interest rate -> Bond price = Face value</strong></p>
          <p style={{ margin: '12px 0 0 0' }}>This is called trading <strong>"at par."</strong></p>
        </InsightBox>
        <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '16px' }}>Now let's verify this by building the calculation.</p>
      </div>
    );
  };

  const renderPart3 = () => {
    if (currentStep === 0) {
      return (
        <div>
          <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>Why Build It Step-by-Step?</h2>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>We're going to build a bond pricing calculation the way you'd do it in a spreadsheet — but without using any built-in functions.</p>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '16px', fontWeight: '500' }}>Why no shortcuts?</p>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '16px' }}>Because we want to <strong>see</strong> every step. We want to understand <strong>where</strong> the answer comes from, not just <strong>what</strong> it is.</p>
          <InsightBox icon={<LucideIcon name="DollarSign" size={24} color={COLORS.gold} />}><strong>The spreadsheet won't hide the math — it will make it visible.</strong></InsightBox>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '16px' }}>Once you understand the mechanics, you can use shortcuts. But first, let's see how it really works.</p>
        </div>
      );
    }
    if (currentStep === 1) {
      return (
        <div>
          <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>The Spreadsheet Structure</h2>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>Here's how we'll organize our calculation:</p>
          <SpreadsheetBuilder cashFlows={[6, 6, 106]} interestRate={0.06} revealedPVs={[]} highlightRow={null} showTotal={true} totalRevealed={false} />
          <div style={{ background: COLORS.surfaceAlt, borderRadius: '8px', padding: '16px', marginTop: '16px' }}>
            <p style={{ margin: 0, fontSize: '15px', color: COLORS.textPrimary }}><strong>Each row is one cash flow:</strong></p>
            <ul style={{ margin: '8px 0 0 0', paddingLeft: '20px', color: COLORS.textSecondary, fontSize: '14px', lineHeight: '1.8' }}>
              <li><strong>Period:</strong> When the cash flow arrives</li>
              <li><strong>Cash Flow:</strong> The amount promised</li>
              <li><strong>Discount Factor:</strong> Converts future dollars to present dollars</li>
              <li><strong>Present Value:</strong> Cash Flow x Discount Factor</li>
            </ul>
          </div>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '20px' }}>Now let's fill in the present values, one at a time.</p>
        </div>
      );
    }
    if (currentStep === 2) {
      const calcKey = 'pv1';
      const isComplete = completedSteps[calcKey];
      return (
        <div>
          <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>Calculate the First Present Value</h2>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>Let's calculate the present value of the first coupon payment.</p>
          <SpreadsheetBuilder cashFlows={[6, 6, 106]} interestRate={0.06} revealedPVs={revealedPVs} highlightRow={0} showTotal={true} totalRevealed={false} />
          <div style={{ background: COLORS.surfaceAlt, borderRadius: '8px', padding: '16px', marginTop: '16px', fontFamily: 'monospace' }}>
            <p style={{ margin: 0, color: COLORS.textSecondary, fontSize: '14px' }}>Present Value = Cash Flow / (1 + r)^1</p>
            <p style={{ margin: '8px 0 0 0', color: COLORS.textPrimary, fontSize: '16px' }}>Present Value = $6.00 / 1.06 = ?</p>
          </div>
          <CalculationBox key="calc-pv1" prompt="$6.00 / 1.06 = ?" correctAnswer={5.66} hint1="Divide 6 by 1.06" hint2="6 / 1.06 = 5.6604, round to $5.66" onCorrect={() => { markStepComplete(calcKey); setRevealedPVs(prev => [...prev, 0]); }} soundEnabled={soundEnabled} disabled={isComplete} />
          {isComplete && <div style={{ marginTop: '16px', padding: '12px 16px', background: COLORS.successBg, borderRadius: '8px', color: COLORS.success, fontSize: '15px' }}>First present value: <strong>$5.66</strong></div>}
        </div>
      );
    }
    if (currentStep === 3) {
      const calc2Key = 'pv2';
      const calc3Key = 'pv3';
      const isCalc2Complete = completedSteps[calc2Key];
      const isCalc3Complete = completedSteps[calc3Key];
      return (
        <div>
          <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>Complete the Table</h2>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>Now let's calculate the present values for the remaining cash flows.</p>
          <SpreadsheetBuilder cashFlows={[6, 6, 106]} interestRate={0.06} revealedPVs={revealedPVs} highlightRow={!isCalc2Complete ? 1 : (!isCalc3Complete ? 2 : null)} showTotal={true} totalRevealed={false} />
          <div style={{ marginTop: '20px' }}>
            <p style={{ fontSize: '15px', color: COLORS.textPrimary, fontWeight: '500', marginBottom: '8px' }}>Second coupon payment (Time 2):</p>
            <CalculationBox key="calc-pv2" prompt="$6.00 / 1.06^2 = $6.00 / 1.1236 = ?" correctAnswer={5.34} hint1="Divide 6 by 1.1236" hint2="6 / 1.1236 = 5.34" onCorrect={() => { markStepComplete(calc2Key); setRevealedPVs(prev => [...prev, 1]); }} soundEnabled={soundEnabled} disabled={isCalc2Complete} />
          </div>
          {isCalc2Complete && (
            <div style={{ marginTop: '20px' }}>
              <p style={{ fontSize: '15px', color: COLORS.textPrimary, fontWeight: '500', marginBottom: '8px' }}>Final payment (Time 3):</p>
              <CalculationBox key="calc-pv3" prompt="$106.00 / 1.06^3 = $106.00 / 1.191 = ?" correctAnswer={89.00} hint1="Divide 106 by 1.191" hint2="106 / 1.191 = 89.00" tolerance={0.10} onCorrect={() => { markStepComplete(calc3Key); setRevealedPVs(prev => [...prev, 2]); }} soundEnabled={soundEnabled} disabled={isCalc3Complete} />
            </div>
          )}
          {isCalc2Complete && isCalc3Complete && <div style={{ marginTop: '20px', padding: '16px', background: COLORS.successBg, borderRadius: '8px' }}><p style={{ margin: 0, color: COLORS.success, fontSize: '15px' }}>All present values calculated! Now let's add them up.</p></div>}
        </div>
      );
    }
    const calcTotalKey = 'pvTotal';
    const isTotalComplete = completedSteps[calcTotalKey];
    return (
      <div>
        <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>The Total</h2>
        <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>Now add up all the present values to find what the bond is worth:</p>
        <SpreadsheetBuilder cashFlows={[6, 6, 106]} interestRate={0.06} revealedPVs={[0, 1, 2]} highlightRow={null} showTotal={true} totalRevealed={totalRevealed} />
        <div style={{ background: COLORS.surfaceAlt, borderRadius: '8px', padding: '16px', marginTop: '16px', fontFamily: 'monospace', textAlign: 'center' }}>
          <p style={{ margin: 0, color: COLORS.textPrimary, fontSize: '16px' }}>$5.66 + $5.34 + $89.00 = ?</p>
        </div>
        <CalculationBox key="calc-total" prompt="Total Present Value = ?" correctAnswer={100.00} hint1="Add the three present values together" hint2="5.66 + 5.34 + 89.00 = ?" onCorrect={() => { markStepComplete(calcTotalKey); setTotalRevealed(true); if (soundEnabled) playSound('insight'); }} soundEnabled={soundEnabled} disabled={isTotalComplete} />
        {isTotalComplete && (
          <>
            <InsightBox>
              <p style={{ margin: 0 }}><strong>The bond is worth exactly $100 — its face value!</strong></p>
              <p style={{ margin: '12px 0 0 0' }}>When the coupon rate equals the interest rate, the bond trades <strong>at par</strong>.</p>
            </InsightBox>
            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '16px' }}>But what happens when these rates are <em>different</em>? That's where things get interesting...</p>
            <RabbitHoleButton rabbitHole={RABBIT_HOLES.zeroCoupon} explored={exploredRabbitHoles.includes('zeroCoupon')} onClick={() => handleRabbitHoleClick('zeroCoupon')} soundEnabled={soundEnabled} />
          </>
        )}
      </div>
    );
  };

  const renderPart4 = () => {
    if (currentStep === 0) {
      return (
        <div>
          <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>A Different Scenario</h2>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>We've seen that when coupon rate equals interest rate, the bond trades at exactly $100.</p>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '16px' }}>But bonds are issued at different times, when rates were different. What if a bond has a <strong>6% coupon</strong>, but the current market interest rate is <strong>8%</strong>?</p>
          <div style={{ background: COLORS.surfaceAlt, borderRadius: '12px', padding: '20px', margin: '20px 0' }}>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}><span style={{ color: COLORS.textSecondary }}>Bond coupon rate:</span><span style={{ color: COLORS.accent, fontWeight: '600' }}>6% (unchanged)</span></div>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', paddingTop: '12px', borderTop: `1px solid ${COLORS.border}` }}><span style={{ color: COLORS.textSecondary }}>Market interest rate:</span><span style={{ color: COLORS.accent, fontWeight: '600', fontSize: '18px' }}>8% per period</span></div>
            </div>
          </div>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>The cash flows don't change — the bond still promises <strong>$6, $6, $106</strong>.</p>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '16px' }}>But the <em>value</em> of those cash flows changes because we discount at a different rate.</p>
          <BondCashFlowDiagram cashFlows={[6, 6, 106]} />
        </div>
      );
    }
    if (currentStep === 1) {
      return (
        <div>
          <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>Calculating at 8%</h2>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>Let's recalculate with an 8% interest rate:</p>
          <SpreadsheetBuilder cashFlows={[6, 6, 106]} interestRate={0.08} revealedPVs={[0, 1, 2]} showTotal={true} totalRevealed={true} />
          <div style={{ background: COLORS.surfaceAlt, borderRadius: '12px', padding: '20px', marginTop: '16px', fontFamily: 'monospace', fontSize: '14px' }}>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', color: COLORS.textPrimary }}><span>PV of $6 at Time 1:</span><span>$6.00 / 1.08 = <strong>$5.56</strong></span></div>
              <div style={{ display: 'flex', justifyContent: 'space-between', color: COLORS.textPrimary }}><span>PV of $6 at Time 2:</span><span>$6.00 / 1.08^2 = <strong>$5.14</strong></span></div>
              <div style={{ display: 'flex', justifyContent: 'space-between', color: COLORS.gold, fontWeight: '600' }}><span>PV of $106 at Time 3:</span><span>$106 / 1.08^3 = <strong>$84.15</strong></span></div>
              <div style={{ display: 'flex', justifyContent: 'space-between', color: COLORS.accent, fontWeight: '700', paddingTop: '12px', borderTop: `2px solid ${COLORS.border}`, fontSize: '16px' }}><span>Total:</span><span>$94.85</span></div>
            </div>
          </div>
        </div>
      );
    }
    return (
      <div>
        <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>The Discount Bond</h2>
        <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>At an 8% interest rate, the bond is worth only <strong style={{ color: COLORS.accent }}>$94.85</strong> — less than its $100 face value.</p>
        <InsightBox icon={<LucideIcon name="TrendingDown" size={24} color={COLORS.accent} />}>
          <p style={{ margin: 0 }}><strong>Why?</strong> The market now offers 8% returns, but this bond only pays a 6% coupon. To compensate buyers for this below-market coupon, the price must be lower.</p>
          <p style={{ margin: '12px 0 0 0' }}>This is called selling <strong>"at a discount."</strong></p>
        </InsightBox>
        <div style={{ background: COLORS.warningBg, border: `1px solid ${COLORS.warningBorder}`, borderRadius: '8px', padding: '16px', marginTop: '16px' }}>
          <p style={{ margin: 0, fontSize: '14px', color: COLORS.textPrimary }}><strong>Note on terminology:</strong> In bond language, "discount" simply means the price is below face value. It doesn't mean "bargain" — a discount bond isn't a better deal than other bonds. All bonds are priced to yield the market rate.</p>
        </div>
      </div>
    );
  };

  const renderPart5 = () => {
    if (currentStep === 0) {
      return (
        <div>
          <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>The Opposite Scenario</h2>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>Now consider the opposite: what if the market interest rate is only <strong>4%</strong>, but our bond pays a <strong>6% coupon</strong>?</p>
          <div style={{ background: COLORS.surfaceAlt, borderRadius: '12px', padding: '20px', margin: '20px 0' }}>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}><span style={{ color: COLORS.textSecondary }}>Bond coupon rate:</span><span style={{ color: COLORS.gold, fontWeight: '600' }}>6% (unchanged)</span></div>
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', paddingTop: '12px', borderTop: `1px solid ${COLORS.border}` }}><span style={{ color: COLORS.textSecondary }}>Market interest rate:</span><span style={{ color: COLORS.gold, fontWeight: '600', fontSize: '18px' }}>4% per period</span></div>
            </div>
          </div>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>Same cash flows: <strong>$6, $6, $106</strong>.</p>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '16px' }}>But now we discount at a <em>lower</em> rate.</p>
        </div>
      );
    }
    if (currentStep === 1) {
      return (
        <div>
          <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>Calculating at 4%</h2>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>Let's recalculate with a 4% interest rate:</p>
          <SpreadsheetBuilder cashFlows={[6, 6, 106]} interestRate={0.04} revealedPVs={[0, 1, 2]} showTotal={true} totalRevealed={true} />
          <div style={{ background: COLORS.surfaceAlt, borderRadius: '12px', padding: '20px', marginTop: '16px', fontFamily: 'monospace', fontSize: '14px' }}>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', color: COLORS.textPrimary }}><span>PV of $6 at Time 1:</span><span>$6.00 / 1.04 = <strong>$5.77</strong></span></div>
              <div style={{ display: 'flex', justifyContent: 'space-between', color: COLORS.textPrimary }}><span>PV of $6 at Time 2:</span><span>$6.00 / 1.04^2 = <strong>$5.55</strong></span></div>
              <div style={{ display: 'flex', justifyContent: 'space-between', color: COLORS.gold, fontWeight: '600' }}><span>PV of $106 at Time 3:</span><span>$106 / 1.04^3 = <strong>$94.23</strong></span></div>
              <div style={{ display: 'flex', justifyContent: 'space-between', color: COLORS.gold, fontWeight: '700', paddingTop: '12px', borderTop: `2px solid ${COLORS.border}`, fontSize: '16px' }}><span>Total:</span><span>$105.55</span></div>
            </div>
          </div>
        </div>
      );
    }
    return (
      <div>
        <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>The Premium Bond - The Answer!</h2>
        <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>At a 4% interest rate, the bond is worth <strong style={{ color: COLORS.gold }}>$105.55</strong> — MORE than its $100 face value!</p>
        <InsightBox celebration={true}>
          <p style={{ margin: 0, fontSize: '18px' }}><strong>This answers our opening puzzle!</strong></p>
          <p style={{ margin: '16px 0 0 0' }}><em>"Why would anyone pay more than $100 for a bond that pays $100 at maturity?"</em></p>
          <p style={{ margin: '16px 0 0 0' }}>Because this bond gives you more payments than just the face value at maturity. When those coupons are higher than what the market currently offers, that stream of above-market payments is valuable. Buyers will pay a premium for it.</p>
        </InsightBox>
        <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '20px' }}>This is called selling <strong>"at a premium."</strong></p>
        <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '16px' }}>The puzzle is solved. You pay more than $100 because you're not just buying the $100 at maturity — you're buying the entire stream of cash flows, including those generous 6% coupons in a 4% world.</p>
      </div>
    );
  };

  const renderPart6 = () => {
    if (currentStep === 0) {
      return (
        <div>
          <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>The Three Cases</h2>
          <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>We've discovered three possible relationships between coupon rate and interest rate:</p>
          <div style={{ background: COLORS.surfaceAlt, borderRadius: '12px', padding: '24px', marginTop: '20px' }}>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 100px', alignItems: 'center', padding: '12px 16px', background: COLORS.successBg, border: `2px solid ${COLORS.successBorder}`, borderRadius: '8px' }}>
                <div style={{ fontSize: '14px', color: COLORS.textPrimary }}>Interest rate <strong>= Coupon rate</strong> (6%)</div>
                <div style={{ fontSize: '14px', color: COLORS.textPrimary }}>Price <strong>= Face value</strong></div>
                <div style={{ fontSize: '13px', fontWeight: '600', color: COLORS.success, textAlign: 'right' }}>"At par"</div>
              </div>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 100px', alignItems: 'center', padding: '12px 16px', background: COLORS.accentLight, border: `2px solid ${COLORS.accent}`, borderRadius: '8px' }}>
                <div style={{ fontSize: '14px', color: COLORS.textPrimary }}>Interest rate <strong>&gt; Coupon rate</strong> (8%)</div>
                <div style={{ fontSize: '14px', color: COLORS.textPrimary }}>Price <strong>&lt; Face value</strong></div>
                <div style={{ fontSize: '13px', fontWeight: '600', color: COLORS.accent, textAlign: 'right' }}>"At discount"</div>
              </div>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 100px', alignItems: 'center', padding: '12px 16px', background: COLORS.goldLight, border: `2px solid ${COLORS.goldBorder}`, borderRadius: '8px' }}>
                <div style={{ fontSize: '14px', color: COLORS.textPrimary }}>Interest rate <strong>&lt; Coupon rate</strong> (4%)</div>
                <div style={{ fontSize: '14px', color: COLORS.textPrimary }}>Price <strong>&gt; Face value</strong></div>
                <div style={{ fontSize: '13px', fontWeight: '600', color: COLORS.gold, textAlign: 'right' }}>"At premium"</div>
              </div>
            </div>
          </div>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '16px', marginTop: '24px' }}>
            <div style={{ background: COLORS.goldLight, border: `2px solid ${COLORS.goldBorder}`, borderRadius: '12px', padding: '16px', textAlign: 'center' }}>
              <div style={{ fontSize: '14px', color: COLORS.textSecondary }}>4% Rate</div>
              <div style={{ fontSize: '20px', fontWeight: '700', color: COLORS.gold, margin: '8px 0' }}>$105.55</div>
              <div style={{ fontSize: '12px', fontWeight: '600', color: COLORS.gold }}>PREMIUM</div>
            </div>
            <div style={{ background: COLORS.successBg, border: `2px solid ${COLORS.successBorder}`, borderRadius: '12px', padding: '16px', textAlign: 'center' }}>
              <div style={{ fontSize: '14px', color: COLORS.textSecondary }}>6% Rate</div>
              <div style={{ fontSize: '20px', fontWeight: '700', color: COLORS.success, margin: '8px 0' }}>$100.00</div>
              <div style={{ fontSize: '12px', fontWeight: '600', color: COLORS.success }}>AT PAR</div>
            </div>
            <div style={{ background: COLORS.accentLight, border: `2px solid ${COLORS.accent}`, borderRadius: '12px', padding: '16px', textAlign: 'center' }}>
              <div style={{ fontSize: '14px', color: COLORS.textSecondary }}>8% Rate</div>
              <div style={{ fontSize: '20px', fontWeight: '700', color: COLORS.accent, margin: '8px 0' }}>$94.85</div>
              <div style={{ fontSize: '12px', fontWeight: '600', color: COLORS.accent }}>DISCOUNT</div>
            </div>
          </div>
        </div>
      );
    }
    return (
      <div>
        <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>The Key Insight</h2>
        <InsightBox>
          <p style={{ margin: 0, fontWeight: '600', fontSize: '17px' }}>A bond's price adjusts so that buyers earn the current market interest rate, regardless of what coupon rate is printed on the bond.</p>
        </InsightBox>
        <div style={{ background: COLORS.surfaceAlt, borderRadius: '12px', padding: '20px', marginTop: '20px' }}>
          <p style={{ margin: 0, fontSize: '15px', lineHeight: '1.7', color: COLORS.textPrimary }}><strong style={{ color: COLORS.gold }}>High coupon relative to market?</strong> Price goes UP to bring the yield back down to market rate.</p>
          <p style={{ margin: '16px 0 0 0', fontSize: '15px', lineHeight: '1.7', color: COLORS.textPrimary }}><strong style={{ color: COLORS.accent }}>Low coupon relative to market?</strong> Price goes DOWN to bring the yield back up to market rate.</p>
        </div>
        <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary, marginTop: '20px' }}>The market is efficient — you can't get a better deal by buying a "discount" bond or avoid overpaying by skipping "premium" bonds. They're all priced to deliver the same market return.</p>
        <div style={{ background: COLORS.surfaceAlt, borderRadius: '8px', padding: '16px', marginTop: '24px', borderLeft: `4px solid ${COLORS.primary}` }}>
          <p style={{ margin: 0, fontSize: '15px', color: COLORS.textPrimary, fontStyle: 'italic' }}>So far we've compared bonds at different fixed rates. But in the real world, interest rates change over time. What happens to a bond you already own when rates move? That's what we'll explore next.</p>
        </div>
      </div>
    );
  };

  const renderComplete = () => {
    return (
      <div style={{ textAlign: 'center' }}>
        <div style={{ fontSize: '48px', marginBottom: '16px' }}>Congratulations!</div>
        <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>Tutorial Complete!</h2>
        <div style={{ background: COLORS.surfaceAlt, borderRadius: '12px', padding: '24px', marginBottom: '24px', textAlign: 'left' }}>
          <h3 style={{ color: COLORS.textPrimary, marginBottom: '16px' }}>Bond Pricing</h3>
          <p style={{ color: COLORS.textSecondary, marginBottom: '16px' }}>You've learned:</p>
          <ul style={{ margin: 0, paddingLeft: '24px', color: COLORS.textPrimary, lineHeight: '2' }}>
            <li>Bond structure: coupon payments + face value at maturity</li>
            <li>Coupon rate determines cash flows; interest rate determines value</li>
            <li>At par: when coupon rate = interest rate</li>
            <li>At discount: when interest rate &gt; coupon rate</li>
            <li>At premium: when interest rate &lt; coupon rate</li>
            <li>Why someone would pay MORE than face value for a bond</li>
          </ul>
        </div>
        <div style={{ background: COLORS.rabbitHoleLight, borderRadius: '12px', padding: '20px', marginBottom: '24px' }}>
          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '12px' }}>
            <LucideIcon name="Rabbit" size={24} color={COLORS.rabbitHole} />
            <span style={{ color: COLORS.rabbitHole, fontWeight: '500' }}>You explored {exploredRabbitHoles.length} of {totalRabbitHoles} rabbit holes</span>
          </div>
          {exploredRabbitHoles.length < totalRabbitHoles && (
            <button onClick={() => { const unexplored = Object.keys(RABBIT_HOLES).filter(id => !exploredRabbitHoles.includes(id)); if (unexplored.length > 0) handleRabbitHoleClick(unexplored[0]); }} style={{ marginTop: '12px', padding: '8px 16px', border: `1px solid ${COLORS.rabbitHoleBorder}`, borderRadius: '6px', background: 'white', color: COLORS.rabbitHole, fontSize: '14px', cursor: 'pointer' }}>See what you missed</button>
          )}
        </div>
        <a href="Tutorial-D-RateChanges.html" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '12px', background: COLORS.primary, color: 'white', borderRadius: '8px', padding: '16px', textDecoration: 'none', fontWeight: '500', fontSize: '15px' }}>
          <span>Next: Tutorial D — Rate Changes</span>
          <LucideIcon name="ArrowRight" size={20} />
        </a>
        <button onClick={handleRestart} style={{ marginTop: '24px', padding: '10px 24px', border: `1px solid ${COLORS.border}`, borderRadius: '8px', background: 'white', color: COLORS.textPrimary, fontSize: '15px', cursor: 'pointer', display: 'inline-flex', alignItems: 'center', gap: '8px' }}>
          <LucideIcon name="RotateCcw" size={16} />
          Restart Tutorial
        </button>
      </div>
    );
  };

  const renderCurrentPart = () => {
    switch (currentPart.id) {
      case 'puzzleRevisited': return renderPart0();
      case 'bondAnatomy': return renderPart1();
      case 'couponEqualsInterest': return renderPart2();
      case 'buildingSpreadsheet': return renderPart3();
      case 'interestGreaterThanCoupon': return renderPart4();
      case 'interestLessThanCoupon': return renderPart5();
      case 'summary': return renderPart6();
      case 'complete': return renderComplete();
      default: return <div>Unknown part</div>;
    }
  };

  return (
    <div style={{ minHeight: '100vh', background: COLORS.background, fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif' }}>
      <Header currentPartIndex={currentPartIndex} currentStep={currentStep} exploredRabbitHoles={exploredRabbitHoles} totalRabbitHoles={totalRabbitHoles} onGlossaryClick={() => setShowGlossary(true)} onRestartClick={() => setShowRestartConfirm(true)} onHeaderClick={handleHeaderClick} soundEnabled={soundEnabled} onSoundToggle={() => setSoundEnabled(prev => !prev)} />
      <main style={{ maxWidth: '800px', margin: '0 auto', padding: '32px 24px' }}>
        <div style={{ background: 'white', borderRadius: '16px', padding: '32px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
          {renderCurrentPart()}
          {currentPart.id !== 'complete' && <NavButtons onBack={handleBack} onContinue={handleContinue} canGoBack={canGoBack} canContinue={canContinue} soundEnabled={soundEnabled} />}
        </div>
      </main>

      {/* Tutorial Navigation Footer */}
      <div style={{
        background: '#00356b',
        padding: '24px',
        display: 'flex',
        justifyContent: 'center',
        alignItems: 'center',
        gap: '16px',
        marginTop: '40px',
      }}>
        <a href="Tutorial-B-TheMachine.html" style={{
          padding: '12px 24px',
          background: 'rgba(255,255,255,0.15)',
          borderRadius: '8px',
          color: 'white',
          textDecoration: 'none',
          textAlign: 'center',
          minWidth: '140px',
        }}>
          <div style={{ fontSize: '14px', fontWeight: '500' }}>&larr; Previous</div>
          <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>The Machine</div>
        </a>
        <a href="index.html" style={{
          padding: '12px 24px',
          background: '#b8860b',
          borderRadius: '8px',
          color: 'white',
          textDecoration: 'none',
          textAlign: 'center',
          minWidth: '140px',
          fontWeight: '500',
        }}>
          Hub
        </a>
        <a href="Tutorial-D-RateChanges.html" style={{
          padding: '12px 24px',
          background: 'rgba(255,255,255,0.15)',
          borderRadius: '8px',
          color: 'white',
          textDecoration: 'none',
          textAlign: 'center',
          minWidth: '140px',
        }}>
          <div style={{ fontSize: '14px', fontWeight: '500' }}>Next &rarr;</div>
          <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>Rate Changes</div>
        </a>
      </div>

      {showGlossary && <GlossaryModal onClose={() => setShowGlossary(false)} />}
      {showRestartConfirm && <RestartConfirmModal onConfirm={handleRestart} onCancel={() => setShowRestartConfirm(false)} />}
      {activeRabbitHole && <RabbitHoleModal rabbitHole={activeRabbitHole} onClose={() => setActiveRabbitHole(null)} />}
      {devMode && <DevModePanel onJumpToPart={handleJumpToPart} currentPartIndex={currentPartIndex} onClose={() => setDevMode(false)} />}
    </div>
  );
};

// Render the app
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<Tutorial02D />);
    </script>
</body>
</html>
