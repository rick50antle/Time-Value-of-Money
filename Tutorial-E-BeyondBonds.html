<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutorial E: Beyond Bonds â€” Business Valuation | Time Value of Money</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f8fafc; min-height: 100vh; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useCallback, useEffect, useRef } = React;

// LucideIcon wrapper for CDN version
const LucideIcon = ({ name, size = 24, color = 'currentColor', style = {} }) => {
    const iconRef = useRef(null);
    useEffect(() => {
        if (iconRef.current && lucide[name]) {
            iconRef.current.innerHTML = '';
            const svg = lucide.createElement(lucide[name]);
            svg.setAttribute('width', size);
            svg.setAttribute('height', size);
            svg.setAttribute('stroke', color);
            iconRef.current.appendChild(svg);
        }
    }, [name, size, color]);
    return <span ref={iconRef} style={{ display: 'inline-flex', alignItems: 'center', ...style }} />;
};


// Icons:  
  ChevronLeft, 
  ChevronRight, 
  Rabbit, 
  BookOpen, 
  RotateCcw, 
  Check, 
  X, 
  Volume2,
  VolumeX,
  TrendingUp,
  DollarSign,
  Building2,
  Coffee,
  Calculator,
  ArrowRight,
  HelpCircle,
  Lightbulb,
  Target,
  Infinity


// ============================================================================
// CONSTANTS
// ============================================================================

const CONSTANTS = {
  // Bond example (at par)
  BOND_FACE: 100,
  BOND_COUPON_RATE: 0.06,
  BOND_COUPON: 6,
  BOND_YEARS: 3,
  BOND_RATE: 0.06,
  BOND_PV: 100,
  
  // Coffee shop example
  COFFEE_RATE: 0.10,
  COFFEE_CASH_FLOWS: [20000, 22000, 24000, 25000, 25000],
  COFFEE_TERMINAL_CF: 25000,
  COFFEE_TERMINAL_VALUE: 250000,
  COFFEE_EXPLICIT_PV: 86991,
  COFFEE_TERMINAL_PV: 155230,
  COFFEE_TOTAL_PV: 242221,
  COFFEE_TV_PERCENT: 64,
  
  // Discounted values for explicit period (pre-calculated)
  COFFEE_DISCOUNTED: [18182, 18182, 18029, 17075, 15523], // Each year's PV
  
  // Tolerances
  TOLERANCE_TIGHT: 1,
  TOLERANCE_NORMAL: 100,
  TOLERANCE_WIDE: 500,
};

// ============================================================================
// COLORS (Yale Blue Theme)
// ============================================================================

const COLORS = {
  primary: '#00356b',
  primaryLight: '#1a4a7a',
  primaryDark: '#002548',
  background: '#f8fafc',
  surface: '#ffffff',
  surfaceAlt: '#f1f5f9',
  border: '#e2e8f0',
  borderDark: '#cbd5e1',
  textPrimary: '#1e293b',
  textSecondary: '#64748b',
  textMuted: '#94a3b8',
  accent: '#0369a1',
  accentLight: '#e0f2fe',
  gold: '#ca8a04',
  goldLight: '#fef9c3',
  goldBorder: '#eab308',
  success: '#16a34a',
  successBg: '#f0fdf4',
  successBorder: '#86efac',
  warning: '#d97706',
  warningBg: '#fffbeb',
  warningBorder: '#fcd34d',
  error: '#dc2626',
  errorBg: '#fef2f2',
  rabbitHole: '#7c3aed',
  rabbitHoleLight: '#ede9fe',
  rabbitHoleBorder: '#a78bfa',
  terminalValue: '#059669',
  terminalValueLight: '#d1fae5',
  explicitPeriod: '#0369a1',
  explicitPeriodLight: '#e0f2fe',
};

// ============================================================================
// TUTORIAL STRUCTURE
// ============================================================================

const PARTS = [
  { id: 'theQuestion', title: 'The Question', steps: 2 },
  { id: 'whatMakesBondsEasy', title: 'What Makes Bonds Easy?', steps: 2 },
  { id: 'bondReview', title: 'Valuing a Bond (Review)', steps: 2 },
  { id: 'coffeeShop', title: 'Valuing a Business', steps: 4 },
  { id: 'keyInsight', title: 'The Key Insight', steps: 1 },
  { id: 'complete', title: 'Complete', steps: 1 },
];

// ============================================================================
// RABBIT HOLES
// ============================================================================

const RABBIT_HOLES = {
  buffettDCF: {
    id: 'buffettDCF',
    title: 'Warren Buffett and DCF',
    content: `Warren Buffett, one of the most successful investors ever, has said: "Intrinsic value can be defined simply: It is the discounted value of the cash that can be taken out of a business during its remaining life."

That's it. That's the whole method. The same DCF framework you've learned for bonds applies to Buffett's multi-billion dollar investments.

Of course, the difficulty isn't the math â€” it's estimating those future cash flows. Buffett famously focuses on businesses he understands deeply, where he can make reasonable projections. He calls this his "circle of competence."

The calculation is the easy part. The judgment about future cash flows is what separates great investors from average ones.`
  },
  
  terminalValueProblem: {
    id: 'terminalValueProblem',
    title: 'The Terminal Value Problem',
    content: `Here's an uncomfortable truth: in most business valuations, the terminal value represents 60-80% of the total value. Sometimes more.

Think about what that means. You're saying that most of the value comes from cash flows in the distant future â€” the very cash flows you're least certain about.

This isn't a flaw in the method; it's a reflection of reality. A business that will generate cash for decades genuinely IS worth more than one that will only last a few years. The terminal value captures that long-term potential.

But it also means you should be humble about precision. Small changes in your terminal value assumptions can swing the total value dramatically. This is why experienced analysts always do "sensitivity analysis" â€” checking how the value changes when assumptions vary.

The terminal value isn't wrong. It's just a reminder that valuation is as much judgment as calculation.`
  },
  
  terminalAlternatives: {
    id: 'terminalAlternatives',
    title: 'Alternative Approaches to Terminal Value',
    content: `The perpetuity method (TV = CF / r) assumes cash flows continue forever at the same level. But there are other approaches:

**Growing Perpetuity:** If you expect cash flows to grow at rate g forever:
TV = CF Ã— (1 + g) / (r - g)

This is more realistic for businesses that grow with inflation or the economy. But be careful: if g approaches r, the terminal value explodes toward infinity.

**Exit Multiple:** Instead of a perpetuity, assume you sell the business at some multiple of earnings or cash flow. For example: TV = Year 5 Cash Flow Ã— 10.

This is common in practice because it feels more concrete. But where does that multiple come from? Often from comparable company valuations â€” which themselves are based on DCF!

**Liquidation Value:** Assume the business is wound down and assets are sold. This gives a floor value but often understates the worth of a going concern.

Each approach has tradeoffs. The perpetuity is clean and theoretically grounded. Multiples are practical but circular. The key is understanding what you're assuming.`
  },
};

// ============================================================================
// GLOSSARY
// ============================================================================

const GLOSSARY = {
  dcf: {
    term: 'Discounted Cash Flow (DCF)',
    definition: 'A valuation method that calculates present value by discounting all expected future cash flows back to today. The universal language of valuation.',
  },
  terminalValue: {
    term: 'Terminal Value',
    definition: 'The present value of all cash flows beyond the explicit forecast period, typically calculated using a perpetuity formula. Often represents 60-80% of total business value.',
  },
  perpetuity: {
    term: 'Perpetuity',
    definition: 'A stream of equal cash flows that continues forever. The present value of a perpetuity is CF / r, where CF is the cash flow and r is the discount rate.',
  },
  explicitPeriod: {
    term: 'Explicit Forecast Period',
    definition: 'The years for which you project individual cash flows (typically 5-10 years). After this, cash flows are captured in the terminal value.',
  },
  discountRate: {
    term: 'Discount Rate',
    definition: 'The rate used to convert future cash flows to present value. For businesses, this reflects the riskiness of the cash flows.',
  },
  presentValue: {
    term: 'Present Value (PV)',
    definition: 'What a future amount is worth today, after discounting at the appropriate rate.',
  },
};

// ============================================================================
// SOUND SYSTEM
// ============================================================================

const playSound = (type) => {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);
    
    switch (type) {
      case 'success':
        oscillator.frequency.setValueAtTime(523.25, ctx.currentTime);
        oscillator.frequency.setValueAtTime(659.25, ctx.currentTime + 0.1);
        oscillator.frequency.setValueAtTime(783.99, ctx.currentTime + 0.2);
        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.4);
        break;
        
      case 'softNope':
        oscillator.frequency.setValueAtTime(783.99, ctx.currentTime);
        oscillator.frequency.setValueAtTime(659.25, ctx.currentTime + 0.15);
        gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.3);
        break;
        
      case 'click':
        oscillator.frequency.setValueAtTime(600, ctx.currentTime);
        gainNode.gain.setValueAtTime(0.15, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.08);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.08);
        break;
        
      case 'rabbitHole':
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(880, ctx.currentTime);
        oscillator.frequency.setValueAtTime(932.33, ctx.currentTime + 0.05);
        oscillator.frequency.setValueAtTime(880, ctx.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.25);
        break;
        
      case 'insight':
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(523.25, ctx.currentTime);
        oscillator.frequency.setValueAtTime(659.25, ctx.currentTime + 0.15);
        oscillator.frequency.setValueAtTime(783.99, ctx.currentTime + 0.3);
        oscillator.frequency.setValueAtTime(1046.50, ctx.currentTime + 0.45);
        gainNode.gain.setValueAtTime(0.25, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.6);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.6);
        break;
        
      default:
        break;
    }
    
    setTimeout(() => ctx.close(), 700);
  } catch (e) {
    // Fail silently
  }
};

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

const formatCurrency = (value, decimals = 2) => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals,
  }).format(value);
};

const formatCurrencyK = (value) => {
  if (value >= 1000) {
    return '$' + (value / 1000).toFixed(0) + 'K';
  }
  return formatCurrency(value, 0);
};

const parseUserInput = (input) => {
  const cleaned = String(input).replace(/[$,\s]/g, '');
  return parseFloat(cleaned);
};

const checkAnswer = (userValue, correctValue, tolerance) => {
  return Math.abs(userValue - correctValue) <= tolerance;
};

const calculateProgress = (currentPartIndex, currentStep) => {
  const totalSteps = PARTS.reduce((sum, p) => sum + p.steps, 0);
  const completedSteps = PARTS.slice(0, currentPartIndex).reduce((sum, p) => sum + p.steps, 0) + currentStep;
  
  const isLastStep = currentPartIndex === PARTS.length - 1 && currentStep === PARTS[currentPartIndex].steps - 1;
  if (isLastStep) return 100;
  
  return Math.round((completedSteps / totalSteps) * 100);
};

// ============================================================================
// UI COMPONENTS
// ============================================================================

// --- Header Component ---
const Header = ({ 
  currentPartIndex, 
  currentStep, 
  exploredRabbitHoles, 
  totalRabbitHoles, 
  onGlossaryClick, 
  onRestartClick,
  onHeaderClick,
  soundEnabled,
  onSoundToggle 
}) => {
  const progress = calculateProgress(currentPartIndex, currentStep);
  const currentPart = PARTS[currentPartIndex];
  
  return (
    <header style={{
      background: COLORS.primary,
      color: 'white',
      padding: '16px 24px',
      position: 'sticky',
      top: 0,
      zIndex: 100,
    }}>
      <div style={{ maxWidth: '800px', margin: '0 auto' }}>
        <div style={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '12px',
        }}>
          <h1 
            onClick={onHeaderClick}
            style={{
              fontSize: '18px',
              fontWeight: '600',
              margin: 0,
              cursor: 'default',
              userSelect: 'none',
            }}
          >
            Beyond Bonds â€” Business Valuation
          </h1>
          
          <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
            <button
              onClick={onSoundToggle}
              style={{
                background: 'rgba(255,255,255,0.1)',
                border: 'none',
                borderRadius: '6px',
                padding: '6px',
                cursor: 'pointer',
                color: 'white',
                display: 'flex',
                alignItems: 'center',
              }}
              title={soundEnabled ? 'Mute sounds' : 'Enable sounds'}
            >
              {soundEnabled ? <LucideIcon name="Volume2" size={18} /> : <LucideIcon name="VolumeX" size={18} />}
            </button>
            
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: '4px',
              background: COLORS.rabbitHoleLight,
              color: COLORS.rabbitHole,
              padding: '4px 10px',
              borderRadius: '12px',
              fontSize: '13px',
              fontWeight: '500',
            }}>
              <LucideIcon name="Rabbit" size={14} />
              {exploredRabbitHoles.length}/{totalRabbitHoles}
            </div>
            
            <button
              onClick={onGlossaryClick}
              style={{
                background: 'rgba(255,255,255,0.1)',
                border: 'none',
                borderRadius: '6px',
                padding: '6px 10px',
                cursor: 'pointer',
                color: 'white',
                display: 'flex',
                alignItems: 'center',
                gap: '4px',
                fontSize: '13px',
              }}
            >
              <LucideIcon name="BookOpen" size={16} />
              Glossary
            </button>
            
            <button
              onClick={onRestartClick}
              style={{
                background: 'rgba(255,255,255,0.1)',
                border: 'none',
                borderRadius: '6px',
                padding: '6px',
                cursor: 'pointer',
                color: 'white',
                display: 'flex',
                alignItems: 'center',
              }}
              title="Restart tutorial"
            >
              <LucideIcon name="RotateCcw" size={18} />
            </button>
          </div>
        </div>
        
        <div>
          <div style={{
            display: 'flex',
            justifyContent: 'space-between',
            fontSize: '13px',
            marginBottom: '6px',
            opacity: 0.9,
          }}>
            <span>Part {currentPartIndex + 1}: {currentPart.title}</span>
            <span>{progress}% complete</span>
          </div>
          
          <div style={{
            background: 'rgba(255,255,255,0.2)',
            borderRadius: '4px',
            height: '6px',
            overflow: 'hidden',
          }}>
            <div style={{
              background: COLORS.goldBorder,
              height: '100%',
              width: `${progress}%`,
              transition: 'width 0.3s ease',
              borderRadius: '4px',
            }} />
          </div>
        </div>
      </div>
    </header>
  );
};

// --- Navigation Buttons ---
const NavButtons = ({ onBack, onContinue, canGoBack, canContinue, continueLabel = 'Continue', soundEnabled }) => {
  const handleContinue = () => {
    if (soundEnabled) playSound('click');
    onContinue();
  };
  
  const handleBack = () => {
    if (soundEnabled) playSound('click');
    onBack();
  };
  
  return (
    <div style={{
      display: 'flex',
      justifyContent: 'space-between',
      marginTop: '32px',
      paddingTop: '24px',
      borderTop: `1px solid ${COLORS.border}`,
    }}>
      <button
        onClick={handleBack}
        disabled={!canGoBack}
        style={{
          display: 'flex',
          alignItems: 'center',
          gap: '6px',
          padding: '10px 20px',
          border: `1px solid ${COLORS.border}`,
          borderRadius: '8px',
          background: 'white',
          color: canGoBack ? COLORS.textPrimary : COLORS.textMuted,
          cursor: canGoBack ? 'pointer' : 'not-allowed',
          fontSize: '15px',
          opacity: canGoBack ? 1 : 0.5,
        }}
      >
        <LucideIcon name="ChevronLeft" size={18} />
        Back
      </button>
      
      <button
        onClick={handleContinue}
        disabled={!canContinue}
        style={{
          display: 'flex',
          alignItems: 'center',
          gap: '6px',
          padding: '10px 24px',
          border: 'none',
          borderRadius: '8px',
          background: canContinue ? COLORS.primary : COLORS.textMuted,
          color: 'white',
          cursor: canContinue ? 'pointer' : 'not-allowed',
          fontSize: '15px',
          fontWeight: '500',
        }}
      >
        {continueLabel}
        <LucideIcon name="ChevronRight" size={18} />
      </button>
    </div>
  );
};

// --- Calculation Box ---
const CalculationBox = ({ 
  prompt, 
  correctAnswer, 
  hint1, 
  hint2, 
  onCorrect,
  soundEnabled,
  tolerance = CONSTANTS.TOLERANCE_NORMAL,
  prefix = '$',
  placeholder = '0.00'
}) => {
  const [input, setInput] = useState('');
  const [attempts, setAttempts] = useState(0);
  const [isCorrect, setIsCorrect] = useState(false);
  const [showHint, setShowHint] = useState(null);
  
  const handleCheck = () => {
    const userValue = parseUserInput(input);
    
    if (isNaN(userValue)) {
      setShowHint('Please enter a valid number');
      return;
    }
    
    if (checkAnswer(userValue, correctAnswer, tolerance)) {
      setIsCorrect(true);
      if (soundEnabled) playSound('success');
      onCorrect?.();
    } else {
      const newAttempts = attempts + 1;
      setAttempts(newAttempts);
      if (soundEnabled) playSound('softNope');
      
      if (newAttempts >= 3) {
        const displayAnswer = correctAnswer >= 1000 
          ? formatCurrency(correctAnswer, 0) 
          : formatCurrency(correctAnswer);
        setShowHint(`The answer is ${displayAnswer}`);
        setIsCorrect(true);
        onCorrect?.();
      } else if (newAttempts === 2 && hint2) {
        setShowHint(hint2);
      } else if (hint1) {
        setShowHint(hint1);
      }
    }
  };
  
  return (
    <div style={{
      background: COLORS.surfaceAlt,
      border: `1px solid ${COLORS.border}`,
      borderRadius: '12px',
      padding: '20px',
      marginTop: '16px',
    }}>
      <p style={{ margin: '0 0 16px 0', fontSize: '15px', color: COLORS.textPrimary }}>
        {prompt}
      </p>
      
      <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
        <div style={{ position: 'relative', flex: 1 }}>
          <span style={{
            position: 'absolute',
            left: '12px',
            top: '50%',
            transform: 'translateY(-50%)',
            color: COLORS.textMuted,
          }}>{prefix}</span>
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            disabled={isCorrect}
            placeholder={placeholder}
            style={{
              width: '100%',
              padding: '12px 12px 12px 28px',
              border: `2px solid ${isCorrect ? COLORS.successBorder : COLORS.border}`,
              borderRadius: '8px',
              fontSize: '16px',
              fontFamily: 'monospace',
              background: isCorrect ? COLORS.successBg : 'white',
              boxSizing: 'border-box',
            }}
            onKeyDown={(e) => e.key === 'Enter' && !isCorrect && handleCheck()}
          />
        </div>
        
        <button
          onClick={handleCheck}
          disabled={isCorrect || !input}
          style={{
            padding: '12px 20px',
            border: 'none',
            borderRadius: '8px',
            background: isCorrect ? COLORS.success : COLORS.primary,
            color: 'white',
            fontSize: '15px',
            fontWeight: '500',
            cursor: isCorrect || !input ? 'default' : 'pointer',
            display: 'flex',
            alignItems: 'center',
            gap: '6px',
          }}
        >
          {isCorrect ? <LucideIcon name="Check" size={18} /> : 'Check'}
        </button>
      </div>
      
      {showHint && (
        <p style={{
          marginTop: '12px',
          padding: '10px 12px',
          background: isCorrect && attempts >= 3 ? COLORS.warningBg : COLORS.accentLight,
          borderRadius: '6px',
          fontSize: '14px',
          color: isCorrect && attempts >= 3 ? COLORS.warning : COLORS.accent,
        }}>
          {showHint}
        </p>
      )}
    </div>
  );
};

// --- Insight Box ---
const InsightBox = ({ children, icon }) => (
  <div style={{
    background: COLORS.goldLight,
    border: `2px solid ${COLORS.goldBorder}`,
    borderRadius: '12px',
    padding: '20px',
    marginTop: '20px',
    marginBottom: '20px',
  }}>
    <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-start' }}>
      {icon || <LucideIcon name="Lightbulb" size={24} color={COLORS.gold} style={{ flexShrink: 0, marginTop: '2px' }} />}
      <div style={{ fontSize: '16px', lineHeight: '1.6', color: COLORS.textPrimary }}>
        {children}
      </div>
    </div>
  </div>
);

// --- Rabbit Hole Button ---
const RabbitHoleButton = ({ rabbitHole, explored, onClick, soundEnabled }) => {
  const handleClick = () => {
    if (soundEnabled) playSound('rabbitHole');
    onClick();
  };
  
  return (
    <button
      onClick={handleClick}
      style={{
        display: 'flex',
        alignItems: 'center',
        gap: '10px',
        width: '100%',
        padding: '14px 16px',
        border: `2px dashed ${COLORS.rabbitHoleBorder}`,
        borderRadius: '10px',
        background: explored ? COLORS.rabbitHoleLight : 'white',
        color: COLORS.rabbitHole,
        cursor: 'pointer',
        fontSize: '14px',
        textAlign: 'left',
        marginTop: '16px',
        transition: 'all 0.2s ease',
      }}
    >
      <LucideIcon name="Rabbit" size={20} style={{ flexShrink: 0 }} />
      <span style={{ flex: 1 }}>{rabbitHole.title}</span>
      {explored && <LucideIcon name="Check" size={18} />}
    </button>
  );
};

// --- Modals ---
const RabbitHoleModal = ({ rabbitHole, onClose }) => {
  if (!rabbitHole) return null;
  
  return (
    <div style={{
      position: 'fixed',
      inset: 0,
      background: 'rgba(0,0,0,0.5)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      padding: '20px',
      zIndex: 1000,
    }}>
      <div style={{
        background: 'white',
        borderRadius: '16px',
        maxWidth: '600px',
        maxHeight: '80vh',
        overflow: 'auto',
        boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
      }}>
        <div style={{
          background: COLORS.rabbitHole,
          color: 'white',
          padding: '20px 24px',
          display: 'flex',
          alignItems: 'center',
          gap: '12px',
        }}>
          <LucideIcon name="Rabbit" size={24} />
          <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600' }}>
            {rabbitHole.title}
          </h2>
        </div>
        
        <div style={{
          padding: '24px',
          fontSize: '15px',
          lineHeight: '1.7',
          color: COLORS.textPrimary,
        }}>
          {rabbitHole.content.split('\n\n').map((paragraph, i) => (
            <p key={i} style={{ margin: i === 0 ? 0 : '16px 0 0 0' }}>
              {paragraph}
            </p>
          ))}
        </div>
        
        <div style={{
          padding: '16px 24px',
          borderTop: `1px solid ${COLORS.border}`,
          display: 'flex',
          justifyContent: 'flex-end',
        }}>
          <button
            onClick={onClose}
            style={{
              padding: '10px 24px',
              border: 'none',
              borderRadius: '8px',
              background: COLORS.rabbitHole,
              color: 'white',
              fontSize: '15px',
              fontWeight: '500',
              cursor: 'pointer',
            }}
          >
            Back to Tutorial
          </button>
        </div>
      </div>
    </div>
  );
};

const GlossaryModal = ({ onClose }) => (
  <div style={{
    position: 'fixed',
    inset: 0,
    background: 'rgba(0,0,0,0.5)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    padding: '20px',
    zIndex: 1000,
  }}>
    <div style={{
      background: 'white',
      borderRadius: '16px',
      maxWidth: '600px',
      maxHeight: '80vh',
      overflow: 'auto',
      boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
    }}>
      <div style={{
        background: COLORS.primary,
        color: 'white',
        padding: '20px 24px',
        display: 'flex',
        alignItems: 'center',
        gap: '12px',
      }}>
        <LucideIcon name="BookOpen" size={24} />
        <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600' }}>Glossary</h2>
      </div>
      
      <div style={{ padding: '16px 24px' }}>
        {Object.values(GLOSSARY).map((item, i) => (
          <div key={item.term} style={{
            padding: '16px 0',
            borderBottom: i < Object.values(GLOSSARY).length - 1 ? `1px solid ${COLORS.border}` : 'none',
          }}>
            <h3 style={{ margin: '0 0 6px 0', fontSize: '16px', fontWeight: '600', color: COLORS.primary }}>
              {item.term}
            </h3>
            <p style={{ margin: 0, fontSize: '14px', lineHeight: '1.5', color: COLORS.textSecondary }}>
              {item.definition}
            </p>
          </div>
        ))}
      </div>
      
      <div style={{
        padding: '16px 24px',
        borderTop: `1px solid ${COLORS.border}`,
        display: 'flex',
        justifyContent: 'flex-end',
      }}>
        <button
          onClick={onClose}
          style={{
            padding: '10px 24px',
            border: 'none',
            borderRadius: '8px',
            background: COLORS.primary,
            color: 'white',
            fontSize: '15px',
            fontWeight: '500',
            cursor: 'pointer',
          }}
        >
          Close
        </button>
      </div>
    </div>
  </div>
);

const RestartConfirmModal = ({ onConfirm, onCancel }) => (
  <div style={{
    position: 'fixed',
    inset: 0,
    background: 'rgba(0,0,0,0.5)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    padding: '20px',
    zIndex: 1000,
  }}>
    <div style={{
      background: 'white',
      borderRadius: '16px',
      maxWidth: '400px',
      padding: '24px',
      boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
    }}>
      <h3 style={{ margin: '0 0 12px 0', fontSize: '18px', color: COLORS.textPrimary }}>
        Restart Tutorial?
      </h3>
      <p style={{ margin: '0 0 24px 0', color: COLORS.textSecondary, lineHeight: '1.5' }}>
        This will reset all your progress and start from the beginning.
      </p>
      <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
        <button
          onClick={onCancel}
          style={{
            padding: '10px 20px',
            border: `1px solid ${COLORS.border}`,
            borderRadius: '8px',
            background: 'white',
            color: COLORS.textPrimary,
            fontSize: '15px',
            cursor: 'pointer',
          }}
        >
          Cancel
        </button>
        <button
          onClick={onConfirm}
          style={{
            padding: '10px 20px',
            border: 'none',
            borderRadius: '8px',
            background: COLORS.warning,
            color: 'white',
            fontSize: '15px',
            fontWeight: '500',
            cursor: 'pointer',
          }}
        >
          Restart
        </button>
      </div>
    </div>
  </div>
);

const DevModePanel = ({ onJumpToPart, currentPartIndex, onClose }) => (
  <div style={{
    position: 'fixed',
    bottom: '20px',
    right: '20px',
    background: 'white',
    border: `2px solid ${COLORS.warning}`,
    borderRadius: '12px',
    padding: '16px',
    boxShadow: '0 10px 40px rgba(0,0,0,0.15)',
    zIndex: 999,
    maxHeight: '400px',
    overflow: 'auto',
  }}>
    <div style={{
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: '12px',
    }}>
      <h3 style={{ margin: 0, fontSize: '14px', color: COLORS.warning, fontWeight: '600' }}>
        ðŸ›  Dev Mode
      </h3>
      <button
        onClick={onClose}
        style={{ background: 'none', border: 'none', cursor: 'pointer', color: COLORS.textMuted }}
      >
        <LucideIcon name="X" size={18} />
      </button>
    </div>
    
    <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
      {PARTS.map((part, index) => (
        <button
          key={part.id}
          onClick={() => onJumpToPart(index)}
          style={{
            padding: '8px 12px',
            border: `1px solid ${index === currentPartIndex ? COLORS.warning : COLORS.border}`,
            borderRadius: '6px',
            background: index === currentPartIndex ? COLORS.warningBg : 'white',
            color: COLORS.textPrimary,
            fontSize: '13px',
            textAlign: 'left',
            cursor: 'pointer',
          }}
        >
          {index + 1}. {part.title}
        </button>
      ))}
    </div>
  </div>
);

// ============================================================================
// VISUAL COMPONENTS
// ============================================================================

// --- Bond Cash Flow Diagram ---
const BondCashFlowDiagram = ({ showValues = false }) => {
  return (
    <div style={{
      background: COLORS.surfaceAlt,
      borderRadius: '12px',
      padding: '24px',
      marginTop: '16px',
    }}>
      <div style={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'flex-end',
        position: 'relative',
        minHeight: '120px',
        paddingBottom: '40px',
      }}>
        {/* Timeline line */}
        <div style={{
          position: 'absolute',
          bottom: '20px',
          left: '10%',
          right: '10%',
          height: '2px',
          background: COLORS.borderDark,
        }} />
        
        {/* Arrow */}
        <div style={{
          position: 'absolute',
          right: '10%',
          bottom: '16px',
          width: 0,
          height: 0,
          borderTop: '6px solid transparent',
          borderBottom: '6px solid transparent',
          borderLeft: `8px solid ${COLORS.borderDark}`,
        }} />
        
        {[
          { time: 0, amount: null, label: 'Today' },
          { time: 1, amount: 6, label: 'Coupon' },
          { time: 2, amount: 6, label: 'Coupon' },
          { time: 3, amount: 106, label: 'Coupon + Face' },
        ].map((flow, i) => (
          <div key={i} style={{
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            position: 'relative',
            flex: 1,
          }}>
            {flow.amount !== null && (
              <>
                <div style={{
                  background: 'white',
                  border: `2px solid ${COLORS.border}`,
                  borderRadius: '8px',
                  padding: '8px 12px',
                  marginBottom: '8px',
                  fontFamily: 'monospace',
                  fontSize: '14px',
                  fontWeight: '600',
                  textAlign: 'center',
                }}>
                  {showValues ? formatCurrency(flow.amount, 0) : '?'}
                  <div style={{ fontSize: '10px', fontWeight: 'normal', opacity: 0.8, marginTop: '2px' }}>
                    {flow.label}
                  </div>
                </div>
                <div style={{ width: '2px', height: '16px', background: COLORS.borderDark }} />
              </>
            )}
            
            <div style={{
              width: '10px',
              height: '10px',
              borderRadius: '50%',
              background: flow.amount !== null ? COLORS.textSecondary : COLORS.border,
              position: 'absolute',
              bottom: '15px',
            }} />
            
            <span style={{
              position: 'absolute',
              bottom: '-4px',
              fontSize: '12px',
              color: COLORS.textSecondary,
            }}>
              {i === 0 ? 'Today' : `Year ${i}`}
            </span>
          </div>
        ))}
      </div>
    </div>
  );
};

// --- Coffee Shop Cash Flow Diagram ---
const CoffeeShopCashFlowDiagram = ({ showExplicit = true, showTerminal = false, highlightTerminal = false }) => {
  const cashFlows = CONSTANTS.COFFEE_CASH_FLOWS;
  
  return (
    <div style={{
      background: COLORS.surfaceAlt,
      borderRadius: '12px',
      padding: '24px',
      marginTop: '16px',
    }}>
      <div style={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'flex-end',
        position: 'relative',
        minHeight: '140px',
        paddingBottom: '40px',
      }}>
        {/* Timeline line */}
        <div style={{
          position: 'absolute',
          bottom: '20px',
          left: '5%',
          right: showTerminal ? '5%' : '10%',
          height: '2px',
          background: COLORS.borderDark,
        }} />
        
        {/* Arrow */}
        <div style={{
          position: 'absolute',
          right: showTerminal ? '5%' : '10%',
          bottom: '16px',
          width: 0,
          height: 0,
          borderTop: '6px solid transparent',
          borderBottom: '6px solid transparent',
          borderLeft: `8px solid ${COLORS.borderDark}`,
        }} />
        
        {/* Today marker */}
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          position: 'relative',
          flex: 0.5,
        }}>
          <div style={{
            width: '10px',
            height: '10px',
            borderRadius: '50%',
            background: COLORS.border,
            position: 'absolute',
            bottom: '15px',
          }} />
          <span style={{
            position: 'absolute',
            bottom: '-4px',
            fontSize: '12px',
            color: COLORS.textSecondary,
          }}>
            Today
          </span>
        </div>
        
        {/* Cash flow years */}
        {cashFlows.map((cf, i) => (
          <div key={i} style={{
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            position: 'relative',
            flex: 1,
          }}>
            {showExplicit && (
              <>
                <div style={{
                  background: 'white',
                  border: `2px solid ${COLORS.explicitPeriod}`,
                  borderRadius: '8px',
                  padding: '6px 10px',
                  marginBottom: '8px',
                  fontFamily: 'monospace',
                  fontSize: '13px',
                  fontWeight: '600',
                  textAlign: 'center',
                  color: COLORS.explicitPeriod,
                }}>
                  {formatCurrencyK(cf)}
                </div>
                <div style={{ width: '2px', height: '16px', background: COLORS.explicitPeriod }} />
              </>
            )}
            
            <div style={{
              width: '10px',
              height: '10px',
              borderRadius: '50%',
              background: COLORS.explicitPeriod,
              position: 'absolute',
              bottom: '15px',
            }} />
            
            <span style={{
              position: 'absolute',
              bottom: '-4px',
              fontSize: '11px',
              color: COLORS.textSecondary,
            }}>
              Year {i + 1}
            </span>
          </div>
        ))}
        
        {/* Terminal value indicator */}
        {showTerminal && (
          <div style={{
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            position: 'relative',
            flex: 1,
          }}>
            <div style={{
              background: highlightTerminal ? COLORS.terminalValueLight : 'white',
              border: `2px solid ${COLORS.terminalValue}`,
              borderRadius: '8px',
              padding: '6px 10px',
              marginBottom: '8px',
              fontFamily: 'monospace',
              fontSize: '13px',
              fontWeight: '600',
              textAlign: 'center',
              color: COLORS.terminalValue,
              display: 'flex',
              alignItems: 'center',
              gap: '4px',
            }}>
              {formatCurrencyK(CONSTANTS.COFFEE_TERMINAL_VALUE)}
              <span style={{ fontSize: '10px', fontWeight: 'normal' }}>TV</span>
            </div>
            <div style={{ width: '2px', height: '16px', background: COLORS.terminalValue }} />
            
            {/* "Forever" indicator */}
            <div style={{
              position: 'absolute',
              right: '-30px',
              bottom: '18px',
              display: 'flex',
              alignItems: 'center',
              gap: '4px',
              color: COLORS.terminalValue,
              fontSize: '11px',
            }}>
              <span>...</span>
              <LucideIcon name="Infinity" size={14} />
            </div>
            
            <div style={{
              width: '10px',
              height: '10px',
              borderRadius: '50%',
              background: COLORS.terminalValue,
              position: 'absolute',
              bottom: '15px',
            }} />
            
            <span style={{
              position: 'absolute',
              bottom: '-4px',
              fontSize: '11px',
              color: COLORS.textSecondary,
              whiteSpace: 'nowrap',
            }}>
              Year 5+
            </span>
          </div>
        )}
      </div>
      
      {/* Legend */}
      <div style={{
        display: 'flex',
        gap: '20px',
        justifyContent: 'center',
        marginTop: '12px',
        paddingTop: '12px',
        borderTop: `1px solid ${COLORS.border}`,
      }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '12px' }}>
          <div style={{ width: '12px', height: '12px', borderRadius: '3px', background: COLORS.explicitPeriod }} />
          <span style={{ color: COLORS.textSecondary }}>Explicit Period (Years 1-5)</span>
        </div>
        {showTerminal && (
          <div style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '12px' }}>
            <div style={{ width: '12px', height: '12px', borderRadius: '3px', background: COLORS.terminalValue }} />
            <span style={{ color: COLORS.textSecondary }}>Terminal Value (Year 5+)</span>
          </div>
        )}
      </div>
    </div>
  );
};

// --- Terminal Value Breakdown Chart ---
const TerminalValueBreakdownChart = () => {
  const explicitPV = CONSTANTS.COFFEE_EXPLICIT_PV;
  const terminalPV = CONSTANTS.COFFEE_TERMINAL_PV;
  const totalPV = CONSTANTS.COFFEE_TOTAL_PV;
  const explicitPercent = Math.round((explicitPV / totalPV) * 100);
  const terminalPercent = 100 - explicitPercent;
  
  return (
    <div style={{
      background: COLORS.surfaceAlt,
      borderRadius: '12px',
      padding: '24px',
      marginTop: '16px',
    }}>
      <h4 style={{ margin: '0 0 16px 0', fontSize: '15px', fontWeight: '600', color: COLORS.textPrimary }}>
        Where Does the Value Come From?
      </h4>
      
      {/* Stacked horizontal bar */}
      <div style={{
        display: 'flex',
        height: '48px',
        borderRadius: '8px',
        overflow: 'hidden',
        border: `1px solid ${COLORS.border}`,
      }}>
        <div style={{
          width: `${explicitPercent}%`,
          background: COLORS.explicitPeriod,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          color: 'white',
          fontSize: '14px',
          fontWeight: '600',
          transition: 'width 0.5s ease',
        }}>
          {explicitPercent}%
        </div>
        <div style={{
          width: `${terminalPercent}%`,
          background: COLORS.terminalValue,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          color: 'white',
          fontSize: '14px',
          fontWeight: '600',
          transition: 'width 0.5s ease',
        }}>
          {terminalPercent}%
        </div>
      </div>
      
      {/* Legend with dollar amounts */}
      <div style={{
        display: 'flex',
        justifyContent: 'space-between',
        marginTop: '16px',
      }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
          <div style={{
            width: '16px',
            height: '16px',
            borderRadius: '4px',
            background: COLORS.explicitPeriod,
          }} />
          <div>
            <div style={{ fontSize: '13px', fontWeight: '600', color: COLORS.textPrimary }}>
              Explicit Period
            </div>
            <div style={{ fontSize: '12px', color: COLORS.textSecondary, fontFamily: 'monospace' }}>
              {formatCurrency(explicitPV, 0)}
            </div>
          </div>
        </div>
        
        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
          <div style={{
            width: '16px',
            height: '16px',
            borderRadius: '4px',
            background: COLORS.terminalValue,
          }} />
          <div>
            <div style={{ fontSize: '13px', fontWeight: '600', color: COLORS.textPrimary }}>
              Terminal Value
            </div>
            <div style={{ fontSize: '12px', color: COLORS.textSecondary, fontFamily: 'monospace' }}>
              {formatCurrency(terminalPV, 0)}
            </div>
          </div>
        </div>
      </div>
      
      {/* Total */}
      <div style={{
        marginTop: '16px',
        paddingTop: '16px',
        borderTop: `1px solid ${COLORS.border}`,
        display: 'flex',
        justifyContent: 'center',
      }}>
        <div style={{
          background: COLORS.goldLight,
          border: `2px solid ${COLORS.goldBorder}`,
          borderRadius: '8px',
          padding: '12px 24px',
          textAlign: 'center',
        }}>
          <div style={{ fontSize: '13px', color: COLORS.textSecondary }}>Total Business Value</div>
          <div style={{ fontSize: '20px', fontWeight: '700', color: COLORS.gold, fontFamily: 'monospace' }}>
            {formatCurrency(totalPV, 0)}
          </div>
        </div>
      </div>
    </div>
  );
};

// ============================================================================
// PART COMPONENTS
// ============================================================================

// --- Part 0: The Question ---
const TheQuestionPart = ({ currentStep, onContinue, onBack, canGoBack, soundEnabled }) => {
  if (currentStep === 0) {
    return (
      <div>
        <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>
          Is DCF a Universal Language?
        </h2>
        
        <p style={{ color: COLORS.textSecondary, lineHeight: 1.7 }}>
          You've learned to value bonds using discounted cash flow analysis. 
          You discount each promised payment back to today, sum them up, and that's the bond's value.
        </p>
        
        <p style={{ color: COLORS.textSecondary, lineHeight: 1.7, marginTop: '16px' }}>
          But here's a bigger question:
        </p>
        
        <div style={{
          background: COLORS.primaryLight,
          color: 'white',
          padding: '24px',
          borderRadius: '12px',
          marginTop: '20px',
          textAlign: 'center',
        }}>
          <p style={{ fontSize: '20px', fontWeight: '600', margin: 0 }}>
            Can the same approach value a business?
          </p>
        </div>
        
        <p style={{ color: COLORS.textSecondary, lineHeight: 1.7, marginTop: '20px' }}>
          Bonds have clean, contractual cash flows. Businesses are messier â€” 
          uncertain, ongoing, potentially infinite.
        </p>
        
        <NavButtons
          onBack={onBack}
          onContinue={onContinue}
          canGoBack={canGoBack}
          canContinue={true}
          soundEnabled={soundEnabled}
        />
      </div>
    );
  }
  
  // Step 1
  return (
    <div>
      <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>
        The Scenario
      </h2>
      
      <div style={{
        background: COLORS.surfaceAlt,
        border: `1px solid ${COLORS.border}`,
        borderRadius: '12px',
        padding: '20px',
        marginBottom: '20px',
      }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
          <LucideIcon name="Coffee" size={24} color={COLORS.primary} />
          <span style={{ fontSize: '17px', fontWeight: '600', color: COLORS.textPrimary }}>
            Your Friend's Coffee Shop
          </span>
        </div>
        <p style={{ color: COLORS.textSecondary, lineHeight: 1.6, margin: 0 }}>
          Your friend Sarah wants to sell you her coffee shop. It's been running for 3 years 
          and has stable customers. She's done the financial projections â€” you trust the numbers.
        </p>
        <p style={{ color: COLORS.textSecondary, lineHeight: 1.6, marginTop: '12px', marginBottom: 0 }}>
          <strong>The question:</strong> What's a fair price?
        </p>
      </div>
      
      <p style={{ color: COLORS.textSecondary, lineHeight: 1.7 }}>
        We'll compare two valuations side by side:
      </p>
      
      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginTop: '16px' }}>
        <div style={{
          background: 'white',
          border: `1px solid ${COLORS.border}`,
          borderRadius: '10px',
          padding: '16px',
          textAlign: 'center',
        }}>
          <LucideIcon name="Building2" size={28} color={COLORS.primary} style={{ marginBottom: '8px' }} />
          <div style={{ fontWeight: '600', color: COLORS.textPrimary }}>A Bond</div>
          <div style={{ fontSize: '13px', color: COLORS.textSecondary, marginTop: '4px' }}>
            Contractual, finite
          </div>
        </div>
        
        <div style={{
          background: 'white',
          border: `1px solid ${COLORS.border}`,
          borderRadius: '10px',
          padding: '16px',
          textAlign: 'center',
        }}>
          <LucideIcon name="Coffee" size={28} color={COLORS.primary} style={{ marginBottom: '8px' }} />
          <div style={{ fontWeight: '600', color: COLORS.textPrimary }}>A Business</div>
          <div style={{ fontSize: '13px', color: COLORS.textSecondary, marginTop: '4px' }}>
            Projected, ongoing
          </div>
        </div>
      </div>
      
      <NavButtons
        onBack={onBack}
        onContinue={onContinue}
        canGoBack={canGoBack}
        canContinue={true}
        soundEnabled={soundEnabled}
      />
    </div>
  );
};

// --- Part 1: What Makes Bonds Easy? ---
const WhatMakesBondsEasyPart = ({ currentStep, onContinue, onBack, canGoBack, soundEnabled }) => {
  if (currentStep === 0) {
    return (
      <div>
        <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>
          What Makes Bonds Easy to Value?
        </h2>
        
        <p style={{ color: COLORS.textSecondary, lineHeight: 1.7 }}>
          Think about what you know when you buy a bond:
        </p>
        
        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', marginTop: '20px' }}>
          {[
            { text: 'Exact amounts:', detail: 'The coupon payments and face value are contractual' },
            { text: 'Exact timing:', detail: 'You know when each payment arrives' },
            { text: 'Finite horizon:', detail: "The bond matures â€” there's an end date" },
          ].map((item, i) => (
            <div key={i} style={{
              display: 'flex',
              alignItems: 'center',
              gap: '12px',
              padding: '14px',
              background: COLORS.successBg,
              borderRadius: '10px',
              border: `1px solid ${COLORS.successBorder}`,
            }}>
              <LucideIcon name="Check" size={20} color={COLORS.success} />
              <span style={{ color: COLORS.textPrimary }}>
                <strong>{item.text}</strong> {item.detail}
              </span>
            </div>
          ))}
        </div>
        
        <p style={{ color: COLORS.textSecondary, lineHeight: 1.7, marginTop: '20px' }}>
          These features make bonds relatively easy to value. You just discount each 
          known cash flow back to today.
        </p>
        
        <NavButtons
          onBack={onBack}
          onContinue={onContinue}
          canGoBack={canGoBack}
          canContinue={true}
          soundEnabled={soundEnabled}
        />
      </div>
    );
  }
  
  // Step 1
  return (
    <div>
      <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>
        Businesses Are Different
      </h2>
      
      <p style={{ color: COLORS.textSecondary, lineHeight: 1.7 }}>
        A business presents three challenges that bonds don't:
      </p>
      
      <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', marginTop: '20px' }}>
        {[
          { text: 'Uncertain amounts:', detail: 'Cash flows are projections, not contracts' },
          { text: 'Ongoing horizon:', detail: 'A healthy business could last forever' },
          { text: 'Variable cash flows:', detail: 'Earnings change year to year' },
        ].map((item, i) => (
          <div key={i} style={{
            display: 'flex',
            alignItems: 'center',
            gap: '12px',
            padding: '14px',
            background: COLORS.warningBg,
            borderRadius: '10px',
            border: `1px solid ${COLORS.warningBorder}`,
          }}>
            <LucideIcon name="HelpCircle" size={20} color={COLORS.warning} />
            <span style={{ color: COLORS.textPrimary }}>
              <strong>{item.text}</strong> {item.detail}
            </span>
          </div>
        ))}
      </div>
      
      <InsightBox>
        <strong>The core question:</strong> Can we still use DCF when cash flows are 
        uncertain and potentially infinite? (Spoiler: yes â€” but we'll need one new concept.)
      </InsightBox>
      
      <NavButtons
        onBack={onBack}
        onContinue={onContinue}
        canGoBack={canGoBack}
        canContinue={true}
        soundEnabled={soundEnabled}
      />
    </div>
  );
};

// --- Part 2: Bond Review ---
const BondReviewPart = ({ currentStep, onContinue, onBack, canGoBack, soundEnabled, onCalcComplete, calcCompleted }) => {
  if (currentStep === 0) {
    return (
      <div>
        <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>
          Quick Review: Valuing a Bond
        </h2>
        
        <p style={{ color: COLORS.textSecondary, lineHeight: 1.7 }}>
          Let's start with familiar territory. Here's a simple bond:
        </p>
        
        <div style={{
          background: COLORS.surfaceAlt,
          border: `1px solid ${COLORS.border}`,
          borderRadius: '12px',
          padding: '20px',
          marginTop: '16px',
        }}>
          <div style={{ display: 'grid', gridTemplateColumns: 'auto 1fr', gap: '12px 20px', fontSize: '15px' }}>
            <span style={{ color: COLORS.textSecondary }}>Face value:</span>
            <span style={{ fontWeight: '600', fontFamily: 'monospace' }}>$100</span>
            
            <span style={{ color: COLORS.textSecondary }}>Coupon rate:</span>
            <span style={{ fontWeight: '600', fontFamily: 'monospace' }}>6% per year</span>
            
            <span style={{ color: COLORS.textSecondary }}>Maturity:</span>
            <span style={{ fontWeight: '600', fontFamily: 'monospace' }}>3 years</span>
            
            <span style={{ color: COLORS.textSecondary }}>Market interest rate:</span>
            <span style={{ fontWeight: '600', fontFamily: 'monospace' }}>6% per year</span>
          </div>
        </div>
        
        <BondCashFlowDiagram showValues={true} />
        
        <p style={{ color: COLORS.textSecondary, lineHeight: 1.7, marginTop: '16px' }}>
          The cash flows are: $6 at Year 1, $6 at Year 2, and $106 (coupon + face value) at Year 3.
        </p>
        
        <NavButtons
          onBack={onBack}
          onContinue={onContinue}
          canGoBack={canGoBack}
          canContinue={true}
          soundEnabled={soundEnabled}
        />
      </div>
    );
  }
  
  // Step 1 â€” FIXED: Removed the explicit answer
  return (
    <div>
      <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>
        Bond Present Value
      </h2>
      
      <p style={{ color: COLORS.textSecondary, lineHeight: 1.7 }}>
        When the market interest rate equals the coupon rate (both 6%), 
        the bond trades at its face value. This is called trading "at par."
      </p>
      
      <div style={{
        background: COLORS.surfaceAlt,
        border: `1px solid ${COLORS.border}`,
        borderRadius: '12px',
        padding: '20px',
        marginTop: '16px',
        fontFamily: 'monospace',
        fontSize: '14px',
        lineHeight: 1.8,
      }}>
        <div>PV = $6/1.06 + $6/1.06Â² + $106/1.06Â³</div>
        <div style={{ marginTop: '8px', color: COLORS.textSecondary }}>
          Discount each cash flow, then sum them up.
        </div>
      </div>
      
      <CalculationBox
        prompt="What is the present value of this bond?"
        correctAnswer={CONSTANTS.BOND_PV}
        hint1="When coupon rate = market rate, the bond trades at..."
        hint2="The bond trades at par, meaning PV equals face value"
        tolerance={CONSTANTS.TOLERANCE_TIGHT}
        onCorrect={() => onCalcComplete('bondPV')}
        soundEnabled={soundEnabled}
      />
      
      {calcCompleted.bondPV && (
        <InsightBox icon={<LucideIcon name="Check" size={24} color={COLORS.gold} />}>
          Exactly. The bond is worth $100 â€” its face value â€” because the coupon rate 
          matches the market rate. No premium, no discount.
        </InsightBox>
      )}
      
      <NavButtons
        onBack={onBack}
        onContinue={onContinue}
        canGoBack={canGoBack}
        canContinue={calcCompleted.bondPV}
        soundEnabled={soundEnabled}
      />
    </div>
  );
};

// --- Part 3: Coffee Shop (COMPLETE in Pass 2) ---
const CoffeeShopPart = ({ currentStep, onContinue, onBack, canGoBack, soundEnabled, onRabbitHole, exploredRabbitHoles, onCalcComplete, calcCompleted }) => {
  
  // Step 0: Introduce the Coffee Shop Cash Flows
  if (currentStep === 0) {
    return (
      <div>
        <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>
          Sarah's Coffee Shop Projections
        </h2>
        
        <p style={{ color: COLORS.textSecondary, lineHeight: 1.7 }}>
          Sarah has projected the coffee shop's cash flows for the next 5 years:
        </p>
        
        <div style={{
          background: COLORS.surfaceAlt,
          border: `1px solid ${COLORS.border}`,
          borderRadius: '12px',
          padding: '20px',
          marginTop: '16px',
        }}>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '12px', textAlign: 'center' }}>
            {CONSTANTS.COFFEE_CASH_FLOWS.map((cf, i) => (
              <div key={i}>
                <div style={{ fontSize: '12px', color: COLORS.textSecondary, marginBottom: '4px' }}>
                  Year {i + 1}
                </div>
                <div style={{
                  fontFamily: 'monospace',
                  fontSize: '15px',
                  fontWeight: '600',
                  color: COLORS.explicitPeriod,
                }}>
                  {formatCurrencyK(cf)}
                </div>
              </div>
            ))}
          </div>
        </div>
        
        <p style={{ color: COLORS.textSecondary, lineHeight: 1.7, marginTop: '16px' }}>
          The business is riskier than a bond, so we'll use a higher discount rate: <strong>10% per year</strong>.
        </p>
        
        <CoffeeShopCashFlowDiagram showExplicit={true} showTerminal={false} />
        
        <p style={{ color: COLORS.textSecondary, lineHeight: 1.7, marginTop: '16px' }}>
          This looks straightforward â€” just like valuing a bond, but with different cash flows. 
          Let's start discounting.
        </p>
        
        <NavButtons
          onBack={onBack}
          onContinue={onContinue}
          canGoBack={canGoBack}
          canContinue={true}
          soundEnabled={soundEnabled}
        />
      </div>
    );
  }
  
  // Step 1: Calculate Explicit Period PV
  if (currentStep === 1) {
    return (
      <div>
        <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>
          Discounting the Explicit Cash Flows
        </h2>
        
        <p style={{ color: COLORS.textSecondary, lineHeight: 1.7 }}>
          Let's discount each year's cash flow back to today at 10%:
        </p>
        
        <div style={{
          background: COLORS.surfaceAlt,
          border: `1px solid ${COLORS.border}`,
          borderRadius: '12px',
          padding: '20px',
          marginTop: '16px',
          fontFamily: 'monospace',
          fontSize: '13px',
          lineHeight: 2,
        }}>
          <div>PV = $20,000/1.10 + $22,000/1.10Â² + $24,000/1.10Â³ + $25,000/1.10â´ + $25,000/1.10âµ</div>
          <div style={{ marginTop: '12px', borderTop: `1px solid ${COLORS.border}`, paddingTop: '12px' }}>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '8px', textAlign: 'center' }}>
              <div>
                <div style={{ color: COLORS.textSecondary, fontSize: '11px' }}>Year 1</div>
                <div style={{ color: COLORS.explicitPeriod }}>$18,182</div>
              </div>
              <div>
                <div style={{ color: COLORS.textSecondary, fontSize: '11px' }}>Year 2</div>
                <div style={{ color: COLORS.explicitPeriod }}>$18,182</div>
              </div>
              <div>
                <div style={{ color: COLORS.textSecondary, fontSize: '11px' }}>Year 3</div>
                <div style={{ color: COLORS.explicitPeriod }}>$18,029</div>
              </div>
              <div>
                <div style={{ color: COLORS.textSecondary, fontSize: '11px' }}>Year 4</div>
                <div style={{ color: COLORS.explicitPeriod }}>$17,075</div>
              </div>
              <div>
                <div style={{ color: COLORS.textSecondary, fontSize: '11px' }}>Year 5</div>
                <div style={{ color: COLORS.explicitPeriod }}>$15,523</div>
              </div>
            </div>
          </div>
        </div>
        
        <CalculationBox
          prompt="What is the sum of these five discounted cash flows?"
          correctAnswer={CONSTANTS.COFFEE_EXPLICIT_PV}
          hint1="Add up all five present values: $18,182 + $18,182 + $18,029 + $17,075 + $15,523"
          hint2="The sum is approximately $87,000"
          tolerance={CONSTANTS.TOLERANCE_NORMAL}
          onCorrect={() => onCalcComplete('explicitPV')}
          soundEnabled={soundEnabled}
        />
        
        {calcCompleted.explicitPV && (
          <InsightBox>
            <strong>But wait</strong> â€” that's just 5 years of cash flows. What about all the years after that? 
            A healthy coffee shop doesn't just stop generating cash in Year 6.
          </InsightBox>
        )}
        
        <NavButtons
          onBack={onBack}
          onContinue={onContinue}
          canGoBack={canGoBack}
          canContinue={calcCompleted.explicitPV}
          soundEnabled={soundEnabled}
        />
      </div>
    );
  }
  
  // Step 2: Introduce Terminal Value
  if (currentStep === 2) {
    return (
      <div>
        <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>
          The "Forever" Problem
        </h2>
        
        <p style={{ color: COLORS.textSecondary, lineHeight: 1.7 }}>
          Unlike a bond that matures, a business could generate cash flows indefinitely. 
          How do we value an infinite stream of cash?
        </p>
        
        <p style={{ color: COLORS.textSecondary, lineHeight: 1.7, marginTop: '16px' }}>
          The answer: we assume that after Year 5, the business generates steady cash flows forever. 
          This is called a <strong>perpetuity</strong>, and there's a simple formula for its value:
        </p>
        
        <div style={{
          background: COLORS.terminalValueLight,
          border: `2px solid ${COLORS.terminalValue}`,
          borderRadius: '12px',
          padding: '24px',
          marginTop: '20px',
          textAlign: 'center',
        }}>
          <div style={{ fontSize: '13px', color: COLORS.terminalValue, marginBottom: '8px' }}>
            Terminal Value (at Year 5)
          </div>
          <div style={{ fontSize: '24px', fontFamily: 'monospace', fontWeight: '700', color: COLORS.terminalValue }}>
            TV = Cash Flow / Discount Rate
          </div>
          <div style={{ marginTop: '16px', fontSize: '15px', fontFamily: 'monospace' }}>
            TV = $25,000 / 0.10 = <span style={{ fontWeight: '700', color: COLORS.terminalValue }}>$250,000</span>
          </div>
        </div>
        
        <p style={{ color: COLORS.textSecondary, lineHeight: 1.7, marginTop: '20px' }}>
          This $250,000 represents the value, <em>as of Year 5</em>, of receiving $25,000 every year forever.
        </p>
        
        <CoffeeShopCashFlowDiagram showExplicit={true} showTerminal={true} highlightTerminal={true} />
        
        <RabbitHoleButton
          rabbitHole={RABBIT_HOLES.terminalAlternatives}
          explored={exploredRabbitHoles.includes('terminalAlternatives')}
          onClick={() => onRabbitHole('terminalAlternatives')}
          soundEnabled={soundEnabled}
        />
        
        <NavButtons
          onBack={onBack}
          onContinue={onContinue}
          canGoBack={canGoBack}
          canContinue={true}
          soundEnabled={soundEnabled}
        />
      </div>
    );
  }
  
  // Step 3: Bring It All Together
  return (
    <div>
      <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>
        Bringing It All Together
      </h2>
      
      <p style={{ color: COLORS.textSecondary, lineHeight: 1.7 }}>
        The terminal value of $250,000 is the value <em>at Year 5</em>. 
        To get today's value, we need to discount it back 5 years:
      </p>
      
      <div style={{
        background: COLORS.surfaceAlt,
        border: `1px solid ${COLORS.border}`,
        borderRadius: '12px',
        padding: '20px',
        marginTop: '16px',
        fontFamily: 'monospace',
        fontSize: '14px',
        lineHeight: 1.8,
        textAlign: 'center',
      }}>
        <div>PV of Terminal Value = $250,000 / 1.10âµ</div>
        <div style={{ marginTop: '8px', color: COLORS.textSecondary }}>
          Discount the terminal value back 5 years at 10%
        </div>
      </div>
      
      <CalculationBox
        prompt="What is the present value of the $250,000 terminal value?"
        correctAnswer={CONSTANTS.COFFEE_TERMINAL_PV}
        hint1="Divide $250,000 by (1.10)âµ = 1.6105"
        hint2="$250,000 / 1.6105 â‰ˆ $155,230"
        tolerance={CONSTANTS.TOLERANCE_WIDE}
        onCorrect={() => onCalcComplete('terminalPV')}
        soundEnabled={soundEnabled}
      />
      
      {calcCompleted.terminalPV && (
        <>
          <TerminalValueBreakdownChart />
          
          <InsightBox>
            <strong>About {CONSTANTS.COFFEE_TV_PERCENT}% of the value comes from the terminal value!</strong>
            {' '}This is typical in business valuation â€” most of the worth comes from cash flows 
            in the distant future.
          </InsightBox>
          
          <RabbitHoleButton
            rabbitHole={RABBIT_HOLES.terminalValueProblem}
            explored={exploredRabbitHoles.includes('terminalValueProblem')}
            onClick={() => onRabbitHole('terminalValueProblem')}
            soundEnabled={soundEnabled}
          />
        </>
      )}
      
      <NavButtons
        onBack={onBack}
        onContinue={onContinue}
        canGoBack={canGoBack}
        canContinue={calcCompleted.terminalPV}
        soundEnabled={soundEnabled}
      />
    </div>
  );
};

// --- Part 4: Key Insight ---
const KeyInsightPart = ({ currentStep, onContinue, onBack, canGoBack, soundEnabled, onRabbitHole, exploredRabbitHoles }) => {
  return (
    <div>
      <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>
        The Universal Method
      </h2>
      
      <p style={{ color: COLORS.textSecondary, lineHeight: 1.7 }}>
        Let's step back and see what we've actually done. We valued two completely different assets 
        using the exact same method.
      </p>
      
      {/* Side-by-side comparison table */}
      <div style={{
        background: COLORS.surfaceAlt,
        borderRadius: '12px',
        padding: '24px',
        marginTop: '20px',
        overflowX: 'auto',
      }}>
        <table style={{
          width: '100%',
          borderCollapse: 'collapse',
          fontSize: '14px',
        }}>
          <thead>
            <tr>
              <th style={{
                textAlign: 'left',
                padding: '12px 16px',
                borderBottom: `2px solid ${COLORS.border}`,
                color: COLORS.textSecondary,
                fontWeight: '500',
              }}></th>
              <th style={{
                textAlign: 'center',
                padding: '12px 16px',
                borderBottom: `2px solid ${COLORS.border}`,
                color: COLORS.primary,
                fontWeight: '600',
              }}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
                  <LucideIcon name="Building2" size={18} />
                  Bond
                </div>
              </th>
              <th style={{
                textAlign: 'center',
                padding: '12px 16px',
                borderBottom: `2px solid ${COLORS.border}`,
                color: COLORS.primary,
                fontWeight: '600',
              }}>
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
                  <LucideIcon name="Coffee" size={18} />
                  Coffee Shop
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style={{ padding: '12px 16px', borderBottom: `1px solid ${COLORS.border}`, fontWeight: '500', color: COLORS.textPrimary }}>
                Cash Flows
              </td>
              <td style={{ padding: '12px 16px', borderBottom: `1px solid ${COLORS.border}`, textAlign: 'center', color: COLORS.textSecondary }}>
                Contractual
              </td>
              <td style={{ padding: '12px 16px', borderBottom: `1px solid ${COLORS.border}`, textAlign: 'center', color: COLORS.textSecondary }}>
                Projected
              </td>
            </tr>
            <tr>
              <td style={{ padding: '12px 16px', borderBottom: `1px solid ${COLORS.border}`, fontWeight: '500', color: COLORS.textPrimary }}>
                Time Horizon
              </td>
              <td style={{ padding: '12px 16px', borderBottom: `1px solid ${COLORS.border}`, textAlign: 'center', color: COLORS.textSecondary }}>
                3 years (finite)
              </td>
              <td style={{ padding: '12px 16px', borderBottom: `1px solid ${COLORS.border}`, textAlign: 'center', color: COLORS.textSecondary }}>
                Forever (via TV)
              </td>
            </tr>
            <tr>
              <td style={{ padding: '12px 16px', borderBottom: `1px solid ${COLORS.border}`, fontWeight: '500', color: COLORS.textPrimary }}>
                Discount Rate
              </td>
              <td style={{ padding: '12px 16px', borderBottom: `1px solid ${COLORS.border}`, textAlign: 'center', color: COLORS.textSecondary }}>
                6%
              </td>
              <td style={{ padding: '12px 16px', borderBottom: `1px solid ${COLORS.border}`, textAlign: 'center', color: COLORS.textSecondary }}>
                10%
              </td>
            </tr>
            <tr style={{ background: COLORS.goldLight }}>
              <td style={{ padding: '12px 16px', borderBottom: `1px solid ${COLORS.goldBorder}`, fontWeight: '600', color: COLORS.gold }}>
                Method
              </td>
              <td style={{ padding: '12px 16px', borderBottom: `1px solid ${COLORS.goldBorder}`, textAlign: 'center', fontWeight: '600', color: COLORS.gold }}>
                DCF
              </td>
              <td style={{ padding: '12px 16px', borderBottom: `1px solid ${COLORS.goldBorder}`, textAlign: 'center', fontWeight: '600', color: COLORS.gold }}>
                DCF
              </td>
            </tr>
            <tr>
              <td style={{ padding: '12px 16px', fontWeight: '500', color: COLORS.textPrimary }}>
                Value
              </td>
              <td style={{ padding: '12px 16px', textAlign: 'center', fontFamily: 'monospace', fontWeight: '600', color: COLORS.primary }}>
                {formatCurrency(CONSTANTS.BOND_PV, 0)}
              </td>
              <td style={{ padding: '12px 16px', textAlign: 'center', fontFamily: 'monospace', fontWeight: '600', color: COLORS.primary }}>
                {formatCurrency(CONSTANTS.COFFEE_TOTAL_PV, 0)}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <p style={{ color: COLORS.textSecondary, lineHeight: 1.7, marginTop: '20px' }}>
        The inputs differ â€” certainty of cash flows, time horizon, discount rate â€” but the 
        method is identical. Estimate future cash flows, discount them back to today, sum them up.
      </p>
      
      <InsightBox>
        <strong>Whether it's a bond, a coffee shop, a tech startup, or a Fortune 500 company â€” 
        the valuation method is the same.</strong>
        {' '}Estimate future cash flows. Discount them back to today. That's DCF.
      </InsightBox>
      
      <p style={{ color: COLORS.textSecondary, lineHeight: 1.7 }}>
        The math is the easy part. The hard part? Estimating those future cash flows. 
        That's where judgment, experience, and deep understanding of a business come in.
      </p>
      
      <RabbitHoleButton
        rabbitHole={RABBIT_HOLES.buffettDCF}
        explored={exploredRabbitHoles.includes('buffettDCF')}
        onClick={() => onRabbitHole('buffettDCF')}
        soundEnabled={soundEnabled}
      />
      
      <NavButtons
        onBack={onBack}
        onContinue={onContinue}
        canGoBack={canGoBack}
        canContinue={true}
        soundEnabled={soundEnabled}
      />
    </div>
  );
};

// --- Part 5: Complete ---
const CompletePart = ({ exploredRabbitHoles, totalRabbitHoles, soundEnabled, onRabbitHole, calcCompleted }) => {
  const totalCalculations = 3; // bondPV, terminalValue, terminalPV
  const completedCalculations = calcCompleted ? Object.keys(calcCompleted).filter(k => calcCompleted[k]).length : 0;
  
  return (
    <div>
      {/* Celebration header */}
      <div style={{ textAlign: 'center', padding: '20px 0' }}>
        <div style={{
          width: '80px',
          height: '80px',
          borderRadius: '50%',
          background: COLORS.successBg,
          border: `3px solid ${COLORS.success}`,
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          margin: '0 auto 20px',
          animation: 'pulse 2s ease-in-out infinite',
        }}>
          <LucideIcon name="Check" size={40} color={COLORS.success} />
        </div>
        
        <h2 style={{ color: COLORS.primary, marginBottom: '8px' }}>
          Tutorial Complete!
        </h2>
        
        <p style={{ color: COLORS.textSecondary, fontSize: '16px' }}>
          You've discovered the universal language of valuation.
        </p>
      </div>
      
      {/* Key Takeaways */}
      <div style={{
        background: COLORS.goldLight,
        border: `2px solid ${COLORS.goldBorder}`,
        borderRadius: '12px',
        padding: '24px',
        marginTop: '24px',
      }}>
        <h3 style={{ 
          margin: '0 0 16px 0', 
          fontSize: '17px', 
          fontWeight: '600', 
          color: COLORS.gold,
          display: 'flex',
          alignItems: 'center',
          gap: '8px',
        }}>
          <LucideIcon name="Lightbulb" size={20} />
          Key Takeaways
        </h3>
        
        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
          {[
            'DCF works for any asset that generates cash flows â€” bonds, businesses, projects, or investments.',
            'Terminal value captures the "forever" portion of business value, typically representing 60-80% of total worth.',
            'The only differences between valuing assets are the inputs: cash flow certainty, time horizon, and discount rate.',
            'The math is the easy part â€” estimating future cash flows is where real skill comes in.',
          ].map((takeaway, i) => (
            <div key={i} style={{ 
              display: 'flex', 
              alignItems: 'flex-start', 
              gap: '10px',
              fontSize: '15px',
              lineHeight: 1.6,
              color: COLORS.textPrimary,
            }}>
              <LucideIcon name="Check" size={18} color={COLORS.success} style={{ flexShrink: 0, marginTop: '3px' }} />
              <span>{takeaway}</span>
            </div>
          ))}
        </div>
      </div>
      
      {/* What You Learned */}
      <div style={{
        background: COLORS.surfaceAlt,
        borderRadius: '12px',
        padding: '24px',
        marginTop: '20px',
      }}>
        <h3 style={{ 
          margin: '0 0 16px 0', 
          fontSize: '17px', 
          fontWeight: '600', 
          color: COLORS.textPrimary,
          display: 'flex',
          alignItems: 'center',
          gap: '8px',
        }}>
          <LucideIcon name="Target" size={20} color={COLORS.primary} />
          What You Learned
        </h3>
        
        <div style={{ display: 'grid', gap: '12px' }}>
          <div style={{
            display: 'flex',
            alignItems: 'center',
            gap: '12px',
            padding: '12px 16px',
            background: 'white',
            borderRadius: '8px',
            border: `1px solid ${COLORS.border}`,
          }}>
            <LucideIcon name="Building2" size={20} color={COLORS.primary} />
            <div>
              <div style={{ fontWeight: '500', color: COLORS.textPrimary, fontSize: '14px' }}>
                Valued a bond using DCF
              </div>
              <div style={{ fontSize: '13px', color: COLORS.textSecondary }}>
                Review of discounting contractual cash flows
              </div>
            </div>
          </div>
          
          <div style={{
            display: 'flex',
            alignItems: 'center',
            gap: '12px',
            padding: '12px 16px',
            background: 'white',
            borderRadius: '8px',
            border: `1px solid ${COLORS.border}`,
          }}>
            <LucideIcon name="Coffee" size={20} color={COLORS.primary} />
            <div>
              <div style={{ fontWeight: '500', color: COLORS.textPrimary, fontSize: '14px' }}>
                Valued a business using DCF + terminal value
              </div>
              <div style={{ fontSize: '13px', color: COLORS.textSecondary }}>
                New concept: capturing infinite cash flows
              </div>
            </div>
          </div>
          
          <div style={{
            display: 'flex',
            alignItems: 'center',
            gap: '12px',
            padding: '12px 16px',
            background: 'white',
            borderRadius: '8px',
            border: `1px solid ${COLORS.border}`,
          }}>
            <LucideIcon name="TrendingUp" size={20} color={COLORS.primary} />
            <div>
              <div style={{ fontWeight: '500', color: COLORS.textPrimary, fontSize: '14px' }}>
                Discovered DCF is a universal framework
              </div>
              <div style={{ fontSize: '13px', color: COLORS.textSecondary }}>
                Same method, different inputs
              </div>
            </div>
          </div>
        </div>
      </div>
      
      {/* Stats */}
      <div style={{
        display: 'grid',
        gridTemplateColumns: '1fr 1fr',
        gap: '16px',
        marginTop: '20px',
      }}>
        <div style={{
          background: 'white',
          border: `1px solid ${COLORS.border}`,
          borderRadius: '10px',
          padding: '16px',
          textAlign: 'center',
        }}>
          <div style={{ 
            fontSize: '28px', 
            fontWeight: '700', 
            color: COLORS.success,
            fontFamily: 'monospace',
          }}>
            {completedCalculations}/{totalCalculations}
          </div>
          <div style={{ fontSize: '13px', color: COLORS.textSecondary, marginTop: '4px' }}>
            Calculations completed
          </div>
        </div>
        
        <div style={{
          background: 'white',
          border: `1px solid ${COLORS.border}`,
          borderRadius: '10px',
          padding: '16px',
          textAlign: 'center',
        }}>
          <div style={{ 
            fontSize: '28px', 
            fontWeight: '700', 
            color: COLORS.rabbitHole,
            fontFamily: 'monospace',
          }}>
            {exploredRabbitHoles.length}/{totalRabbitHoles}
          </div>
          <div style={{ fontSize: '13px', color: COLORS.textSecondary, marginTop: '4px' }}>
            Rabbit holes explored
          </div>
        </div>
      </div>
      
      {/* Rabbit Holes Section */}
      <div style={{
        background: COLORS.rabbitHoleLight,
        borderRadius: '12px',
        padding: '20px',
        marginTop: '24px',
      }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '12px' }}>
          <LucideIcon name="Rabbit" size={20} color={COLORS.rabbitHole} />
          <span style={{ fontWeight: '600', color: COLORS.rabbitHole }}>
            Explore More
          </span>
        </div>
        
        <p style={{ 
          fontSize: '14px', 
          color: COLORS.textSecondary, 
          margin: '0 0 12px 0',
          lineHeight: 1.5,
        }}>
          {exploredRabbitHoles.length < totalRabbitHoles 
            ? "Didn't catch all the rabbit holes? Click any below to explore:"
            : "You explored all the rabbit holes! Click any to revisit:"}
        </p>
        
        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
          {Object.values(RABBIT_HOLES).map(rh => (
            <button
              key={rh.id}
              onClick={() => onRabbitHole(rh.id)}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: '8px',
                padding: '10px 14px',
                border: `1px solid ${COLORS.rabbitHoleBorder}`,
                borderRadius: '8px',
                background: exploredRabbitHoles.includes(rh.id) ? COLORS.rabbitHoleLight : 'white',
                color: COLORS.rabbitHole,
                fontSize: '14px',
                cursor: 'pointer',
                textAlign: 'left',
              }}
            >
              <LucideIcon name="Rabbit" size={16} />
              <span style={{ flex: 1 }}>{rh.title}</span>
              {exploredRabbitHoles.includes(rh.id) && <LucideIcon name="Check" size={16} />}
            </button>
          ))}
        </div>
      </div>
      
      {/* Module Complete */}
      <div style={{
        background: COLORS.primaryLight,
        color: 'white',
        borderRadius: '12px',
        padding: '24px',
        marginTop: '24px',
        textAlign: 'center',
      }}>
        <h3 style={{ margin: '0 0 8px 0', fontSize: '17px', fontWeight: '600' }}>
          ðŸŽ‰ Main Flow Complete!
        </h3>
        <p style={{ margin: '0 0 16px 0', fontSize: '15px', opacity: 0.95, lineHeight: 1.6 }}>
          You've mastered the fundamentals of time value of money â€” from the puzzle of comparing
          cash flows to valuing entire businesses. Ready for more? Explore the Deep Dives.
        </p>
        <a href="index.html" style={{
          display: 'inline-block',
          padding: '10px 24px',
          background: 'white',
          color: COLORS.primary,
          borderRadius: '8px',
          textDecoration: 'none',
          fontWeight: '500',
          fontSize: '15px',
        }}>
          Return to Hub
        </a>
      </div>
    </div>
  );
};

// ============================================================================
// MAIN TUTORIAL COMPONENT
// ============================================================================

const Tutorial02H = () => {
  // --- Core State ---
  const [currentPartIndex, setCurrentPartIndex] = useState(0);
  const [currentStep, setCurrentStep] = useState(0);
  const [soundEnabled, setSoundEnabled] = useState(true);
  
  // --- Modal State ---
  const [showGlossary, setShowGlossary] = useState(false);
  const [showRestartConfirm, setShowRestartConfirm] = useState(false);
  const [activeRabbitHole, setActiveRabbitHole] = useState(null);
  
  // --- Progress State ---
  const [exploredRabbitHoles, setExploredRabbitHoles] = useState([]);
  const [calcCompleted, setCalcCompleted] = useState({});
  
  // --- Dev Mode State ---
  const [devMode, setDevMode] = useState(false);
  const [headerClickCount, setHeaderClickCount] = useState(0);
  const [lastClickTime, setLastClickTime] = useState(0);
  
  const totalRabbitHoles = Object.keys(RABBIT_HOLES).length;
  
  // --- Handlers ---
  const handleContinue = useCallback(() => {
    const currentPart = PARTS[currentPartIndex];
    
    if (currentStep < currentPart.steps - 1) {
      setCurrentStep(prev => prev + 1);
    } else if (currentPartIndex < PARTS.length - 1) {
      setCurrentPartIndex(prev => prev + 1);
      setCurrentStep(0);
    }
  }, [currentPartIndex, currentStep]);
  
  const handleBack = useCallback(() => {
    if (currentStep > 0) {
      setCurrentStep(prev => prev - 1);
    } else if (currentPartIndex > 0) {
      const prevPartIndex = currentPartIndex - 1;
      setCurrentPartIndex(prevPartIndex);
      setCurrentStep(PARTS[prevPartIndex].steps - 1);
    }
  }, [currentPartIndex, currentStep]);
  
  const handleRestart = useCallback(() => {
    setShowRestartConfirm(true);
  }, []);
  
  const confirmRestart = useCallback(() => {
    setCurrentPartIndex(0);
    setCurrentStep(0);
    setExploredRabbitHoles([]);
    setCalcCompleted({});
    setShowRestartConfirm(false);
  }, []);
  
  const handleRabbitHoleClick = useCallback((rabbitHoleId) => {
    setActiveRabbitHole(RABBIT_HOLES[rabbitHoleId]);
    if (!exploredRabbitHoles.includes(rabbitHoleId)) {
      setExploredRabbitHoles(prev => [...prev, rabbitHoleId]);
    }
  }, [exploredRabbitHoles]);
  
  const handleCalcComplete = useCallback((calcId) => {
    setCalcCompleted(prev => ({ ...prev, [calcId]: true }));
  }, []);
  
  const handleHeaderClick = useCallback(() => {
    const now = Date.now();
    if (now - lastClickTime < 500) {
      const newCount = headerClickCount + 1;
      setHeaderClickCount(newCount);
      if (newCount >= 3) {
        setDevMode(prev => !prev);
        setHeaderClickCount(0);
      }
    } else {
      setHeaderClickCount(1);
    }
    setLastClickTime(now);
  }, [headerClickCount, lastClickTime]);
  
  const handleJumpToPart = useCallback((partIndex) => {
    setCurrentPartIndex(partIndex);
    setCurrentStep(0);
  }, []);
  
  // --- Computed Values ---
  const canGoBack = currentPartIndex > 0 || currentStep > 0;
  
  // --- Render Current Part ---
  const renderCurrentPart = () => {
    const commonProps = {
      currentStep,
      onContinue: handleContinue,
      onBack: handleBack,
      canGoBack,
      soundEnabled,
      onRabbitHole: handleRabbitHoleClick,
      exploredRabbitHoles,
    };
    
    switch (PARTS[currentPartIndex].id) {
      case 'theQuestion':
        return <TheQuestionPart {...commonProps} />;
      case 'whatMakesBondsEasy':
        return <WhatMakesBondsEasyPart {...commonProps} />;
      case 'bondReview':
        return <BondReviewPart {...commonProps} onCalcComplete={handleCalcComplete} calcCompleted={calcCompleted} />;
      case 'coffeeShop':
        return <CoffeeShopPart {...commonProps} onCalcComplete={handleCalcComplete} calcCompleted={calcCompleted} />;
      case 'keyInsight':
        return <KeyInsightPart {...commonProps} />;
      case 'complete':
        return <CompletePart exploredRabbitHoles={exploredRabbitHoles} totalRabbitHoles={totalRabbitHoles} soundEnabled={soundEnabled} onRabbitHole={handleRabbitHoleClick} calcCompleted={calcCompleted} />;
      default:
        return null;
    }
  };
  
  return (
    <div style={{
      minHeight: '100vh',
      background: COLORS.background,
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
    }}>
      <Header
        currentPartIndex={currentPartIndex}
        currentStep={currentStep}
        exploredRabbitHoles={exploredRabbitHoles}
        totalRabbitHoles={totalRabbitHoles}
        onGlossaryClick={() => setShowGlossary(true)}
        onRestartClick={handleRestart}
        onHeaderClick={handleHeaderClick}
        soundEnabled={soundEnabled}
        onSoundToggle={() => setSoundEnabled(prev => !prev)}
      />
      
      <main style={{ maxWidth: '800px', margin: '0 auto', padding: '32px 24px' }}>
        <div style={{
          background: 'white',
          borderRadius: '16px',
          padding: '32px',
          boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
        }}>
          {renderCurrentPart()}
        </div>
      </main>

      {/* Tutorial Navigation Footer */}
      <div style={{
        background: '#00356b',
        padding: '24px',
        display: 'flex',
        justifyContent: 'center',
        alignItems: 'center',
        gap: '16px',
        marginTop: '40px',
      }}>
        <a href="Tutorial-D-RateChanges.html" style={{
          padding: '12px 24px',
          background: 'rgba(255,255,255,0.15)',
          borderRadius: '8px',
          color: 'white',
          textDecoration: 'none',
          textAlign: 'center',
          minWidth: '140px',
        }}>
          <div style={{ fontSize: '14px', fontWeight: '500' }}>&larr; Previous</div>
          <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>Rate Changes</div>
        </a>
        <a href="index.html" style={{
          padding: '12px 24px',
          background: '#b8860b',
          borderRadius: '8px',
          color: 'white',
          textDecoration: 'none',
          textAlign: 'center',
          minWidth: '140px',
          fontWeight: '500',
        }}>
          Hub
        </a>
      </div>

      {/* Modals */}
      {showGlossary && <GlossaryModal onClose={() => setShowGlossary(false)} />}
      
      {showRestartConfirm && (
        <RestartConfirmModal
          onConfirm={confirmRestart}
          onCancel={() => setShowRestartConfirm(false)}
        />
      )}
      
      {activeRabbitHole && (
        <RabbitHoleModal
          rabbitHole={activeRabbitHole}
          onClose={() => setActiveRabbitHole(null)}
        />
      )}
      
      {devMode && (
        <DevModePanel
          onJumpToPart={handleJumpToPart}
          currentPartIndex={currentPartIndex}
          onClose={() => setDevMode(false)}
        />
      )}
    </div>
  );
};



// Render
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<Tutorial02H />);
    </script>
</body>
</html>
