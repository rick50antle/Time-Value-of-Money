<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deep Dive: Matching Time Periods and Interest Rates</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useCallback, useEffect, useRef } = React;

    // LucideIcon helper component
    const LucideIcon = ({ name, size = 24, color = "currentColor", style = {} }) => {
      const iconRef = useRef(null);

      useEffect(() => {
        if (iconRef.current && lucide && lucide[name]) {
          iconRef.current.innerHTML = '';
          const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          const iconData = lucide[name];
          svg.setAttribute('width', size);
          svg.setAttribute('height', size);
          svg.setAttribute('viewBox', '0 0 24 24');
          svg.setAttribute('fill', 'none');
          svg.setAttribute('stroke', color);
          svg.setAttribute('stroke-width', '2');
          svg.setAttribute('stroke-linecap', 'round');
          svg.setAttribute('stroke-linejoin', 'round');

          if (iconData && iconData[2]) {
            iconData[2].forEach(([tag, attrs]) => {
              const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
              Object.entries(attrs).forEach(([key, value]) => {
                el.setAttribute(key, value);
              });
              svg.appendChild(el);
            });
          }
          iconRef.current.appendChild(svg);
        }
      }, [name, size, color]);

      return <span ref={iconRef} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center', ...style }} />;
    };

    // ============================================================================
    // CONSTANTS
    // ============================================================================

    const CONSTANTS = {
      // Main example bond
      FACE_VALUE: 100,
      ANNUAL_COUPON_RATE: 0.06,
      ANNUAL_INTEREST_RATE: 0.08,
      YEARS: 3,
      PAYMENTS_PER_YEAR: 2,

      // Derived values
      PERIODS: 6,                    // 3 × 2
      PERIODIC_RATE: 0.04,           // 8% ÷ 2
      SEMI_ANNUAL_COUPON: 3.00,      // $100 × 6% ÷ 2
      FINAL_PAYMENT: 103.00,         // $3 + $100

      // Correct answer
      CORRECT_PV: 94.77,
      TOLERANCE_PV: 0.15,

      // Practice calculations
      PRACTICE_PERIODIC_RATE: 0.03,  // 6% ÷ 2
      PRACTICE_COUPON: 40.00,        // $1,000 × 8% ÷ 2

      // Wrong calculation (using annual rate)
      WRONG_PV: 76.89,

      // General tolerance
      TOLERANCE: 0.02,

      // Timing
      ESTIMATED_CORE_TIME: 15,
      ESTIMATED_FULL_TIME: 22,
    };

    // ============================================================================
    // COLORS (Yale Blue Theme)
    // ============================================================================

    const COLORS = {
      primary: '#00356b',
      primaryLight: '#1a4a7a',
      primaryDark: '#002548',

      background: '#f8fafc',
      surface: '#ffffff',
      surfaceAlt: '#f1f5f9',

      border: '#e2e8f0',
      borderDark: '#cbd5e1',

      textPrimary: '#1e293b',
      textSecondary: '#64748b',
      textMuted: '#94a3b8',

      accent: '#0369a1',
      accentLight: '#e0f2fe',

      gold: '#ca8a04',
      goldLight: '#fef9c3',
      goldBorder: '#eab308',

      success: '#16a34a',
      successBg: '#f0fdf4',
      successBorder: '#86efac',

      warning: '#d97706',
      warningBg: '#fffbeb',
      warningBorder: '#fcd34d',

      error: '#dc2626',
      errorBg: '#fef2f2',

      rabbitHole: '#7c3aed',
      rabbitHoleLight: '#ede9fe',
      rabbitHoleBorder: '#a78bfa',
    };

    // ============================================================================
    // TUTORIAL STRUCTURE
    // ============================================================================

    const PARTS = [
      { id: 'theProblem', title: 'The Problem', steps: 2 },
      { id: 'matchingPrinciple', title: 'The Matching Principle', steps: 2 },
      { id: 'convertingRate', title: 'Converting the Rate', steps: 2 },
      { id: 'countingPeriods', title: 'Counting Periods and Payments', steps: 2 },
      { id: 'puttingTogether', title: 'Putting It Together', steps: 3 },
      { id: 'commonMistakes', title: 'Common Mistakes', steps: 2 },
      { id: 'complete', title: 'Complete', steps: 1 },
    ];

    // ============================================================================
    // RABBIT HOLES DATA
    // ============================================================================

    const RABBIT_HOLES = {
      simpleInterest: {
        id: 'simpleInterest',
        title: 'Simple Interest and the Law',
        partId: 'convertingRate',
        content: `We divided the annual rate by 2 to get the semi-annual rate. This is so common it seems obvious, but it's actually a choice.

There's another way to handle interest: simple interest, where interest doesn't compound at all. If you borrow $100 at 8% simple interest for 3 years, you owe $100 + ($8 × 3) = $124. No compounding, just multiplication.

Simple interest shows up in legal contexts — courts often award damages with simple interest precisely because it's easy to calculate and explain to a jury. When a contract specifies an interest rate without saying "compounded," courts often interpret it as simple interest.

The math we're doing in this course assumes compounding, which is how financial markets actually work. But when you see interest calculations in legal documents, pay attention to whether it says "simple" or "compound" — it makes a real difference.`
      },

      whySemiAnnual: {
        id: 'whySemiAnnual',
        title: 'Why Semi-Annual?',
        partId: 'countingPeriods',
        content: `Why do most bonds pay twice a year instead of once or twelve times?

The semi-annual convention dates back to at least the Civil War era. When the U.S. Treasury issued bonds to finance the war in the 1860s, they typically paid "6% bonds paying a 3% coupon semi-annually" — the same pattern we use today.

Why twice a year? In an era of handwritten ledgers, physical coupon clipping, and mail delivery, semi-annual payments struck a practical balance. Annual payments meant bondholders waited a full year between cash flows — a long time when you might need to reinvest or when inflation could erode purchasing power. Monthly payments would have required twelve times the administrative work: twelve coupon dates, twelve mailings, twelve entries in the ledger for every single bond.

When the Treasury formalized its modern bond program in the 1920s, semi-annual payments were already the established norm. Corporate bonds followed the government's lead, and the convention became self-reinforcing: everyone structured bonds this way because everyone expected bonds to work this way.

Some securities do pay differently. Mortgage-backed securities often pay monthly (matching the underlying home loans). Some European government bonds pay annually. But for U.S. Treasuries and most corporate bonds, twice a year remains the standard — a 160-year-old convention that outlasted the paper coupons that gave it its name.`
      },

      moreFrequentCompounding: {
        id: 'moreFrequentCompounding',
        title: 'More Frequent Compounding: Where Does It End?',
        partId: 'convertingRate',
        content: `We used semi-annual compounding (2 times per year). What if we compound more often?

Start with $100 at 8% annual for 1 year:

• Annual (1×): $100 × 1.08 = $108.00
• Semi-annual (2×): $100 × 1.04² = $108.16
• Quarterly (4×): $100 × 1.02⁴ = $108.24
• Monthly (12×): $100 × (1 + 0.08/12)¹² = $108.30
• Daily (365×): $100 × (1 + 0.08/365)³⁶⁵ = $108.33

Notice the pattern: more frequent compounding means more money, but the gains get smaller each time. There's a ceiling.

For the calculus fans: As compounding becomes continuous, the formula becomes $100 × e^(0.08) = $108.33. The number e (≈ 2.71828) emerges naturally as the limit of (1 + 1/n)ⁿ as n approaches infinity.

Continuous compounding shows up in options pricing (Black-Scholes) and theoretical finance, but daily compounding gets you 99.9% of the way there. For most practical purposes, the difference between daily and continuous is negligible.`
      },
    };

    // ============================================================================
    // GLOSSARY DATA
    // ============================================================================

    const GLOSSARY = {
      statedAnnualRate: {
        term: 'Stated Annual Rate (Quoted Rate)',
        definition: 'The interest rate as quoted, typically on an annual basis. This is what you see advertised or stated in contracts — but it may need to be converted to a periodic rate for calculations.',
      },
      periodicRate: {
        term: 'Periodic Rate',
        definition: 'The interest rate per compounding/payment period. Equals the annual rate divided by the number of periods per year. For semi-annual payments: periodic rate = annual rate ÷ 2.',
      },
      semiAnnual: {
        term: 'Semi-Annual',
        definition: 'Twice per year, or every 6 months. Most U.S. bonds pay coupons semi-annually.',
      },
      compoundingFrequency: {
        term: 'Compounding Frequency',
        definition: 'How often interest is calculated and added to principal. Common frequencies: annual (1×), semi-annual (2×), quarterly (4×), monthly (12×), daily (365×).',
      },
      matchingPrinciple: {
        term: 'Matching Principle (for rates)',
        definition: 'The requirement that the time unit of your discount rate must match the time unit of your cash flow periods. Semi-annual cash flows require a semi-annual rate.',
      },
      couponRate: {
        term: 'Coupon Rate',
        definition: 'The percentage stated on a bond that determines the size of coupon payments. This is NOT the interest rate — it is contractual language describing promised cash flows.',
      },
      faceValue: {
        term: 'Face Value (Par)',
        definition: 'The amount a bond pays at maturity; the base for calculating coupon payments. Typically $100 or $1,000.',
      },
    };

    // ============================================================================
    // SOUND SYSTEM
    // ============================================================================

    const playSound = (type) => {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);

        switch (type) {
          case 'success':
            oscillator.frequency.setValueAtTime(523.25, ctx.currentTime);
            oscillator.frequency.setValueAtTime(659.25, ctx.currentTime + 0.1);
            oscillator.frequency.setValueAtTime(783.99, ctx.currentTime + 0.2);
            gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.4);
            break;

          case 'softNope':
            oscillator.frequency.setValueAtTime(783.99, ctx.currentTime);
            oscillator.frequency.setValueAtTime(659.25, ctx.currentTime + 0.15);
            gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.3);
            break;

          case 'click':
            oscillator.frequency.setValueAtTime(600, ctx.currentTime);
            gainNode.gain.setValueAtTime(0.15, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.08);
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.08);
            break;

          case 'rabbitHole':
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(880, ctx.currentTime);
            oscillator.frequency.setValueAtTime(932.33, ctx.currentTime + 0.05);
            oscillator.frequency.setValueAtTime(880, ctx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.25);
            break;

          case 'insight':
            oscillator.type = 'sine';
            [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
              oscillator.frequency.setValueAtTime(freq, ctx.currentTime + i * 0.12);
            });
            gainNode.gain.setValueAtTime(0.25, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.6);
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.6);
            break;

          default:
            break;
        }

        setTimeout(() => ctx.close(), 700);
      } catch (e) {
        // Fail silently
      }
    };

    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================

    const formatCurrency = (value) => {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      }).format(value);
    };

    const formatPercent = (value, decimals = 0) => {
      return `${(value * 100).toFixed(decimals)}%`;
    };

    const parseUserInput = (input) => {
      const cleaned = input.replace(/[$,%\s]/g, '');
      return parseFloat(cleaned);
    };

    const checkAnswer = (userValue, correctValue, tolerance) => {
      return Math.abs(userValue - correctValue) <= tolerance;
    };

    const calculateProgress = (currentPartIndex, currentStep) => {
      if (currentPartIndex === PARTS.length - 1) {
        return 100;
      }
      const totalSteps = PARTS.reduce((sum, p) => sum + p.steps, 0);
      const completedSteps = PARTS.slice(0, currentPartIndex).reduce((sum, p) => sum + p.steps, 0) + currentStep;
      return Math.round((completedSteps / totalSteps) * 100);
    };

    // ============================================================================
    // UI COMPONENTS
    // ============================================================================

    // --- Header Component ---
    const Header = ({
      currentPartIndex,
      currentStep,
      exploredRabbitHoles,
      totalRabbitHoles,
      onGlossaryClick,
      onRestartClick,
      onHeaderClick,
      soundEnabled,
      onSoundToggle
    }) => {
      const progress = calculateProgress(currentPartIndex, currentStep);
      const currentPart = PARTS[currentPartIndex];

      return (
        <header style={{
          background: COLORS.primary,
          color: 'white',
          padding: '16px 24px',
          position: 'sticky',
          top: 0,
          zIndex: 100,
        }}>
          <div style={{ maxWidth: '800px', margin: '0 auto' }}>
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              marginBottom: '12px',
            }}>
              <h1
                onClick={onHeaderClick}
                style={{
                  fontSize: '18px',
                  fontWeight: '600',
                  margin: 0,
                  cursor: 'default',
                  userSelect: 'none',
                }}
              >
                Matching Time Periods & Interest Rates
              </h1>

              <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                <button
                  onClick={onSoundToggle}
                  style={{
                    background: 'rgba(255,255,255,0.1)',
                    border: 'none',
                    borderRadius: '6px',
                    padding: '6px',
                    cursor: 'pointer',
                    color: 'white',
                    display: 'flex',
                    alignItems: 'center',
                  }}
                  title={soundEnabled ? 'Mute sounds' : 'Enable sounds'}
                >
                  {soundEnabled ? <LucideIcon name="Volume2" size={18} /> : <LucideIcon name="VolumeX" size={18} />}
                </button>

                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '4px',
                  background: COLORS.rabbitHoleLight,
                  color: COLORS.rabbitHole,
                  padding: '4px 10px',
                  borderRadius: '12px',
                  fontSize: '13px',
                  fontWeight: '500',
                }}>
                  <LucideIcon name="Rabbit" size={14} />
                  {exploredRabbitHoles.length}/{totalRabbitHoles}
                </div>

                <button
                  onClick={onGlossaryClick}
                  style={{
                    background: 'rgba(255,255,255,0.1)',
                    border: 'none',
                    borderRadius: '6px',
                    padding: '6px 10px',
                    cursor: 'pointer',
                    color: 'white',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '4px',
                    fontSize: '13px',
                  }}
                >
                  <LucideIcon name="BookOpen" size={16} />
                  Glossary
                </button>

                <button
                  onClick={onRestartClick}
                  style={{
                    background: 'rgba(255,255,255,0.1)',
                    border: 'none',
                    borderRadius: '6px',
                    padding: '6px',
                    cursor: 'pointer',
                    color: 'white',
                    display: 'flex',
                    alignItems: 'center',
                  }}
                  title="Restart tutorial"
                >
                  <LucideIcon name="RotateCcw" size={18} />
                </button>
              </div>
            </div>

            <div>
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                fontSize: '13px',
                marginBottom: '6px',
                opacity: 0.9,
              }}>
                <span>Part {currentPartIndex + 1}: {currentPart.title}</span>
                <span>{progress}% complete</span>
              </div>

              <div style={{
                background: 'rgba(255,255,255,0.2)',
                borderRadius: '4px',
                height: '6px',
                overflow: 'hidden',
              }}>
                <div style={{
                  background: COLORS.goldBorder,
                  height: '100%',
                  width: `${progress}%`,
                  transition: 'width 0.3s ease',
                  borderRadius: '4px',
                }} />
              </div>
            </div>
          </div>
        </header>
      );
    };

    // --- Navigation Buttons ---
    const NavButtons = ({
      onBack,
      onContinue,
      canGoBack,
      canContinue,
      continueLabel = 'Continue',
      soundEnabled
    }) => {
      const handleContinue = () => {
        if (soundEnabled) playSound('click');
        onContinue();
      };

      const handleBack = () => {
        if (soundEnabled) playSound('click');
        onBack();
      };

      return (
        <div style={{
          display: 'flex',
          justifyContent: 'space-between',
          marginTop: '32px',
          paddingTop: '24px',
          borderTop: `1px solid ${COLORS.border}`,
        }}>
          <button
            onClick={handleBack}
            disabled={!canGoBack}
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: '6px',
              padding: '10px 20px',
              border: `1px solid ${COLORS.border}`,
              borderRadius: '8px',
              background: 'white',
              color: canGoBack ? COLORS.textPrimary : COLORS.textMuted,
              cursor: canGoBack ? 'pointer' : 'not-allowed',
              fontSize: '15px',
              opacity: canGoBack ? 1 : 0.5,
            }}
          >
            <LucideIcon name="ChevronLeft" size={18} />
            Back
          </button>

          <button
            onClick={handleContinue}
            disabled={!canContinue}
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: '6px',
              padding: '10px 24px',
              border: 'none',
              borderRadius: '8px',
              background: canContinue ? COLORS.primary : COLORS.textMuted,
              color: 'white',
              cursor: canContinue ? 'pointer' : 'not-allowed',
              fontSize: '15px',
              fontWeight: '500',
            }}
          >
            {continueLabel}
            <LucideIcon name="ChevronRight" size={18} />
          </button>
        </div>
      );
    };

    // --- Calculation Box ---
    const CalculationBox = ({
      prompt,
      correctAnswer,
      hint1,
      hint2,
      onCorrect,
      soundEnabled,
      tolerance = CONSTANTS.TOLERANCE,
      prefix = '$',
      inputKey
    }) => {
      const [input, setInput] = useState('');
      const [attempts, setAttempts] = useState(0);
      const [isCorrect, setIsCorrect] = useState(false);
      const [showHint, setShowHint] = useState(null);

      const handleCheck = () => {
        const userValue = parseUserInput(input);

        if (isNaN(userValue)) {
          setShowHint('Please enter a valid number');
          return;
        }

        if (checkAnswer(userValue, correctAnswer, tolerance)) {
          setIsCorrect(true);
          if (soundEnabled) playSound('success');
          onCorrect?.();
        } else {
          const newAttempts = attempts + 1;
          setAttempts(newAttempts);
          if (soundEnabled) playSound('softNope');

          if (newAttempts >= 3) {
            const displayAnswer = prefix === '%'
              ? `${correctAnswer}%`
              : formatCurrency(correctAnswer);
            setShowHint(`The answer is ${displayAnswer}`);
            setIsCorrect(true);
            onCorrect?.();
          } else if (newAttempts === 2 && hint2) {
            setShowHint(hint2);
          } else if (hint1) {
            setShowHint(hint1);
          }
        }
      };

      return (
        <div style={{
          background: COLORS.surfaceAlt,
          border: `1px solid ${COLORS.border}`,
          borderRadius: '12px',
          padding: '20px',
          marginTop: '16px',
        }}>
          <p style={{
            margin: '0 0 16px 0',
            fontSize: '15px',
            color: COLORS.textPrimary,
          }}>
            {prompt}
          </p>

          <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
            <div style={{ position: 'relative', flex: 1 }}>
              <span style={{
                position: 'absolute',
                left: '12px',
                top: '50%',
                transform: 'translateY(-50%)',
                color: COLORS.textMuted,
              }}>{prefix}</span>
              <input
                type="text"
                value={input}
                onChange={(e) => setInput(e.target.value)}
                disabled={isCorrect}
                placeholder="0.00"
                style={{
                  width: '100%',
                  padding: '12px 12px 12px 28px',
                  border: `2px solid ${isCorrect ? COLORS.successBorder : COLORS.border}`,
                  borderRadius: '8px',
                  fontSize: '16px',
                  fontFamily: 'monospace',
                  background: isCorrect ? COLORS.successBg : 'white',
                  boxSizing: 'border-box',
                }}
                onKeyDown={(e) => e.key === 'Enter' && !isCorrect && handleCheck()}
              />
            </div>

            <button
              onClick={handleCheck}
              disabled={isCorrect || !input}
              style={{
                padding: '12px 20px',
                border: 'none',
                borderRadius: '8px',
                background: isCorrect ? COLORS.success : COLORS.primary,
                color: 'white',
                fontSize: '15px',
                fontWeight: '500',
                cursor: isCorrect || !input ? 'default' : 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: '6px',
              }}
            >
              {isCorrect ? <LucideIcon name="Check" size={18} /> : 'Check'}
            </button>
          </div>

          {showHint && (
            <p style={{
              marginTop: '12px',
              padding: '10px 12px',
              background: isCorrect && attempts >= 3 ? COLORS.warningBg : COLORS.accentLight,
              borderRadius: '6px',
              fontSize: '14px',
              color: isCorrect && attempts >= 3 ? COLORS.warning : COLORS.accent,
            }}>
              {showHint}
            </p>
          )}
        </div>
      );
    };

    // --- Insight Box ---
    const InsightBox = ({ children, icon }) => (
      <div style={{
        background: COLORS.goldLight,
        border: `2px solid ${COLORS.goldBorder}`,
        borderRadius: '12px',
        padding: '20px',
        marginTop: '20px',
        marginBottom: '20px',
      }}>
        <div style={{
          display: 'flex',
          gap: '12px',
          alignItems: 'flex-start',
        }}>
          {icon || <LucideIcon name="Check" size={24} color={COLORS.gold} style={{ flexShrink: 0, marginTop: '2px' }} />}
          <div style={{
            fontSize: '16px',
            lineHeight: '1.6',
            color: COLORS.textPrimary,
          }}>
            {children}
          </div>
        </div>
      </div>
    );

    // --- Warning Box ---
    const WarningBox = ({ children }) => (
      <div style={{
        background: COLORS.errorBg,
        border: `2px solid ${COLORS.error}`,
        borderRadius: '12px',
        padding: '20px',
        marginTop: '20px',
        marginBottom: '20px',
      }}>
        <div style={{
          display: 'flex',
          gap: '12px',
          alignItems: 'flex-start',
        }}>
          <LucideIcon name="AlertTriangle" size={24} color={COLORS.error} style={{ flexShrink: 0, marginTop: '2px' }} />
          <div style={{
            fontSize: '16px',
            lineHeight: '1.6',
            color: COLORS.textPrimary,
          }}>
            {children}
          </div>
        </div>
      </div>
    );

    // --- Rate Conversion Visual ---
    const RateConversionVisual = ({ annualRate, periodsPerYear }) => {
      const periodicRate = annualRate / periodsPerYear;

      return (
        <div style={{
          background: COLORS.surfaceAlt,
          borderRadius: '12px',
          padding: '24px',
          marginTop: '16px',
          marginBottom: '16px',
        }}>
          {/* Annual rate bar */}
          <div style={{ marginBottom: '20px' }}>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              marginBottom: '8px',
            }}>
              <LucideIcon name="Calendar" size={18} color={COLORS.textSecondary} />
              <span style={{ marginLeft: '8px', color: COLORS.textSecondary, fontSize: '14px' }}>
                1 Year
              </span>
            </div>
            <div style={{
              background: COLORS.primary,
              borderRadius: '8px',
              padding: '16px',
              textAlign: 'center',
              color: 'white',
            }}>
              <span style={{ fontSize: '20px', fontWeight: '600' }}>
                {formatPercent(annualRate)} per year
              </span>
            </div>
          </div>

          {/* Arrow */}
          <div style={{
            textAlign: 'center',
            margin: '16px 0',
            color: COLORS.textSecondary,
          }}>
            <div style={{ fontSize: '14px', marginBottom: '4px' }}>
              ÷ {periodsPerYear}
            </div>
            <LucideIcon name="ChevronRight" size={24} style={{ transform: 'rotate(90deg)' }} />
          </div>

          {/* Split into periods */}
          <div>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              marginBottom: '8px',
            }}>
              <LucideIcon name="Clock" size={18} color={COLORS.textSecondary} />
              <span style={{ marginLeft: '8px', color: COLORS.textSecondary, fontSize: '14px' }}>
                {periodsPerYear} periods of 6 months each
              </span>
            </div>
            <div style={{ display: 'flex', gap: '8px' }}>
              {Array.from({ length: periodsPerYear }, (_, i) => (
                <div key={i} style={{
                  flex: 1,
                  background: COLORS.accent,
                  borderRadius: '8px',
                  padding: '16px 8px',
                  textAlign: 'center',
                  color: 'white',
                }}>
                  <span style={{ fontSize: '18px', fontWeight: '600' }}>
                    {formatPercent(periodicRate)}
                  </span>
                  <div style={{ fontSize: '12px', opacity: 0.9, marginTop: '4px' }}>
                    per 6 months
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // --- Semi-Annual Bond Timeline ---
    const BondTimeline = ({
      periods,
      couponPayment,
      faceValue,
      periodicRate,
      showCashFlows = true,
      showPV = false,
      pvValue = null,
      highlightMismatch = false
    }) => {
      const cashFlows = Array.from({ length: periods }, (_, i) =>
        i === periods - 1 ? couponPayment + faceValue : couponPayment
      );

      return (
        <div style={{
          background: COLORS.surfaceAlt,
          borderRadius: '12px',
          padding: '24px',
          marginTop: '16px',
          marginBottom: '16px',
          overflowX: 'auto',
        }}>
          {/* Year labels */}
          <div style={{
            display: 'flex',
            justifyContent: 'space-between',
            marginBottom: '8px',
            paddingLeft: '40px',
            paddingRight: '40px',
          }}>
            {[0, 1, 2, 3].map(year => (
              <span key={year} style={{
                fontSize: '12px',
                color: COLORS.textMuted,
                width: year === 3 ? 'auto' : '0',
                textAlign: 'center',
              }}>
                Year {year}
              </span>
            ))}
          </div>

          {/* Timeline with cash flows */}
          <div style={{
            display: 'flex',
            alignItems: 'flex-end',
            position: 'relative',
            minHeight: '140px',
            paddingBottom: '40px',
          }}>
            {/* Timeline line */}
            <div style={{
              position: 'absolute',
              bottom: '20px',
              left: '20px',
              right: '20px',
              height: '3px',
              background: COLORS.borderDark,
            }} />

            {/* Time points */}
            {Array.from({ length: periods + 1 }, (_, i) => {
              const cashFlow = i > 0 ? cashFlows[i - 1] : null;
              const isLast = i === periods;

              return (
                <div key={i} style={{
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  position: 'relative',
                  flex: 1,
                }}>
                  {/* Cash flow box */}
                  {showCashFlows && cashFlow !== null && (
                    <>
                      <div style={{
                        background: isLast ? COLORS.gold : COLORS.primary,
                        color: 'white',
                        borderRadius: '8px',
                        padding: '8px 6px',
                        marginBottom: '8px',
                        fontFamily: 'monospace',
                        fontSize: '13px',
                        fontWeight: '600',
                        textAlign: 'center',
                        minWidth: '50px',
                      }}>
                        {formatCurrency(cashFlow)}
                      </div>
                      <div style={{
                        width: '2px',
                        height: '16px',
                        background: isLast ? COLORS.gold : COLORS.primary,
                      }} />
                    </>
                  )}

                  {/* Time point dot */}
                  <div style={{
                    width: '12px',
                    height: '12px',
                    borderRadius: '50%',
                    background: i === 0 ? COLORS.accent : (cashFlow ? COLORS.primary : COLORS.border),
                    position: 'absolute',
                    bottom: '14px',
                    border: highlightMismatch && i > 0 ? `2px solid ${COLORS.error}` : 'none',
                  }} />

                  {/* Time label */}
                  <span style={{
                    position: 'absolute',
                    bottom: '-8px',
                    fontSize: '11px',
                    color: COLORS.textSecondary,
                    whiteSpace: 'nowrap',
                  }}>
                    Time {i}
                  </span>
                </div>
              );
            })}
          </div>

          {/* Period rate indicator */}
          {periodicRate && (
            <div style={{
              display: 'flex',
              justifyContent: 'center',
              gap: '4px',
              marginTop: '8px',
              flexWrap: 'wrap',
            }}>
              <span style={{ fontSize: '13px', color: COLORS.textSecondary }}>
                Discount rate per period:
              </span>
              <span style={{
                fontSize: '13px',
                fontWeight: '600',
                color: highlightMismatch ? COLORS.error : COLORS.accent,
              }}>
                {formatPercent(periodicRate)}
              </span>
            </div>
          )}

          {/* PV display */}
          {showPV && pvValue !== null && (
            <div style={{
              marginTop: '16px',
              paddingTop: '16px',
              borderTop: `1px solid ${COLORS.border}`,
              textAlign: 'center',
            }}>
              <span style={{ color: COLORS.textSecondary, fontSize: '14px' }}>
                Present Value =
              </span>
              <span style={{
                marginLeft: '8px',
                fontFamily: 'monospace',
                fontSize: '20px',
                fontWeight: '600',
                color: COLORS.gold,
              }}>
                {formatCurrency(pvValue)}
              </span>
            </div>
          )}
        </div>
      );
    };

    // --- Mistake Comparison Visual ---
    const MistakeComparisonVisual = ({ correctPV, wrongPV, correctRate, wrongRate }) => (
      <div style={{
        display: 'grid',
        gridTemplateColumns: '1fr 1fr',
        gap: '16px',
        marginTop: '16px',
        marginBottom: '16px',
      }}>
        {/* Wrong way */}
        <div style={{
          background: COLORS.errorBg,
          border: `2px solid ${COLORS.error}`,
          borderRadius: '12px',
          padding: '20px',
          textAlign: 'center',
        }}>
          <div style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '8px',
            marginBottom: '12px',
          }}>
            <LucideIcon name="X" size={20} color={COLORS.error} />
            <span style={{ fontWeight: '600', color: COLORS.error }}>Wrong</span>
          </div>
          <div style={{ fontSize: '14px', color: COLORS.textSecondary, marginBottom: '8px' }}>
            Using {formatPercent(wrongRate)} per period
          </div>
          <div style={{
            fontFamily: 'monospace',
            fontSize: '24px',
            fontWeight: '700',
            color: COLORS.error,
          }}>
            {formatCurrency(wrongPV)}
          </div>
        </div>

        {/* Correct way */}
        <div style={{
          background: COLORS.successBg,
          border: `2px solid ${COLORS.success}`,
          borderRadius: '12px',
          padding: '20px',
          textAlign: 'center',
        }}>
          <div style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '8px',
            marginBottom: '12px',
          }}>
            <LucideIcon name="Check" size={20} color={COLORS.success} />
            <span style={{ fontWeight: '600', color: COLORS.success }}>Correct</span>
          </div>
          <div style={{ fontSize: '14px', color: COLORS.textSecondary, marginBottom: '8px' }}>
            Using {formatPercent(correctRate)} per period
          </div>
          <div style={{
            fontFamily: 'monospace',
            fontSize: '24px',
            fontWeight: '700',
            color: COLORS.success,
          }}>
            {formatCurrency(correctPV)}
          </div>
        </div>
      </div>
    );

    // --- Rabbit Hole Button ---
    const RabbitHoleButton = ({ rabbitHole, explored, onClick, soundEnabled }) => {
      const handleClick = () => {
        if (soundEnabled) playSound('rabbitHole');
        onClick();
      };

      return (
        <button
          onClick={handleClick}
          style={{
            display: 'flex',
            alignItems: 'center',
            gap: '10px',
            width: '100%',
            padding: '14px 16px',
            border: `2px dashed ${COLORS.rabbitHoleBorder}`,
            borderRadius: '10px',
            background: explored ? COLORS.rabbitHoleLight : 'white',
            color: COLORS.rabbitHole,
            cursor: 'pointer',
            fontSize: '14px',
            textAlign: 'left',
            marginTop: '16px',
            transition: 'all 0.2s ease',
          }}
        >
          <LucideIcon name="Rabbit" size={20} style={{ flexShrink: 0 }} />
          <span style={{ flex: 1 }}>{rabbitHole.title}</span>
          {explored && <LucideIcon name="Check" size={18} />}
        </button>
      );
    };

    // --- Rabbit Hole Modal ---
    const RabbitHoleModal = ({ rabbitHole, onClose }) => {
      if (!rabbitHole) return null;

      return (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'rgba(0,0,0,0.5)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '20px',
          zIndex: 1000,
        }}>
          <div style={{
            background: 'white',
            borderRadius: '16px',
            maxWidth: '600px',
            maxHeight: '80vh',
            overflow: 'auto',
            boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
          }}>
            <div style={{
              background: COLORS.rabbitHole,
              color: 'white',
              padding: '20px 24px',
              display: 'flex',
              alignItems: 'center',
              gap: '12px',
            }}>
              <LucideIcon name="Rabbit" size={24} />
              <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600' }}>
                {rabbitHole.title}
              </h2>
            </div>

            <div style={{
              padding: '24px',
              fontSize: '15px',
              lineHeight: '1.7',
              color: COLORS.textPrimary,
            }}>
              {rabbitHole.content.split('\n\n').map((paragraph, i) => (
                <p key={i} style={{ margin: i === 0 ? 0 : '16px 0 0 0' }}>
                  {paragraph}
                </p>
              ))}
            </div>

            <div style={{
              padding: '16px 24px',
              borderTop: `1px solid ${COLORS.border}`,
              display: 'flex',
              justifyContent: 'flex-end',
            }}>
              <button
                onClick={onClose}
                style={{
                  padding: '10px 24px',
                  border: 'none',
                  borderRadius: '8px',
                  background: COLORS.rabbitHole,
                  color: 'white',
                  fontSize: '15px',
                  fontWeight: '500',
                  cursor: 'pointer',
                }}
              >
                Back to Tutorial
              </button>
            </div>
          </div>
        </div>
      );
    };

    // --- Glossary Modal ---
    const GlossaryModal = ({ onClose }) => (
      <div style={{
        position: 'fixed',
        inset: 0,
        background: 'rgba(0,0,0,0.5)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '20px',
        zIndex: 1000,
      }}>
        <div style={{
          background: 'white',
          borderRadius: '16px',
          maxWidth: '600px',
          maxHeight: '80vh',
          overflow: 'auto',
          boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
        }}>
          <div style={{
            background: COLORS.primary,
            color: 'white',
            padding: '20px 24px',
            display: 'flex',
            alignItems: 'center',
            gap: '12px',
          }}>
            <LucideIcon name="BookOpen" size={24} />
            <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600' }}>
              Glossary
            </h2>
          </div>

          <div style={{ padding: '16px 24px' }}>
            {Object.values(GLOSSARY).map((item, i) => (
              <div key={item.term} style={{
                padding: '16px 0',
                borderBottom: i < Object.values(GLOSSARY).length - 1 ? `1px solid ${COLORS.border}` : 'none',
              }}>
                <h3 style={{
                  margin: '0 0 6px 0',
                  fontSize: '16px',
                  fontWeight: '600',
                  color: COLORS.primary,
                }}>
                  {item.term}
                </h3>
                <p style={{
                  margin: 0,
                  fontSize: '14px',
                  lineHeight: '1.5',
                  color: COLORS.textSecondary,
                }}>
                  {item.definition}
                </p>
              </div>
            ))}
          </div>

          <div style={{
            padding: '16px 24px',
            borderTop: `1px solid ${COLORS.border}`,
            display: 'flex',
            justifyContent: 'flex-end',
          }}>
            <button
              onClick={onClose}
              style={{
                padding: '10px 24px',
                border: 'none',
                borderRadius: '8px',
                background: COLORS.primary,
                color: 'white',
                fontSize: '15px',
                fontWeight: '500',
                cursor: 'pointer',
              }}
            >
              Close
            </button>
          </div>
        </div>
      </div>
    );

    // --- Restart Confirm Modal ---
    const RestartConfirmModal = ({ onConfirm, onCancel }) => (
      <div style={{
        position: 'fixed',
        inset: 0,
        background: 'rgba(0,0,0,0.5)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '20px',
        zIndex: 1000,
      }}>
        <div style={{
          background: 'white',
          borderRadius: '16px',
          maxWidth: '400px',
          padding: '24px',
          boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
        }}>
          <h3 style={{
            margin: '0 0 12px 0',
            fontSize: '18px',
            color: COLORS.textPrimary,
          }}>
            Restart Tutorial?
          </h3>
          <p style={{
            margin: '0 0 24px 0',
            fontSize: '15px',
            color: COLORS.textSecondary,
            lineHeight: '1.5',
          }}>
            All progress will be lost. Are you sure you want to restart?
          </p>
          <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
            <button
              onClick={onCancel}
              style={{
                padding: '10px 20px',
                border: `1px solid ${COLORS.border}`,
                borderRadius: '8px',
                background: 'white',
                color: COLORS.textPrimary,
                fontSize: '15px',
                cursor: 'pointer',
              }}
            >
              Cancel
            </button>
            <button
              onClick={onConfirm}
              style={{
                padding: '10px 20px',
                border: 'none',
                borderRadius: '8px',
                background: COLORS.error,
                color: 'white',
                fontSize: '15px',
                fontWeight: '500',
                cursor: 'pointer',
              }}
            >
              Restart
            </button>
          </div>
        </div>
      </div>
    );

    // --- Dev Mode Panel ---
    const DevModePanel = ({ onJumpToPart, currentPartIndex, onClose }) => (
      <div style={{
        position: 'fixed',
        bottom: '20px',
        right: '20px',
        background: 'white',
        borderRadius: '12px',
        boxShadow: '0 4px 20px rgba(0,0,0,0.15)',
        padding: '16px',
        zIndex: 500,
        maxWidth: '250px',
      }}>
        <div style={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '12px',
        }}>
          <span style={{ fontWeight: '600', fontSize: '14px', color: COLORS.primary }}>
            Dev Mode
          </span>
          <button
            onClick={onClose}
            style={{
              background: 'none',
              border: 'none',
              cursor: 'pointer',
              padding: '4px',
            }}
          >
            <LucideIcon name="X" size={16} color={COLORS.textMuted} />
          </button>
        </div>
        <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
          {PARTS.map((part, i) => (
            <button
              key={part.id}
              onClick={() => onJumpToPart(i)}
              style={{
                padding: '8px 12px',
                border: 'none',
                borderRadius: '6px',
                background: i === currentPartIndex ? COLORS.primary : COLORS.surfaceAlt,
                color: i === currentPartIndex ? 'white' : COLORS.textPrimary,
                fontSize: '13px',
                cursor: 'pointer',
                textAlign: 'left',
              }}
            >
              {i + 1}. {part.title}
            </button>
          ))}
        </div>
      </div>
    );

    // ============================================================================
    // PART RENDERERS
    // ============================================================================

    // --- Part 0: The Problem ---
    const Part0TheProblem = ({ step, completed, onComplete, soundEnabled, onRabbitHole, exploredRabbitHoles }) => {
      if (step === 0) {
        return (
          <>
            <h2 style={{ color: COLORS.primary, marginTop: 0 }}>A Real Bond Quote</h2>

            <div style={{
              background: COLORS.surfaceAlt,
              border: `2px solid ${COLORS.border}`,
              borderRadius: '12px',
              padding: '20px',
              marginBottom: '20px',
              fontFamily: 'Georgia, serif',
            }}>
              <p style={{ margin: 0, fontSize: '17px', lineHeight: '1.6' }}>
                <strong>3-Year Treasury Bond</strong><br />
                Face Value: $100<br />
                Coupon Rate: 6%<br />
                <span style={{ color: COLORS.accent, fontWeight: '600' }}>Semi-annual payments</span><br />
                Priced to yield 8%
              </p>
            </div>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              This looks like the bonds we've been working with, but there's something new:
              <strong> semi-annual payments</strong>.
            </p>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              Instead of paying once a year, this bond pays every 6 months. What does that change?
            </p>
          </>
        );
      }

      if (step === 1) {
        return (
          <>
            <h2 style={{ color: COLORS.primary, marginTop: 0 }}>The Mismatch</h2>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              Here's the problem:
            </p>

            <div style={{
              display: 'grid',
              gridTemplateColumns: '1fr 1fr',
              gap: '16px',
              marginTop: '16px',
              marginBottom: '20px',
            }}>
              <div style={{
                background: COLORS.accentLight,
                borderRadius: '12px',
                padding: '20px',
                textAlign: 'center',
              }}>
                <LucideIcon name="Clock" size={32} color={COLORS.accent} style={{ marginBottom: '8px' }} />
                <div style={{ fontWeight: '600', color: COLORS.accent, marginBottom: '4px' }}>
                  Cash Flows
                </div>
                <div style={{ fontSize: '15px', color: COLORS.textSecondary }}>
                  Every 6 months
                </div>
              </div>

              <div style={{
                background: COLORS.goldLight,
                borderRadius: '12px',
                padding: '20px',
                textAlign: 'center',
              }}>
                <LucideIcon name="Percent" size={32} color={COLORS.gold} style={{ marginBottom: '8px' }} />
                <div style={{ fontWeight: '600', color: COLORS.gold, marginBottom: '4px' }}>
                  Interest Rate
                </div>
                <div style={{ fontSize: '15px', color: COLORS.textSecondary }}>
                  Quoted annually (8%)
                </div>
              </div>
            </div>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              The cash flows arrive every 6 months, but the interest rate is quoted as an annual rate.
            </p>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              <strong>We need to reconcile these.</strong> If we just plug 8% into our discounting formula,
              we'll get the wrong answer. This mismatch trips up a lot of people.
            </p>
          </>
        );
      }

      return null;
    };

    // --- Part 1: The Matching Principle ---
    const Part1MatchingPrinciple = ({ step, completed, onComplete, soundEnabled }) => {
      if (step === 0) {
        return (
          <>
            <h2 style={{ color: COLORS.primary, marginTop: 0 }}>The Core Rule</h2>

            <InsightBox>
              <strong>The Matching Principle:</strong> The time unit of your interest rate must match
              the time unit of your periods.
            </InsightBox>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              Think of it like unit conversion. You can't divide miles by hours if one measurement
              is in kilometers — the units have to match.
            </p>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              Similarly, if your cash flows arrive every 6 months, you need a <strong>6-month interest rate</strong>,
              not an annual rate.
            </p>

            <div style={{
              background: COLORS.surfaceAlt,
              borderRadius: '12px',
              padding: '20px',
              marginTop: '20px',
            }}>
              <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '15px' }}>
                <thead>
                  <tr>
                    <th style={{ textAlign: 'left', padding: '8px', borderBottom: `2px solid ${COLORS.border}` }}>
                      Cash Flow Frequency
                    </th>
                    <th style={{ textAlign: 'left', padding: '8px', borderBottom: `2px solid ${COLORS.border}` }}>
                      Rate You Need
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style={{ padding: '8px', borderBottom: `1px solid ${COLORS.border}` }}>Annual</td>
                    <td style={{ padding: '8px', borderBottom: `1px solid ${COLORS.border}` }}>Annual rate</td>
                  </tr>
                  <tr>
                    <td style={{ padding: '8px', borderBottom: `1px solid ${COLORS.border}` }}>Semi-annual (every 6 months)</td>
                    <td style={{ padding: '8px', borderBottom: `1px solid ${COLORS.border}` }}>Semi-annual rate</td>
                  </tr>
                  <tr>
                    <td style={{ padding: '8px', borderBottom: `1px solid ${COLORS.border}` }}>Quarterly</td>
                    <td style={{ padding: '8px', borderBottom: `1px solid ${COLORS.border}` }}>Quarterly rate</td>
                  </tr>
                  <tr>
                    <td style={{ padding: '8px' }}>Monthly</td>
                    <td style={{ padding: '8px' }}>Monthly rate</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </>
        );
      }

      if (step === 1) {
        return (
          <>
            <h2 style={{ color: COLORS.primary, marginTop: 0 }}>For Our Bond</h2>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              Our bond pays coupons every 6 months (semi-annually).
            </p>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              That means we need a <strong>semi-annual interest rate</strong> — a rate that tells us
              how much $1 grows in 6 months, not in a year.
            </p>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              The market quotes 8% as an annual rate. We need to convert it.
            </p>

            <div style={{
              background: COLORS.accentLight,
              borderRadius: '12px',
              padding: '20px',
              marginTop: '20px',
              textAlign: 'center',
            }}>
              <div style={{ fontSize: '15px', color: COLORS.textSecondary, marginBottom: '8px' }}>
                What we have:
              </div>
              <div style={{ fontSize: '24px', fontWeight: '600', color: COLORS.accent }}>
                8% per year
              </div>
              <div style={{ margin: '16px 0', color: COLORS.textMuted }}>
                ↓
              </div>
              <div style={{ fontSize: '15px', color: COLORS.textSecondary, marginBottom: '8px' }}>
                What we need:
              </div>
              <div style={{ fontSize: '24px', fontWeight: '600', color: COLORS.primary }}>
                ? % per 6 months
              </div>
            </div>
          </>
        );
      }

      return null;
    };

    // --- Part 2: Converting the Rate ---
    const Part2ConvertingRate = ({ step, completed, onComplete, soundEnabled, onRabbitHole, exploredRabbitHoles }) => {
      if (step === 0) {
        return (
          <>
            <h2 style={{ color: COLORS.primary, marginTop: 0 }}>The Conversion</h2>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              The standard bond market convention is simple:
            </p>

            <div style={{
              background: COLORS.goldLight,
              border: `2px solid ${COLORS.goldBorder}`,
              borderRadius: '12px',
              padding: '20px',
              marginTop: '16px',
              marginBottom: '20px',
              textAlign: 'center',
            }}>
              <div style={{ fontSize: '18px', fontWeight: '600', color: COLORS.textPrimary }}>
                Periodic Rate = Annual Rate ÷ Periods per Year
              </div>
            </div>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              For our bond with semi-annual payments:
            </p>

            <RateConversionVisual
              annualRate={CONSTANTS.ANNUAL_INTEREST_RATE}
              periodsPerYear={CONSTANTS.PAYMENTS_PER_YEAR}
            />

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              So our 8% annual rate becomes <strong>4% per 6-month period</strong>.
            </p>

            <RabbitHoleButton
              rabbitHole={RABBIT_HOLES.simpleInterest}
              explored={exploredRabbitHoles.includes('simpleInterest')}
              onClick={() => onRabbitHole('simpleInterest')}
              soundEnabled={soundEnabled}
            />

            <RabbitHoleButton
              rabbitHole={RABBIT_HOLES.moreFrequentCompounding}
              explored={exploredRabbitHoles.includes('moreFrequentCompounding')}
              onClick={() => onRabbitHole('moreFrequentCompounding')}
              soundEnabled={soundEnabled}
            />
          </>
        );
      }

      if (step === 1) {
        return (
          <>
            <h2 style={{ color: COLORS.primary, marginTop: 0 }}>Your Turn</h2>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              A different bond has an annual interest rate of 6% and pays coupons semi-annually.
            </p>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              What's the periodic (semi-annual) rate?
            </p>

            <CalculationBox
              key="periodic-rate-calc"
              prompt="6% annual ÷ 2 = ?"
              correctAnswer={3}
              hint1="Divide the annual rate by the number of periods per year"
              hint2="6 ÷ 2 = ?"
              onCorrect={() => onComplete('periodicRateCalc')}
              soundEnabled={soundEnabled}
              tolerance={0.1}
              prefix="%"
            />
          </>
        );
      }

      return null;
    };

    // --- Part 3: Counting Periods and Payments ---
    const Part3CountingPeriods = ({ step, completed, onComplete, soundEnabled, onRabbitHole, exploredRabbitHoles }) => {
      if (step === 0) {
        return (
          <>
            <h2 style={{ color: COLORS.primary, marginTop: 0 }}>Counting Periods</h2>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              A 3-year bond with semi-annual payments doesn't have 3 periods — it has <strong>6 periods</strong>.
            </p>

            <div style={{
              background: COLORS.goldLight,
              border: `2px solid ${COLORS.goldBorder}`,
              borderRadius: '12px',
              padding: '20px',
              marginTop: '16px',
              marginBottom: '20px',
              textAlign: 'center',
            }}>
              <div style={{ fontSize: '18px', fontWeight: '600', color: COLORS.textPrimary }}>
                Number of Periods = Years × Payments per Year
              </div>
              <div style={{ fontSize: '16px', marginTop: '12px', color: COLORS.textSecondary }}>
                3 years × 2 payments/year = 6 periods
              </div>
            </div>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              Similarly, a 10-year bond with semi-annual payments would have 20 periods.
            </p>

            <BondTimeline
              periods={6}
              couponPayment={3}
              faceValue={100}
              periodicRate={0.04}
              showCashFlows={true}
            />

            <p style={{ fontSize: '15px', color: COLORS.textSecondary, fontStyle: 'italic', marginTop: '16px' }}>
              Each period is 6 months. Time 0 is today, Time 6 is 3 years from now.
            </p>

            <RabbitHoleButton
              rabbitHole={RABBIT_HOLES.whySemiAnnual}
              explored={exploredRabbitHoles.includes('whySemiAnnual')}
              onClick={() => onRabbitHole('whySemiAnnual')}
              soundEnabled={soundEnabled}
            />
          </>
        );
      }

      if (step === 1) {
        return (
          <>
            <h2 style={{ color: COLORS.primary, marginTop: 0 }}>Adjusting the Coupon</h2>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              The coupon rate is also quoted annually. A 6% annual coupon on a $100 bond means
              $6 per year — but paid in two installments of $3 every 6 months.
            </p>

            <div style={{
              background: COLORS.surfaceAlt,
              borderRadius: '12px',
              padding: '20px',
              marginTop: '16px',
              marginBottom: '20px',
            }}>
              <div style={{ textAlign: 'center' }}>
                <div style={{ fontSize: '15px', color: COLORS.textSecondary, marginBottom: '8px' }}>
                  Annual coupon: $100 × 6% = $6/year
                </div>
                <div style={{ color: COLORS.textMuted, margin: '8px 0' }}>↓</div>
                <div style={{ fontSize: '15px', color: COLORS.textSecondary }}>
                  Semi-annual coupon: $6 ÷ 2 = <strong style={{ color: COLORS.primary }}>$3 every 6 months</strong>
                </div>
              </div>
            </div>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              Now you try. A $1,000 bond has an 8% annual coupon rate and pays semi-annually.
            </p>

            <CalculationBox
              key="coupon-calc"
              prompt="What is each semi-annual coupon payment? ($1,000 × 8% ÷ 2)"
              correctAnswer={40}
              hint1="First calculate the annual coupon: $1,000 × 8% = $80"
              hint2="Then divide by 2: $80 ÷ 2 = ?"
              onCorrect={() => onComplete('couponCalc')}
              soundEnabled={soundEnabled}
              tolerance={0.50}
            />
          </>
        );
      }

      return null;
    };

    // --- Part 4: Putting It Together ---
    const Part4PuttingTogether = ({ step, completed, onComplete, soundEnabled }) => {
      if (step === 0) {
        return (
          <>
            <h2 style={{ color: COLORS.primary, marginTop: 0 }}>The Full Setup</h2>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              Let's put it all together for our bond:
            </p>

            <div style={{
              background: COLORS.surfaceAlt,
              borderRadius: '12px',
              padding: '20px',
              marginTop: '16px',
              marginBottom: '20px',
            }}>
              <div style={{ marginBottom: '16px' }}>
                <strong style={{ color: COLORS.primary }}>Bond Details:</strong>
                <ul style={{ margin: '8px 0 0 0', paddingLeft: '20px', lineHeight: '1.8' }}>
                  <li>Face value: $100</li>
                  <li>Coupon rate: 6% annual</li>
                  <li>Life: 3 years</li>
                  <li>Payments: Semi-annual</li>
                  <li>Market interest rate: 8% annual</li>
                </ul>
              </div>

              <div style={{ borderTop: `1px solid ${COLORS.border}`, paddingTop: '16px' }}>
                <strong style={{ color: COLORS.primary }}>Converted for Calculation:</strong>
                <ul style={{ margin: '8px 0 0 0', paddingLeft: '20px', lineHeight: '1.8' }}>
                  <li>Number of periods: 6 (= 3 × 2)</li>
                  <li>Periodic rate: 4% (= 8% ÷ 2)</li>
                  <li>Coupon payment: $3 (= $100 × 6% ÷ 2)</li>
                </ul>
              </div>
            </div>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              <strong>The cash flows:</strong>
            </p>

            <div style={{
              background: COLORS.accentLight,
              borderRadius: '12px',
              padding: '16px 20px',
              fontFamily: 'monospace',
              fontSize: '16px',
              textAlign: 'center',
              marginTop: '12px',
            }}>
              $3, $3, $3, $3, $3, $103
            </div>

            <p style={{ fontSize: '14px', color: COLORS.textSecondary, marginTop: '8px', textAlign: 'center' }}>
              (The last payment includes the $100 face value)
            </p>

            <BondTimeline
              periods={6}
              couponPayment={3}
              faceValue={100}
              periodicRate={0.04}
              showCashFlows={true}
            />
          </>
        );
      }

      if (step === 1) {
        return (
          <>
            <h2 style={{ color: COLORS.primary, marginTop: 0 }}>Calculate the Present Value</h2>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              Now discount each cash flow back to today using the <strong>periodic rate of 4%</strong>:
            </p>

            <div style={{
              background: COLORS.surfaceAlt,
              borderRadius: '12px',
              padding: '20px',
              marginTop: '16px',
              marginBottom: '20px',
              fontFamily: 'monospace',
              fontSize: '14px',
              lineHeight: '2',
            }}>
              <div>PV = $3/1.04¹ + $3/1.04² + $3/1.04³ + $3/1.04⁴ + $3/1.04⁵ + $103/1.04⁶</div>
              <div style={{ marginTop: '12px', color: COLORS.textSecondary }}>
                PV = $2.88 + $2.77 + $2.67 + $2.57 + $2.47 + $81.41
              </div>
            </div>

            <CalculationBox
              key="pv-calc"
              prompt="What is the present value of this bond?"
              correctAnswer={CONSTANTS.CORRECT_PV}
              hint1="Add up all the discounted cash flows"
              hint2="$2.88 + $2.77 + $2.67 + $2.57 + $2.47 + $81.41 = ?"
              onCorrect={() => onComplete('pvCalc')}
              soundEnabled={soundEnabled}
              tolerance={CONSTANTS.TOLERANCE_PV}
            />
          </>
        );
      }

      if (step === 2) {
        return (
          <>
            <h2 style={{ color: COLORS.primary, marginTop: 0 }}>The Bond Trades at a Discount</h2>

            <BondTimeline
              periods={6}
              couponPayment={3}
              faceValue={100}
              periodicRate={0.04}
              showCashFlows={true}
              showPV={true}
              pvValue={CONSTANTS.CORRECT_PV}
            />

            <InsightBox>
              <strong>Key Insight:</strong> This bond trades at a discount ($94.77 vs $100 face value)
              because the coupon rate (6%) is less than the market interest rate (8%).
            </InsightBox>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              The semi-annual convention doesn't change this fundamental logic — premium and discount
              bonds work the same way. What matters is whether the coupon rate is above or below
              the market rate.
            </p>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              The key is making sure your rate and your periods <strong>match</strong>.
            </p>
          </>
        );
      }

      return null;
    };

    // --- Part 5: Common Mistakes ---
    const Part5CommonMistakes = ({ step, completed, onComplete, soundEnabled }) => {
      if (step === 0) {
        return (
          <>
            <h2 style={{ color: COLORS.primary, marginTop: 0 }}>Mistake #1: Using the Annual Rate</h2>

            <WarningBox>
              <strong>The most common mistake:</strong> Using the annual rate (8%) to discount
              semi-annual cash flows.
            </WarningBox>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              Watch what happens if you discount at 8% per period instead of 4%:
            </p>

            <MistakeComparisonVisual
              correctPV={CONSTANTS.CORRECT_PV}
              wrongPV={CONSTANTS.WRONG_PV}
              correctRate={0.04}
              wrongRate={0.08}
            />

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              Using the wrong rate gives you <strong>{formatCurrency(CONSTANTS.WRONG_PV)}</strong> instead
              of <strong>{formatCurrency(CONSTANTS.CORRECT_PV)}</strong> — an error of nearly
              <strong> ${(CONSTANTS.CORRECT_PV - CONSTANTS.WRONG_PV).toFixed(2)}</strong>!
            </p>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              The 8% rate assumes the cash flows are annual. Since they're actually semi-annual,
              you're over-discounting — treating money as further away in time than it really is.
            </p>
          </>
        );
      }

      if (step === 1) {
        return (
          <>
            <h2 style={{ color: COLORS.primary, marginTop: 0 }}>Mistake #2: Forgetting to Halve the Coupon</h2>

            <WarningBox>
              <strong>Another common mistake:</strong> Using the annual coupon payment ($6) instead of
              the semi-annual payment ($3).
            </WarningBox>

            <p style={{ fontSize: '16px', lineHeight: '1.7', color: COLORS.textPrimary }}>
              If you use $6 as each coupon payment, you're doubling every payment — the bond
              would look much more valuable than it actually is.
            </p>

            <div style={{
              background: COLORS.surfaceAlt,
              borderRadius: '12px',
              padding: '20px',
              marginTop: '16px',
              marginBottom: '20px',
            }}>
              <div style={{ marginBottom: '16px' }}>
                <strong style={{ color: COLORS.error }}>Wrong:</strong>
                <div style={{ fontFamily: 'monospace', marginTop: '8px' }}>
                  Cash flows: $6, $6, $6, $6, $6, $106
                </div>
              </div>
              <div>
                <strong style={{ color: COLORS.success }}>Correct:</strong>
                <div style={{ fontFamily: 'monospace', marginTop: '8px' }}>
                  Cash flows: $3, $3, $3, $3, $3, $103
                </div>
              </div>
            </div>

            <InsightBox>
              <strong>Remember:</strong> When payments are semi-annual, <em>both</em> the interest rate
              and the coupon payment need to be divided by 2. The matching principle applies to
              everything — rates and cash flows.
            </InsightBox>
          </>
        );
      }

      return null;
    };

    // --- Part 6: Complete ---
    const Part6Complete = ({ exploredRabbitHoles, totalRabbitHoles, soundEnabled, onRabbitHole }) => {
      return (
        <>
          <div style={{ textAlign: 'center', marginBottom: '32px' }}>
            <div style={{
              width: '80px',
              height: '80px',
              borderRadius: '50%',
              background: COLORS.goldLight,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              margin: '0 auto 20px',
            }}>
              <LucideIcon name="Check" size={40} color={COLORS.gold} />
            </div>
            <h2 style={{ color: COLORS.primary, margin: '0 0 8px 0' }}>Tutorial Complete!</h2>
            <p style={{ color: COLORS.textSecondary, margin: 0 }}>
              You've mastered matching time periods and interest rates.
            </p>
          </div>

          <div style={{
            background: COLORS.surfaceAlt,
            borderRadius: '12px',
            padding: '24px',
            marginBottom: '24px',
          }}>
            <h3 style={{ margin: '0 0 16px 0', color: COLORS.primary, fontSize: '18px' }}>
              What You Learned
            </h3>
            <ul style={{ margin: 0, paddingLeft: '20px', lineHeight: '1.8', color: COLORS.textPrimary }}>
              <li><strong>The Matching Principle:</strong> Your rate's time unit must match your period's time unit</li>
              <li><strong>Converting Rates:</strong> Periodic rate = Annual rate ÷ Periods per year</li>
              <li><strong>Counting Periods:</strong> Total periods = Years × Payments per year</li>
              <li><strong>Adjusting Coupons:</strong> Semi-annual coupon = Annual coupon ÷ 2</li>
              <li><strong>Common Mistakes:</strong> Using annual rates or annual coupons for semi-annual bonds</li>
            </ul>
          </div>

          {/* Rabbit Holes Section with Clickable Buttons */}
          <div style={{
            background: COLORS.rabbitHoleLight,
            borderRadius: '12px',
            padding: '20px',
            marginBottom: '24px',
          }}>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: '8px',
              marginBottom: '16px',
            }}>
              <LucideIcon name="Rabbit" size={20} color={COLORS.rabbitHole} />
              <span style={{ fontWeight: '600', color: COLORS.rabbitHole }}>
                You explored {exploredRabbitHoles.length} of {totalRabbitHoles} rabbit holes
              </span>
            </div>

            {/* Always show all rabbit holes as clickable buttons */}
            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
              {Object.keys(RABBIT_HOLES).map(id => (
                <button
                  key={id}
                  onClick={() => onRabbitHole(id)}
                  style={{
                    padding: '10px 14px',
                    border: `1px solid ${COLORS.rabbitHoleBorder}`,
                    borderRadius: '8px',
                    background: exploredRabbitHoles.includes(id) ? COLORS.rabbitHoleLight : 'white',
                    color: COLORS.rabbitHole,
                    fontSize: '14px',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    textAlign: 'left',
                  }}
                >
                  <LucideIcon name="Rabbit" size={16} />
                  <span style={{ flex: 1 }}>{RABBIT_HOLES[id].title}</span>
                  {exploredRabbitHoles.includes(id) && <LucideIcon name="Check" size={16} />}
                </button>
              ))}
            </div>
          </div>

          <div style={{
            background: COLORS.primaryLight,
            color: 'white',
            borderRadius: '12px',
            padding: '20px',
            textAlign: 'center',
          }}>
            <div style={{ fontWeight: '600', marginBottom: '8px' }}>
              Deep Dive Complete!
            </div>
            <div style={{ fontSize: '15px', marginBottom: '12px', opacity: 0.95 }}>
              You've mastered compounding periods and APR vs EAR.
            </div>
            <a href="index.html" style={{
              display: 'inline-block',
              padding: '10px 24px',
              background: 'white',
              color: COLORS.primary,
              borderRadius: '8px',
              textDecoration: 'none',
              fontWeight: '500',
              fontSize: '15px',
            }}>
              Return to Hub
            </a>
          </div>
        </>
      );
    };

    // ============================================================================
    // MAIN COMPONENT
    // ============================================================================

    const Tutorial02F = () => {
      // Navigation state
      const [currentPartIndex, setCurrentPartIndex] = useState(0);
      const [currentStep, setCurrentStep] = useState(0);

      // UI state
      const [soundEnabled, setSoundEnabled] = useState(true);
      const [showGlossary, setShowGlossary] = useState(false);
      const [showRestartConfirm, setShowRestartConfirm] = useState(false);
      const [activeRabbitHole, setActiveRabbitHole] = useState(null);
      const [exploredRabbitHoles, setExploredRabbitHoles] = useState([]);
      const [devMode, setDevMode] = useState(false);

      // Progress tracking
      const [completed, setCompleted] = useState({});

      // Dev mode activation
      const [headerClickCount, setHeaderClickCount] = useState(0);
      const [lastClickTime, setLastClickTime] = useState(0);

      // Handlers
      const markComplete = useCallback((key) => {
        setCompleted(prev => ({ ...prev, [key]: true }));
      }, []);

      const handleContinue = useCallback(() => {
        const currentPart = PARTS[currentPartIndex];

        if (currentStep < currentPart.steps - 1) {
          setCurrentStep(prev => prev + 1);
        } else if (currentPartIndex < PARTS.length - 1) {
          setCurrentPartIndex(prev => prev + 1);
          setCurrentStep(0);
        }
      }, [currentPartIndex, currentStep]);

      const handleBack = useCallback(() => {
        if (currentStep > 0) {
          setCurrentStep(prev => prev - 1);
        } else if (currentPartIndex > 0) {
          const prevPartIndex = currentPartIndex - 1;
          setCurrentPartIndex(prevPartIndex);
          setCurrentStep(PARTS[prevPartIndex].steps - 1);
        }
      }, [currentPartIndex, currentStep]);

      const handleRestart = useCallback(() => {
        setCurrentPartIndex(0);
        setCurrentStep(0);
        setExploredRabbitHoles([]);
        setCompleted({});
        setShowRestartConfirm(false);
      }, []);

      const handleRabbitHoleClick = useCallback((rabbitHoleId) => {
        setActiveRabbitHole(RABBIT_HOLES[rabbitHoleId]);
        if (!exploredRabbitHoles.includes(rabbitHoleId)) {
          setExploredRabbitHoles(prev => [...prev, rabbitHoleId]);
        }
      }, [exploredRabbitHoles]);

      const handleHeaderClick = useCallback(() => {
        const now = Date.now();
        if (now - lastClickTime < 500) {
          const newCount = headerClickCount + 1;
          setHeaderClickCount(newCount);
          if (newCount >= 3) {
            setDevMode(prev => !prev);
            setHeaderClickCount(0);
          }
        } else {
          setHeaderClickCount(1);
        }
        setLastClickTime(now);
      }, [headerClickCount, lastClickTime]);

      const handleJumpToPart = useCallback((partIndex) => {
        setCurrentPartIndex(partIndex);
        setCurrentStep(0);
      }, []);

      // Determine if Continue is enabled
      const canContinue = useCallback(() => {
        const partId = PARTS[currentPartIndex].id;

        // Part 2, Step 1: periodic rate calculation
        if (partId === 'convertingRate' && currentStep === 1) {
          return completed.periodicRateCalc;
        }

        // Part 3, Step 1: coupon calculation
        if (partId === 'countingPeriods' && currentStep === 1) {
          return completed.couponCalc;
        }

        // Part 4, Step 1: PV calculation
        if (partId === 'puttingTogether' && currentStep === 1) {
          return completed.pvCalc;
        }

        // Complete screen - no continue button
        if (partId === 'complete') {
          return false;
        }

        return true;
      }, [currentPartIndex, currentStep, completed]);

      // Render current part
      const renderCurrentPart = () => {
        const partId = PARTS[currentPartIndex].id;
        const props = {
          step: currentStep,
          completed,
          onComplete: markComplete,
          soundEnabled,
          onRabbitHole: handleRabbitHoleClick,
          exploredRabbitHoles,
        };

        switch (partId) {
          case 'theProblem':
            return <Part0TheProblem {...props} />;
          case 'matchingPrinciple':
            return <Part1MatchingPrinciple {...props} />;
          case 'convertingRate':
            return <Part2ConvertingRate {...props} />;
          case 'countingPeriods':
            return <Part3CountingPeriods {...props} />;
          case 'puttingTogether':
            return <Part4PuttingTogether {...props} />;
          case 'commonMistakes':
            return <Part5CommonMistakes {...props} />;
          case 'complete':
            return (
              <Part6Complete
                exploredRabbitHoles={exploredRabbitHoles}
                totalRabbitHoles={Object.keys(RABBIT_HOLES).length}
                soundEnabled={soundEnabled}
                onRabbitHole={handleRabbitHoleClick}
              />
            );
          default:
            return null;
        }
      };

      const currentPart = PARTS[currentPartIndex];
      const canGoBack = currentPartIndex > 0 || currentStep > 0;
      const totalRabbitHoles = Object.keys(RABBIT_HOLES).length;

      return (
        <div style={{
          minHeight: '100vh',
          background: COLORS.background,
          fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
        }}>
          <Header
            currentPartIndex={currentPartIndex}
            currentStep={currentStep}
            exploredRabbitHoles={exploredRabbitHoles}
            totalRabbitHoles={totalRabbitHoles}
            onGlossaryClick={() => setShowGlossary(true)}
            onRestartClick={() => setShowRestartConfirm(true)}
            onHeaderClick={handleHeaderClick}
            soundEnabled={soundEnabled}
            onSoundToggle={() => setSoundEnabled(prev => !prev)}
          />

          <main style={{
            maxWidth: '800px',
            margin: '0 auto',
            padding: '32px 24px',
          }}>
            <div style={{
              background: 'white',
              borderRadius: '16px',
              padding: '32px',
              boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
            }}>
              {renderCurrentPart()}

              {currentPart.id !== 'complete' && (
                <NavButtons
                  onBack={handleBack}
                  onContinue={handleContinue}
                  canGoBack={canGoBack}
                  canContinue={canContinue()}
                  soundEnabled={soundEnabled}
                />
              )}
            </div>
          </main>

          {/* Tutorial Navigation Footer */}
          <div style={{
            background: '#00356b',
            padding: '24px',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            gap: '16px',
            marginTop: '40px',
          }}>
            <a href="index.html" style={{
              padding: '12px 24px',
              background: '#b8860b',
              borderRadius: '8px',
              color: 'white',
              textDecoration: 'none',
              textAlign: 'center',
              minWidth: '140px',
              fontWeight: '500',
            }}>
              Hub
            </a>
          </div>

          {/* Modals */}
          {showGlossary && <GlossaryModal onClose={() => setShowGlossary(false)} />}

          {showRestartConfirm && (
            <RestartConfirmModal
              onConfirm={handleRestart}
              onCancel={() => setShowRestartConfirm(false)}
            />
          )}

          {activeRabbitHole && (
            <RabbitHoleModal
              rabbitHole={activeRabbitHole}
              onClose={() => setActiveRabbitHole(null)}
            />
          )}

          {devMode && (
            <DevModePanel
              onJumpToPart={handleJumpToPart}
              currentPartIndex={currentPartIndex}
              onClose={() => setDevMode(false)}
            />
          )}
        </div>
      );
    };

    // Render the application
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Tutorial02F />);
  </script>
</body>
</html>
