<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Puzzle | Time Value of Money</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f8fafc; min-height: 100vh; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useCallback, useEffect, useRef } = React;

const LucideIcon = ({ name, size = 24, color = 'currentColor', style = {} }) => {
    const iconRef = useRef(null);
    useEffect(() => {
        if (iconRef.current && lucide[name]) {
            iconRef.current.innerHTML = '';
            const svg = lucide.createElement(lucide[name]);
            svg.setAttribute('width', size);
            svg.setAttribute('height', size);
            svg.setAttribute('stroke', color);
            iconRef.current.appendChild(svg);
        }
    }, [name, size, color]);
    return <span ref={iconRef} style={{ display: 'inline-flex', alignItems: 'center', ...style }} />;
};


// ============================================================================
// COLORS (Yale Blue Theme)
// ============================================================================

const COLORS = {
  primary: '#00356b',
  primaryLight: '#1a4a7a',
  primaryDark: '#002548',
  background: '#f8fafc',
  surface: '#ffffff',
  surfaceAlt: '#f1f5f9',
  border: '#e2e8f0',
  borderDark: '#cbd5e1',
  textPrimary: '#1e293b',
  textSecondary: '#64748b',
  textMuted: '#94a3b8',
  accent: '#0369a1',
  accentLight: '#e0f2fe',
  gold: '#ca8a04',
  goldLight: '#fef9c3',
  goldBorder: '#eab308',
  success: '#16a34a',
  successBg: '#f0fdf4',
  successBorder: '#86efac',
  warning: '#d97706',
  warningBg: '#fffbeb',
  warningBorder: '#fcd34d',
  deepDive: '#0f766e',
  deepDiveLight: '#ccfbf1',
  deepDiveBorder: '#14b8a6',
};

// ============================================================================
// TUTORIAL STRUCTURE (Streamlined)
// ============================================================================

const PARTS = [
  { id: 'welcome', title: 'Welcome', steps: 2 },
  { id: 'thePuzzle', title: 'The Puzzle', steps: 4 },
  { id: 'theProblems', title: 'The Problem', steps: 3 },
];

// ============================================================================
// GLOSSARY
// ============================================================================

const GLOSSARY = {
  cashFlowStream: {
    term: 'Cash Flow Stream',
    definition: 'A sequence of money amounts at different points in time. Defined by how much and when.',
  },
  period: {
    term: 'Period',
    definition: 'A span of time between two points. Period 1 is the interval between Time 0 and Time 1.',
  },
  value: {
    term: 'Value (Financial)',
    definition: 'A number assigned to a cash flow stream to capture how much it is worth. The challenge: without markets, this number depends on who is measuring.',
  },
};

// ============================================================================
// SOUND SYSTEM
// ============================================================================

const playSound = (type) => {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();

    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);

    switch (type) {
      case 'success':
        oscillator.frequency.setValueAtTime(523.25, ctx.currentTime);
        oscillator.frequency.setValueAtTime(659.25, ctx.currentTime + 0.1);
        oscillator.frequency.setValueAtTime(783.99, ctx.currentTime + 0.2);
        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.4);
        break;
      case 'click':
        oscillator.frequency.setValueAtTime(600, ctx.currentTime);
        gainNode.gain.setValueAtTime(0.15, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.08);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.08);
        break;
      default:
        break;
    }
    setTimeout(() => ctx.close(), 500);
  } catch (e) {
    // Fail silently
  }
};

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

const calculateProgress = (currentPartIndex, currentStep) => {
  const totalSteps = PARTS.reduce((sum, p) => sum + p.steps, 0);
  const completedSteps = PARTS.slice(0, currentPartIndex).reduce((sum, p) => sum + p.steps, 0) + currentStep;

  const isLastStep = currentPartIndex === PARTS.length - 1 && currentStep === PARTS[currentPartIndex].steps - 1;
  if (isLastStep) return 100;

  return Math.round((completedSteps / totalSteps) * 100);
};

// ============================================================================
// UI COMPONENTS
// ============================================================================

// --- Header ---
const Header = ({
  currentPartIndex,
  currentStep,
  onGlossaryClick,
  onRestartClick,
  onHeaderClick,
  soundEnabled,
  onSoundToggle
}) => {
  const progress = calculateProgress(currentPartIndex, currentStep);
  const currentPart = PARTS[currentPartIndex];

  return (
    <header style={{
      background: COLORS.primary,
      color: 'white',
      padding: '16px 24px',
      position: 'sticky',
      top: 0,
      zIndex: 100,
    }}>
      <div style={{ maxWidth: '800px', margin: '0 auto' }}>
        <div style={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '12px',
        }}>
          <h1
            onClick={onHeaderClick}
            style={{
              fontSize: '18px',
              fontWeight: '600',
              margin: 0,
              cursor: 'default',
              userSelect: 'none',
            }}
          >
            The Puzzle
          </h1>

          <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
            <button
              onClick={onSoundToggle}
              style={{
                background: 'rgba(255,255,255,0.1)',
                border: 'none',
                borderRadius: '6px',
                padding: '6px',
                cursor: 'pointer',
                color: 'white',
                display: 'flex',
                alignItems: 'center',
              }}
            >
              {soundEnabled ? <LucideIcon name="Volume2" size={18} /> : <LucideIcon name="VolumeX" size={18} />}
            </button>

            <button
              onClick={onGlossaryClick}
              style={{
                background: 'rgba(255,255,255,0.1)',
                border: 'none',
                borderRadius: '6px',
                padding: '6px 10px',
                cursor: 'pointer',
                color: 'white',
                display: 'flex',
                alignItems: 'center',
                gap: '4px',
                fontSize: '13px',
              }}
            >
              <LucideIcon name="BookOpen" size={16} />
              Glossary
            </button>

            <button
              onClick={onRestartClick}
              style={{
                background: 'rgba(255,255,255,0.1)',
                border: 'none',
                borderRadius: '6px',
                padding: '6px',
                cursor: 'pointer',
                color: 'white',
                display: 'flex',
                alignItems: 'center',
              }}
            >
              <LucideIcon name="RotateCcw" size={18} />
            </button>
          </div>
        </div>

        <div>
          <div style={{
            display: 'flex',
            justifyContent: 'space-between',
            fontSize: '13px',
            marginBottom: '6px',
            opacity: 0.9,
          }}>
            <span>Part {currentPartIndex + 1}: {currentPart.title}</span>
            <span>{progress}% complete</span>
          </div>

          <div style={{
            background: 'rgba(255,255,255,0.2)',
            borderRadius: '4px',
            height: '6px',
            overflow: 'hidden',
          }}>
            <div style={{
              background: COLORS.goldBorder,
              height: '100%',
              width: `${progress}%`,
              transition: 'width 0.3s ease',
              borderRadius: '4px',
            }} />
          </div>
        </div>
      </div>
    </header>
  );
};

// --- Navigation Buttons ---
const NavButtons = ({ onBack, onContinue, canGoBack, canContinue, continueLabel = 'Continue', soundEnabled }) => {
  const handleContinue = () => {
    if (soundEnabled) playSound('click');
    onContinue();
  };

  const handleBack = () => {
    if (soundEnabled) playSound('click');
    onBack();
  };

  return (
    <div style={{
      display: 'flex',
      justifyContent: 'space-between',
      marginTop: '32px',
      paddingTop: '24px',
      borderTop: `1px solid ${COLORS.border}`,
    }}>
      <button
        onClick={handleBack}
        disabled={!canGoBack}
        style={{
          display: 'flex',
          alignItems: 'center',
          gap: '6px',
          padding: '10px 20px',
          border: `1px solid ${COLORS.border}`,
          borderRadius: '8px',
          background: 'white',
          color: canGoBack ? COLORS.textPrimary : COLORS.textMuted,
          cursor: canGoBack ? 'pointer' : 'not-allowed',
          fontSize: '15px',
          opacity: canGoBack ? 1 : 0.5,
        }}
      >
        <LucideIcon name="ChevronLeft" size={18} />
        Back
      </button>

      <button
        onClick={handleContinue}
        disabled={!canContinue}
        style={{
          display: 'flex',
          alignItems: 'center',
          gap: '6px',
          padding: '10px 24px',
          border: 'none',
          borderRadius: '8px',
          background: canContinue ? COLORS.primary : COLORS.textMuted,
          color: 'white',
          cursor: canContinue ? 'pointer' : 'not-allowed',
          fontSize: '15px',
          fontWeight: '500',
        }}
      >
        {continueLabel}
        <LucideIcon name="ChevronRight" size={18} />
      </button>
    </div>
  );
};

// --- Choice Button ---
const ChoiceButton = ({ label, selected, correct, submitted, onClick, disabled }) => {
  let background = 'white';
  let borderColor = COLORS.border;
  let textColor = COLORS.textPrimary;

  if (selected && !submitted) {
    background = COLORS.accentLight;
    borderColor = COLORS.accent;
  } else if (submitted) {
    if (correct) {
      background = COLORS.successBg;
      borderColor = COLORS.successBorder;
    } else if (selected && !correct) {
      background = COLORS.warningBg;
      borderColor = COLORS.warningBorder;
    } else {
      textColor = COLORS.textMuted;
    }
  }

  return (
    <button
      onClick={onClick}
      disabled={disabled || submitted}
      style={{
        display: 'flex',
        alignItems: 'center',
        gap: '12px',
        width: '100%',
        padding: '14px 16px',
        border: `2px solid ${borderColor}`,
        borderRadius: '10px',
        background,
        color: textColor,
        cursor: disabled || submitted ? 'default' : 'pointer',
        fontSize: '15px',
        textAlign: 'left',
        transition: 'all 0.2s ease',
      }}
    >
      {submitted && correct && <LucideIcon name="Check" size={20} color={COLORS.success} />}
      {submitted && selected && !correct && <LucideIcon name="X" size={20} color={COLORS.warning} />}
      {!submitted && <div style={{
        width: '20px',
        height: '20px',
        borderRadius: '50%',
        border: `2px solid ${selected ? COLORS.accent : COLORS.border}`,
        background: selected ? COLORS.accent : 'white',
      }} />}
      <span>{label}</span>
    </button>
  );
};

// --- Insight Box ---
const InsightBox = ({ children, icon }) => (
  <div style={{
    background: COLORS.goldLight,
    border: `2px solid ${COLORS.goldBorder}`,
    borderRadius: '12px',
    padding: '20px',
    marginTop: '20px',
    marginBottom: '20px',
  }}>
    <div style={{ display: 'flex', gap: '12px', alignItems: 'flex-start' }}>
      {icon || <LucideIcon name="Lightbulb" size={24} color={COLORS.gold} style={{ flexShrink: 0, marginTop: '2px' }} />}
      <div style={{ fontSize: '16px', lineHeight: '1.6', color: COLORS.textPrimary }}>
        {children}
      </div>
    </div>
  </div>
);

// --- Deep Dive Link ---
const DeepDiveLink = ({ title, href }) => (
  <a
    href={href}
    style={{
      display: 'flex',
      alignItems: 'center',
      gap: '10px',
      padding: '12px 16px',
      border: `1px solid ${COLORS.deepDiveBorder}`,
      borderRadius: '8px',
      background: COLORS.deepDiveLight,
      color: COLORS.deepDive,
      textDecoration: 'none',
      fontSize: '14px',
      marginTop: '16px',
    }}
  >
    <LucideIcon name="Layers" size={18} style={{ flexShrink: 0 }} />
    <span>For more on this, see the Deep Dive: <strong>{title}</strong></span>
  </a>
);

// --- Cash Flow Diagram ---
const CashFlowDiagram = ({ flows, highlightPeriod, label }) => {
  const maxPeriod = Math.max(...flows.map(f => f.period));

  return (
    <div style={{
      background: COLORS.surfaceAlt,
      borderRadius: '12px',
      padding: '24px',
      marginTop: '16px',
      marginBottom: '16px',
    }}>
      {label && (
        <div style={{
          fontSize: '14px',
          fontWeight: '600',
          color: COLORS.textSecondary,
          marginBottom: '16px',
          textAlign: 'center',
        }}>
          {label}
        </div>
      )}

      <div style={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'flex-end',
        position: 'relative',
        minHeight: '100px',
        paddingBottom: '40px',
      }}>
        <div style={{
          position: 'absolute',
          bottom: '20px',
          left: '0',
          right: '0',
          height: '2px',
          background: COLORS.borderDark,
        }} />

        {Array.from({ length: maxPeriod + 1 }, (_, i) => {
          const flow = flows.find(f => f.period === i);
          const isHighlighted = highlightPeriod === i;

          return (
            <div key={i} style={{
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              position: 'relative',
              flex: 1,
            }}>
              {flow && flow.amount > 0 && (
                <div style={{
                  background: isHighlighted ? COLORS.primary : 'white',
                  color: isHighlighted ? 'white' : COLORS.textPrimary,
                  border: `2px solid ${isHighlighted ? COLORS.primary : COLORS.border}`,
                  borderRadius: '8px',
                  padding: '8px 12px',
                  marginBottom: '12px',
                  fontFamily: 'monospace',
                  fontSize: '15px',
                  fontWeight: '600',
                }}>
                  ${flow.amount.toFixed(2)}
                </div>
              )}

              {flow && flow.amount > 0 && (
                <div style={{
                  width: '2px',
                  height: '20px',
                  background: isHighlighted ? COLORS.primary : COLORS.borderDark,
                }} />
              )}

              <div style={{
                width: '12px',
                height: '12px',
                borderRadius: '50%',
                background: (flow && flow.amount > 0) ? (isHighlighted ? COLORS.primary : COLORS.textSecondary) : COLORS.border,
                position: 'absolute',
                bottom: '14px',
              }} />

              <span style={{
                position: 'absolute',
                bottom: '-8px',
                fontSize: '13px',
                color: COLORS.textSecondary,
              }}>
                Time {i}
              </span>
            </div>
          );
        })}
      </div>
    </div>
  );
};

// --- Glossary Modal ---
const GlossaryModal = ({ onClose }) => (
  <div style={{
    position: 'fixed',
    inset: 0,
    background: 'rgba(0,0,0,0.5)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    padding: '20px',
    zIndex: 1000,
  }}>
    <div style={{
      background: 'white',
      borderRadius: '16px',
      maxWidth: '600px',
      maxHeight: '80vh',
      overflow: 'auto',
      boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
    }}>
      <div style={{
        background: COLORS.primary,
        color: 'white',
        padding: '20px 24px',
        display: 'flex',
        alignItems: 'center',
        gap: '12px',
      }}>
        <LucideIcon name="BookOpen" size={24} />
        <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600' }}>Glossary</h2>
      </div>

      <div style={{ padding: '16px 24px' }}>
        {Object.values(GLOSSARY).map((item, i) => (
          <div key={item.term} style={{
            padding: '16px 0',
            borderBottom: i < Object.values(GLOSSARY).length - 1 ? `1px solid ${COLORS.border}` : 'none',
          }}>
            <h3 style={{
              margin: '0 0 6px 0',
              fontSize: '16px',
              fontWeight: '600',
              color: COLORS.primary,
            }}>
              {item.term}
            </h3>
            <p style={{
              margin: 0,
              fontSize: '14px',
              lineHeight: '1.5',
              color: COLORS.textSecondary,
            }}>
              {item.definition}
            </p>
          </div>
        ))}
      </div>

      <div style={{
        padding: '16px 24px',
        borderTop: `1px solid ${COLORS.border}`,
        display: 'flex',
        justifyContent: 'flex-end',
      }}>
        <button
          onClick={onClose}
          style={{
            padding: '10px 24px',
            border: 'none',
            borderRadius: '8px',
            background: COLORS.primary,
            color: 'white',
            fontSize: '15px',
            fontWeight: '500',
            cursor: 'pointer',
          }}
        >
          Close
        </button>
      </div>
    </div>
  </div>
);

// --- Dev Mode Panel ---
const DevModePanel = ({ onJumpToPart, currentPartIndex, onClose }) => (
  <div style={{
    position: 'fixed',
    bottom: '20px',
    right: '20px',
    background: 'white',
    border: `2px solid ${COLORS.warning}`,
    borderRadius: '12px',
    padding: '16px',
    boxShadow: '0 10px 40px rgba(0,0,0,0.15)',
    zIndex: 999,
  }}>
    <div style={{
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: '12px',
    }}>
      <h3 style={{ margin: 0, fontSize: '14px', color: COLORS.warning, fontWeight: '600' }}>
        ðŸ›  Dev Mode
      </h3>
      <button onClick={onClose} style={{ background: 'none', border: 'none', cursor: 'pointer', color: COLORS.textMuted }}>
        <LucideIcon name="X" size={18} />
      </button>
    </div>

    <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
      {PARTS.map((part, index) => (
        <button
          key={part.id}
          onClick={() => onJumpToPart(index)}
          style={{
            padding: '8px 12px',
            border: `1px solid ${index === currentPartIndex ? COLORS.warning : COLORS.border}`,
            borderRadius: '6px',
            background: index === currentPartIndex ? COLORS.warningBg : 'white',
            color: COLORS.textPrimary,
            fontSize: '13px',
            textAlign: 'left',
            cursor: 'pointer',
          }}
        >
          {index + 1}. {part.title}
        </button>
      ))}
    </div>
  </div>
);

// ============================================================================
// CONTENT COMPONENTS
// ============================================================================

// --- Part 1: Welcome ---
const WelcomePart = ({ step }) => {
  const content = [
    // Step 0: Hook - "Which is worth more?"
    <>
      <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>Which is worth more?</h2>
      <div style={{ display: 'flex', gap: '16px', marginBottom: '24px', flexWrap: 'wrap' }}>
        <div style={{
          flex: 1,
          minWidth: '200px',
          padding: '20px',
          background: COLORS.surfaceAlt,
          borderRadius: '12px',
          textAlign: 'center',
        }}>
          <div style={{ fontSize: '32px', fontWeight: '700', color: COLORS.primary, fontFamily: 'monospace' }}>
            $83.96
          </div>
          <div style={{ fontSize: '14px', color: COLORS.textSecondary, marginTop: '8px' }}>
            today
          </div>
        </div>
        <div style={{
          flex: 1,
          minWidth: '200px',
          padding: '20px',
          background: COLORS.surfaceAlt,
          borderRadius: '12px',
          textAlign: 'center',
        }}>
          <div style={{ fontSize: '32px', fontWeight: '700', color: COLORS.primary, fontFamily: 'monospace' }}>
            $100.00
          </div>
          <div style={{ fontSize: '14px', color: COLORS.textSecondary, marginTop: '8px' }}>
            three years from now
          </div>
        </div>
      </div>
      <p style={{ color: COLORS.textSecondary, lineHeight: '1.6' }}>
        Think about it for a moment. Surely one of these is worth more than the other?
      </p>
      <p style={{ color: COLORS.textSecondary, lineHeight: '1.6', marginTop: '12px' }}>
        By the end of this tutorial, you'll see why this question is harder than it looks.
      </p>
    </>,

    // Step 1: A note before we begin
    <>
      <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>A note before we begin</h2>
      <p style={{ color: COLORS.textSecondary, lineHeight: '1.6' }}>
        Throughout this tutorial (and this course), we'll make simplifying assumptions. We'll ignore taxes, transaction costs, and many real-world complications.
      </p>
      <p style={{ color: COLORS.textSecondary, lineHeight: '1.6', marginTop: '12px' }}>
        This isn't because those things don't matter â€” they do. It's because we need to see the core logic clearly first. Once you understand how things work without friction, you can add realistic complications back in.
      </p>
      <p style={{ color: COLORS.textSecondary, lineHeight: '1.6', marginTop: '12px' }}>
        Think of it like physics assuming "no air resistance." Useful for understanding, dangerous if you forget it's an assumption.
      </p>
      <div style={{
        marginTop: '20px',
        padding: '16px',
        background: COLORS.surfaceAlt,
        borderRadius: '8px',
        borderLeft: `4px solid ${COLORS.gold}`,
      }}>
        <p style={{ margin: 0, color: COLORS.textPrimary, fontSize: '14px' }}>
          <strong>We're talking about money only.</strong> Not what you value personally â€” kindness, family, meaning. Just cash amounts at different points in time. We can certainly calculate with these numbers. But do the calculations tell us what a cash flow stream is <em>worth</em>? That's what we're here to figure out.
        </p>
      </div>
    </>,
  ];

  return content[step] || null;
};

// --- Part 2: The Puzzle ---
const ThePuzzlePart = ({ step, onAnswer, answers, soundEnabled }) => {
  const content = [
    // Step 0: Present the two streams
    <>
      <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>Two cash flow streams</h2>
      <p style={{ color: COLORS.textSecondary, lineHeight: '1.6', marginBottom: '20px' }}>
        Let's make the comparison concrete. Here's a way to visualize the two options from our opening question â€” as <strong>cash flow streams</strong> on a timeline.
      </p>

      <CashFlowDiagram
        flows={[{ period: 0, amount: 83.96 }, { period: 1, amount: 0 }, { period: 2, amount: 0 }, { period: 3, amount: 0 }]}
        highlightPeriod={0}
        label="Stream A"
      />

      <CashFlowDiagram
        flows={[{ period: 0, amount: 0 }, { period: 1, amount: 0 }, { period: 2, amount: 0 }, { period: 3, amount: 100 }]}
        highlightPeriod={3}
        label="Stream B"
      />

      <p style={{ color: COLORS.textSecondary, lineHeight: '1.6', marginTop: '16px' }}>
        Stream A gives you $83.96 right now (Time 0).
        <br />
        Stream B gives you $100.00 at Time 3.
      </p>
    </>,

    // Step 1: The rules
    <>
      <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>The rules</h2>
      <p style={{ color: COLORS.textSecondary, lineHeight: '1.6' }}>
        Here's the catch: whatever you choose, you have to take the money and <strong>within 30 minutes</strong>, spend it all on your favorite food or drink â€” and consume it right there.
      </p>
      <div style={{
        display: 'flex',
        gap: '16px',
        marginTop: '20px',
        flexWrap: 'wrap',
      }}>
        <div style={{
          flex: 1,
          minWidth: '150px',
          padding: '16px',
          background: COLORS.surfaceAlt,
          borderRadius: '10px',
          textAlign: 'center',
        }}>
          <LucideIcon name="Coffee" size={32} color={COLORS.primary} style={{ marginBottom: '8px' }} />
          <div style={{ fontSize: '14px', color: COLORS.textSecondary }}>Coffee?</div>
        </div>
        <div style={{
          flex: 1,
          minWidth: '150px',
          padding: '16px',
          background: COLORS.surfaceAlt,
          borderRadius: '10px',
          textAlign: 'center',
        }}>
          <LucideIcon name="Apple" size={32} color={COLORS.primary} style={{ marginBottom: '8px' }} />
          <div style={{ fontSize: '14px', color: COLORS.textSecondary }}>Snacks?</div>
        </div>
      </div>
      <p style={{ color: COLORS.textSecondary, lineHeight: '1.6', marginTop: '20px' }}>
        No investing. No saving. Just: take the money, spend it on consumption, right away.
      </p>
      <p style={{ color: COLORS.textMuted, fontSize: '14px', marginTop: '12px' }}>
        (This constraint will matter. We're removing other options on purpose.)
      </p>
    </>,

    // Step 2: Which do you prefer?
    <>
      <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>Which do you prefer?</h2>
      <p style={{ color: COLORS.textSecondary, lineHeight: '1.6', marginBottom: '20px' }}>
        Think about it. $83.96 today, or $100 three years from now â€” all spent immediately on food.
      </p>
      <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
        <ChoiceButton
          label="Stream A: $83.96 today"
          selected={answers.preference === 'A'}
          submitted={false}
          onClick={() => onAnswer('preference', 'A')}
        />
        <ChoiceButton
          label="Stream B: $100 in three years"
          selected={answers.preference === 'B'}
          submitted={false}
          onClick={() => onAnswer('preference', 'B')}
        />
      </div>
      {answers.preference && (
        <div style={{
          marginTop: '20px',
          padding: '16px',
          background: COLORS.surfaceAlt,
          borderRadius: '8px',
        }}>
          <p style={{ margin: 0, color: COLORS.textPrimary }}>
            You chose <strong>Stream {answers.preference}</strong>. Good. Hold that thought.
          </p>
        </div>
      )}
    </>,

    // Step 3: But wait...
    <>
      <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>But wait...</h2>
      <p style={{ color: COLORS.textSecondary, lineHeight: '1.6' }}>
        Now imagine two different people making this choice.
      </p>
      <div style={{
        display: 'flex',
        gap: '20px',
        marginTop: '20px',
        flexWrap: 'wrap',
      }}>
        <div style={{
          flex: 1,
          minWidth: '220px',
          padding: '20px',
          background: COLORS.warningBg,
          border: `2px solid ${COLORS.warningBorder}`,
          borderRadius: '12px',
        }}>
          <div style={{ fontSize: '24px', marginBottom: '8px' }}>ðŸ˜«</div>
          <div style={{ fontWeight: '600', color: COLORS.textPrimary, marginBottom: '8px' }}>
            The Hungry Person
          </div>
          <p style={{ margin: 0, fontSize: '14px', color: COLORS.textSecondary }}>
            Hasn't eaten all day. Stomach growling. If they have to eat in 30 minutes, they want the money <strong>now</strong>.
          </p>
        </div>
        <div style={{
          flex: 1,
          minWidth: '220px',
          padding: '20px',
          background: COLORS.successBg,
          border: `2px solid ${COLORS.successBorder}`,
          borderRadius: '12px',
        }}>
          <div style={{ fontSize: '24px', marginBottom: '8px' }}>ðŸ˜Œ</div>
          <div style={{ fontWeight: '600', color: COLORS.textPrimary, marginBottom: '8px' }}>
            The Full Person
          </div>
          <p style={{ margin: 0, fontSize: '14px', color: COLORS.textSecondary }}>
            Just finished a huge meal. Not hungry at all. If they have to eat in 30 minutes... maybe they'd rather <strong>wait</strong> and get more later.
          </p>
        </div>
      </div>
      <p style={{ color: COLORS.textSecondary, lineHeight: '1.6', marginTop: '24px' }}>
        The hungry person prefers Stream A (money now).
        <br />
        The full person might prefer Stream B (more money later).
      </p>
      <p style={{ color: COLORS.primary, lineHeight: '1.6', marginTop: '16px', fontWeight: '500' }}>
        Who's right?
      </p>
    </>,
  ];

  return content[step] || null;
};

// --- Part 3: The Problem ---
const TheProblemPart = ({ step, onAnswer, answers, soundEnabled }) => {
  const content = [
    // Step 0: Both are right + bridge
    <>
      <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>Who's right?</h2>
      <div style={{ display: 'flex', flexDirection: 'column', gap: '10px', marginBottom: '20px' }}>
        <ChoiceButton
          label="The hungry person"
          selected={answers.whoRight === 'hungry'}
          correct={answers.whoRightSubmitted ? true : undefined}
          submitted={answers.whoRightSubmitted}
          onClick={() => onAnswer('whoRight', 'hungry')}
        />
        <ChoiceButton
          label="The full person"
          selected={answers.whoRight === 'full'}
          correct={answers.whoRightSubmitted ? true : undefined}
          submitted={answers.whoRightSubmitted}
          onClick={() => onAnswer('whoRight', 'full')}
        />
        <ChoiceButton
          label="Both are right"
          selected={answers.whoRight === 'both'}
          correct={answers.whoRightSubmitted ? true : undefined}
          submitted={answers.whoRightSubmitted}
          onClick={() => onAnswer('whoRight', 'both')}
        />
      </div>
      {answers.whoRight && !answers.whoRightSubmitted && (
        <button
          onClick={() => {
            if (soundEnabled) playSound('success');
            onAnswer('whoRightSubmitted', true);
          }}
          style={{
            padding: '10px 20px',
            background: COLORS.primary,
            color: 'white',
            border: 'none',
            borderRadius: '8px',
            cursor: 'pointer',
            fontSize: '15px',
          }}
        >
          Submit
        </button>
      )}
      {answers.whoRightSubmitted && (
        <InsightBox>
          <strong>All answers are correct!</strong> That's the point. The hungry person is right to prefer money now. The full person is right to prefer money later. They just have different preferences.
        </InsightBox>
      )}
    </>,

    // Step 1: Bridge + The problem
    <>
      <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>So both are right. But here's why that's a problem.</h2>
      <p style={{ color: COLORS.textSecondary, lineHeight: '1.6' }}>
        If you asked me "which stick is longer?" I could measure them and give you a definitive answer. The answer doesn't depend on who's asking.
      </p>
      <p style={{ color: COLORS.textSecondary, lineHeight: '1.6', marginTop: '12px' }}>
        But if you ask "which cash flow stream is worth more?" â€” we just saw that the answer <em>does</em> depend on who's asking. The hungry person and the full person give opposite answers, and neither is wrong.
      </p>
      <p style={{ color: COLORS.textSecondary, lineHeight: '1.6', marginTop: '12px' }}>
        <strong>This personal nature of value has to be overcome before we have any chance at measurement.</strong>
      </p>
      <div style={{
        display: 'flex',
        gap: '16px',
        marginTop: '24px',
        flexWrap: 'wrap',
      }}>
        <div style={{
          flex: 1,
          minWidth: '200px',
          padding: '16px',
          background: COLORS.warningBg,
          borderRadius: '10px',
        }}>
          <div style={{ fontWeight: '600', color: COLORS.textPrimary, marginBottom: '4px' }}>Hungry person's ruler</div>
          <div style={{ fontSize: '14px', color: COLORS.textSecondary }}>Stream A &gt; Stream B</div>
        </div>
        <div style={{
          flex: 1,
          minWidth: '200px',
          padding: '16px',
          background: COLORS.successBg,
          borderRadius: '10px',
        }}>
          <div style={{ fontWeight: '600', color: COLORS.textPrimary, marginBottom: '4px' }}>Full person's ruler</div>
          <div style={{ fontSize: '14px', color: COLORS.textSecondary }}>Stream B &gt; Stream A</div>
        </div>
      </div>

      <DeepDiveLink
        title="Can We Measure Value?"
        href="Tutorial-DeepDive-CanWeMeasureValue.html"
      />
    </>,

    // Step 2: The key insight
    <>
      <h2 style={{ color: COLORS.primary, marginBottom: '16px' }}>The key insight</h2>
      <InsightBox>
        Without markets, value depends on who's measuring. The hungry person and the full person are both right â€” they just want different things. There's no single number that captures "the value" of a cash flow stream.
        <br /><br />
        To measure value, we need something that makes the measurement <strong>not depend on individual preferences</strong>.
      </InsightBox>
      <p style={{ color: COLORS.textSecondary, lineHeight: '1.6', marginTop: '20px' }}>
        In the next tutorial, we'll discover what that "something" is â€” and why it changes everything.
      </p>
      <a href="Tutorial-B-TheMachine.html" style={{
        marginTop: '24px',
        padding: '16px 20px',
        background: COLORS.primary,
        borderRadius: '10px',
        display: 'flex',
        alignItems: 'center',
        gap: '12px',
        textDecoration: 'none',
        color: 'white',
      }}>
        <span style={{ fontWeight: '500' }}>
          Next: The Machine
        </span>
        <LucideIcon name="ArrowRight" size={20} />
      </a>
    </>,
  ];

  return content[step] || null;
};

// ============================================================================
// MAIN TUTORIAL COMPONENT
// ============================================================================

const ThePuzzleTutorial = () => {
  // Navigation state
  const [currentPartIndex, setCurrentPartIndex] = useState(0);
  const [currentStep, setCurrentStep] = useState(0);
  const [soundEnabled, setSoundEnabled] = useState(true);

  // Modal state
  const [showGlossary, setShowGlossary] = useState(false);

  // Answer state
  const [answers, setAnswers] = useState({});

  // Dev mode
  const [devMode, setDevMode] = useState(false);
  const [headerClickCount, setHeaderClickCount] = useState(0);
  const [lastClickTime, setLastClickTime] = useState(0);

  // Handlers
  const handleAnswer = useCallback((key, value) => {
    setAnswers(prev => ({ ...prev, [key]: value }));
  }, []);

  const handleContinue = useCallback(() => {
    const currentPart = PARTS[currentPartIndex];
    if (currentStep < currentPart.steps - 1) {
      setCurrentStep(prev => prev + 1);
    } else if (currentPartIndex < PARTS.length - 1) {
      setCurrentPartIndex(prev => prev + 1);
      setCurrentStep(0);
    }
  }, [currentPartIndex, currentStep]);

  const handleBack = useCallback(() => {
    if (currentStep > 0) {
      setCurrentStep(prev => prev - 1);
    } else if (currentPartIndex > 0) {
      const prevPartIndex = currentPartIndex - 1;
      setCurrentPartIndex(prevPartIndex);
      setCurrentStep(PARTS[prevPartIndex].steps - 1);
    }
  }, [currentPartIndex, currentStep]);

  const handleRestart = useCallback(() => {
    if (window.confirm('Restart this tutorial? Your progress will be lost.')) {
      setCurrentPartIndex(0);
      setCurrentStep(0);
      setAnswers({});
    }
  }, []);

  const handleHeaderClick = useCallback(() => {
    const now = Date.now();
    if (now - lastClickTime < 500) {
      const newCount = headerClickCount + 1;
      setHeaderClickCount(newCount);
      if (newCount >= 3) {
        setDevMode(prev => !prev);
        setHeaderClickCount(0);
      }
    } else {
      setHeaderClickCount(1);
    }
    setLastClickTime(now);
  }, [headerClickCount, lastClickTime]);

  const handleJumpToPart = useCallback((partIndex) => {
    setCurrentPartIndex(partIndex);
    setCurrentStep(0);
  }, []);

  // Determine if continue is allowed
  const canContinue = useCallback(() => {
    const partId = PARTS[currentPartIndex].id;

    // Part 2, Step 2: Need to pick a preference
    if (partId === 'thePuzzle' && currentStep === 2) {
      return answers.preference !== undefined;
    }

    // Part 3, Step 0: Need to submit who's right answer
    if (partId === 'theProblems' && currentStep === 0) {
      return answers.whoRightSubmitted === true;
    }

    return true;
  }, [currentPartIndex, currentStep, answers]);

  // Render current content
  const renderContent = () => {
    const partId = PARTS[currentPartIndex].id;

    switch (partId) {
      case 'welcome':
        return <WelcomePart step={currentStep} />;
      case 'thePuzzle':
        return (
          <ThePuzzlePart
            step={currentStep}
            onAnswer={handleAnswer}
            answers={answers}
            soundEnabled={soundEnabled}
          />
        );
      case 'theProblems':
        return (
          <TheProblemPart
            step={currentStep}
            onAnswer={handleAnswer}
            answers={answers}
            soundEnabled={soundEnabled}
          />
        );
      default:
        return null;
    }
  };

  const currentPart = PARTS[currentPartIndex];
  const isLastStep = currentPartIndex === PARTS.length - 1 && currentStep === currentPart.steps - 1;

  return (
    <div style={{
      minHeight: '100vh',
      background: COLORS.background,
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
    }}>
      <Header
        currentPartIndex={currentPartIndex}
        currentStep={currentStep}
        onGlossaryClick={() => setShowGlossary(true)}
        onRestartClick={handleRestart}
        onHeaderClick={handleHeaderClick}
        soundEnabled={soundEnabled}
        onSoundToggle={() => setSoundEnabled(prev => !prev)}
      />

      <main style={{
        maxWidth: '800px',
        margin: '0 auto',
        padding: '32px 24px',
      }}>
        <div style={{
          background: 'white',
          borderRadius: '16px',
          padding: '32px',
          boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
        }}>
          {renderContent()}

          <NavButtons
            onBack={handleBack}
            onContinue={handleContinue}
            canGoBack={currentPartIndex > 0 || currentStep > 0}
            canContinue={canContinue()}
            continueLabel={isLastStep ? 'Complete Tutorial' : 'Continue'}
            soundEnabled={soundEnabled}
          />
        </div>
      </main>

      {/* Tutorial Navigation Footer */}
      <div style={{
        background: '#00356b',
        padding: '24px',
        display: 'flex',
        justifyContent: 'center',
        alignItems: 'center',
        gap: '16px',
        marginTop: '40px',
      }}>
        <a href="index.html" style={{
          padding: '12px 24px',
          background: '#b8860b',
          borderRadius: '8px',
          color: 'white',
          textDecoration: 'none',
          textAlign: 'center',
          minWidth: '140px',
          fontWeight: '500',
        }}>
          Hub
        </a>
        <a href="Tutorial-B-TheMachine.html" style={{
          padding: '12px 24px',
          background: 'rgba(255,255,255,0.15)',
          borderRadius: '8px',
          color: 'white',
          textDecoration: 'none',
          textAlign: 'center',
          minWidth: '140px',
        }}>
          <div style={{ fontSize: '14px', fontWeight: '500' }}>Next &rarr;</div>
          <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>The Machine</div>
        </a>
      </div>

      {/* Modals */}
      {showGlossary && <GlossaryModal onClose={() => setShowGlossary(false)} />}
      {devMode && (
        <DevModePanel
          onJumpToPart={handleJumpToPart}
          currentPartIndex={currentPartIndex}
          onClose={() => setDevMode(false)}
        />
      )}
    </div>
  );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<ThePuzzleTutorial />);
    </script>
</body>
</html>
