<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Dive: Capital Projects and NPV | Time Value of Money</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f8fafc; min-height: 100vh; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useCallback, useEffect, useRef } = React;

// LucideIcon wrapper for CDN version
const LucideIcon = ({ name, size = 24, color = 'currentColor', style = {} }) => {
    const iconRef = useRef(null);
    useEffect(() => {
        if (iconRef.current && lucide[name]) {
            iconRef.current.innerHTML = '';
            const svg = lucide.createElement(lucide[name]);
            svg.setAttribute('width', size);
            svg.setAttribute('height', size);
            svg.setAttribute('stroke', color);
            iconRef.current.appendChild(svg);
        }
    }, [name, size, color]);
    return <span ref={iconRef} style={{ display: 'inline-flex', alignItems: 'center', ...style }} />;
};


// Icons:  
  ChevronLeft, 
  ChevronRight, 
  Rabbit, 
  BookOpen, 
  RotateCcw, 
  Check, 
  X, 
  Volume2,
  VolumeX,
  TrendingUp,
  DollarSign,
  Building2,
  Coffee,
  Calculator,
  ArrowRight,
  ArrowDown,
  HelpCircle,
  Lightbulb,
  Target,
  Factory,
  CircleDollarSign,
  FileText,
  CheckCircle,
  XCircle,
  MinusCircle,
  Award


// ============================================================================
// CONSTANTS
// ============================================================================

const CONSTANTS = {
  // Bond (from 02H â€” for recap only)
  BOND_PV: 100,
  BOND_RATE: 0.06,
  BOND_YEARS: 3,
  
  // Coffee Shop (from 02H â€” for recap only)
  COFFEE_TOTAL_PV: 242221,
  COFFEE_RATE: 0.10,
  
  // Equipment Project (new)
  EQUIP_COST: 50000,
  EQUIP_ANNUAL_CF: 15000,
  EQUIP_YEARS: 5,
  EQUIP_RATE: 0.08,
  EQUIP_ANNUITY_FACTOR: 3.9927,
  EQUIP_INFLOW_PV: 59890,  // 15000 Ã— 3.9927
  EQUIP_NPV: 9890,         // 59890 - 50000
  
  // Tolerances
  TOLERANCE_TIGHT: 1,
  TOLERANCE_NORMAL: 50,
  TOLERANCE_WIDE: 100,
};

// ============================================================================
// COLORS (Yale Blue Theme + Project Teal)
// ============================================================================

const COLORS = {
  // Core Yale blue
  primary: '#00356b',
  primaryLight: '#1a4a7a',
  primaryDark: '#002548',
  
  // Backgrounds
  background: '#f8fafc',
  surface: '#ffffff',
  surfaceAlt: '#f1f5f9',
  
  // Borders
  border: '#e2e8f0',
  borderDark: '#cbd5e1',
  
  // Text
  textPrimary: '#1e293b',
  textSecondary: '#64748b',
  textMuted: '#94a3b8',
  
  // Accent colors
  accent: '#0369a1',
  accentLight: '#e0f2fe',
  
  // Gold for insights and destinations
  gold: '#ca8a04',
  goldLight: '#fef9c3',
  goldBorder: '#eab308',
  
  // Feedback
  success: '#16a34a',
  successBg: '#f0fdf4',
  successBorder: '#86efac',
  
  warning: '#d97706',
  warningBg: '#fffbeb',
  warningBorder: '#fcd34d',
  
  error: '#dc2626',
  errorBg: '#fef2f2',
  
  // Rabbit holes (purple theme)
  rabbitHole: '#7c3aed',
  rabbitHoleLight: '#ede9fe',
  rabbitHoleBorder: '#a78bfa',
  
  // Project/Equipment (teal theme)
  projectColor: '#0891b2',
  projectColorLight: '#ecfeff',
  projectColorBorder: '#22d3ee',
  
  // Business (from 02H)
  businessColor: '#7c3aed',
  businessColorLight: '#ede9fe',
  
  // Bond (for comparison)
  bondColor: '#00356b',
  bondColorLight: '#e0f2fe',
  
  // Negative/Positive cash flows
  negativeColor: '#dc2626',
  negativeColorLight: '#fef2f2',
  positiveColor: '#16a34a',
  positiveColorLight: '#f0fdf4',
};

// ============================================================================
// TUTORIAL STRUCTURE
// ============================================================================

const PARTS = [
  { id: 'quickRecap', title: 'Quick Recap', steps: 1 },
  { id: 'aNewQuestion', title: 'A New Question', steps: 2 },
  { id: 'equipmentDecision', title: 'The Equipment Decision', steps: 3 },
  { id: 'npvRule', title: 'The NPV Rule', steps: 2 },
  { id: 'threeAssetsCompared', title: 'Three Assets Compared', steps: 1 },
  { id: 'complete', title: 'Complete', steps: 1 },
];

// ============================================================================
// RABBIT HOLES DATA
// ============================================================================

const RABBIT_HOLES = {
  discountRates: {
    id: 'discountRates',
    title: 'Where Do Discount Rates Come From?',
    partId: 'equipmentDecision',
    content: `The 8% discount rate is meant to represent the company's "cost of capital" â€” what the company could earn on similar-risk investments elsewhere.

In textbooks, this is calculated as a weighted average of debt and equity costs (WACC). But choosing discount rates in practice is something of a dark art.

Survey evidence shows that firms routinely set hurdle rates *above* their calculated cost of capital â€” sometimes by several percentage points. Why?

Possible reasons include:
â€¢ Adjusting for project-specific risk that WACC doesn't capture
â€¢ Counteracting managerial optimism in cash flow projections
â€¢ Rationing scarce capital when there are more good projects than funding
â€¢ Organizational discipline â€” higher hurdles filter out marginal proposals

The clean textbook answer is "use WACC." The honest answer is "it's complicated." For this tutorial, we'll take the discount rate as given â€” but know that in practice, choosing the right rate is one of the harder judgment calls in finance.`
  },
  irrVsNpv: {
    id: 'irrVsNpv',
    title: 'IRR vs. NPV',
    partId: 'npvRule',
    content: `You might hear about another measure: Internal Rate of Return (IRR).

IRR asks: "What discount rate would make the NPV exactly zero?"

For our equipment project, the IRR is about 15.2%. This means if the company's cost of capital were 15.2%, the project would just break even.

Since our actual discount rate (8%) is less than the IRR (15.2%), the project has positive NPV. The two methods usually agree on accept/reject decisions.

So why use NPV instead of IRR? NPV has some advantages:
â€¢ It tells you the dollar amount of value created, not just a percentage
â€¢ It handles unusual cash flow patterns better (IRR can give multiple answers)
â€¢ It's easier to add up (NPV of Project A + Project B = combined NPV)

Most finance textbooks recommend NPV as the primary tool, with IRR as a useful supplement.`
  },
};

// ============================================================================
// GLOSSARY
// ============================================================================

const GLOSSARY = {
  npv: {
    term: 'Net Present Value (NPV)',
    definition: 'The present value of all cash flows from an investment, including the initial cost. Positive NPV means the investment creates value.',
  },
  capitalBudgeting: {
    term: 'Capital Budgeting',
    definition: 'The process of evaluating potential investments or projects to decide which ones a company should pursue.',
  },
  costOfCapital: {
    term: 'Cost of Capital',
    definition: 'The return a company must earn on its investments to satisfy its investors. Used as the discount rate in NPV calculations.',
  },
  irr: {
    term: 'Internal Rate of Return (IRR)',
    definition: 'The discount rate that makes the NPV of an investment equal to zero. A project is acceptable if IRR exceeds the cost of capital.',
  },
  annuity: {
    term: 'Annuity',
    definition: 'A series of equal payments made at regular intervals over a specified period.',
  },
  presentValue: {
    term: 'Present Value (PV)',
    definition: 'The current worth of a future sum of money or stream of cash flows, given a specified rate of return.',
  },
  dcf: {
    term: 'Discounted Cash Flow (DCF)',
    definition: 'A valuation method that estimates the value of an investment based on its expected future cash flows, discounted to present value.',
  },
};

// ============================================================================
// SOUND SYSTEM
// ============================================================================

const playSound = (type) => {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = ctx.createOscillator();
    const gainNode = ctx.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(ctx.destination);
    
    switch (type) {
      case 'success':
        // Rising three-note chime (C-E-G)
        oscillator.frequency.setValueAtTime(523.25, ctx.currentTime); // C5
        oscillator.frequency.setValueAtTime(659.25, ctx.currentTime + 0.1); // E5
        oscillator.frequency.setValueAtTime(783.99, ctx.currentTime + 0.2); // G5
        gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.4);
        break;
        
      case 'softNope':
        // Falling two-note (G-E)
        oscillator.frequency.setValueAtTime(783.99, ctx.currentTime); // G5
        oscillator.frequency.setValueAtTime(659.25, ctx.currentTime + 0.1); // E5
        gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.2);
        break;
        
      case 'click':
        // Single quick tone
        oscillator.frequency.setValueAtTime(600, ctx.currentTime);
        gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.05);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.05);
        break;
        
      case 'rabbitHole':
        // Whimsical single tone
        oscillator.frequency.setValueAtTime(880, ctx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(1100, ctx.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
        oscillator.start(ctx.currentTime);
        oscillator.stop(ctx.currentTime + 0.15);
        break;
        
      case 'insight':
        // Gentle ascending arpeggio
        const notes = [523.25, 659.25, 783.99, 1046.50]; // C5-E5-G5-C6
        notes.forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.setValueAtTime(freq, ctx.currentTime + i * 0.08);
          gain.gain.setValueAtTime(0.15, ctx.currentTime + i * 0.08);
          gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.08 + 0.2);
          osc.start(ctx.currentTime + i * 0.08);
          osc.stop(ctx.currentTime + i * 0.08 + 0.2);
        });
        return; // Early return since we created separate oscillators
        
      default:
        return;
    }
    
    setTimeout(() => ctx.close(), 500);
  } catch (e) {
    // Fail silently if audio not available
  }
};

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

const formatCurrency = (value, decimals = 2) => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals,
  }).format(value);
};

const formatNumber = (value, decimals = 0) => {
  return new Intl.NumberFormat('en-US', {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals,
  }).format(value);
};

const parseUserInput = (input) => {
  // Remove $, commas, and whitespace
  const cleaned = input.replace(/[$,\s]/g, '');
  return parseFloat(cleaned);
};

const checkAnswer = (userValue, correctValue, tolerance = CONSTANTS.TOLERANCE_NORMAL) => {
  return Math.abs(userValue - correctValue) <= tolerance;
};

const calculateProgress = (currentPartIndex, currentStep) => {
  // Calculate total steps excluding the Complete part for 100% on complete
  const totalSteps = PARTS.reduce((sum, p, i) => {
    // Don't count the Complete part's step in total for percentage purposes
    return sum + (i < PARTS.length - 1 ? p.steps : 0);
  }, 0);
  
  // If we're on the Complete screen, show 100%
  if (currentPartIndex === PARTS.length - 1) {
    return 100;
  }
  
  const completedSteps = PARTS.slice(0, currentPartIndex).reduce((sum, p) => sum + p.steps, 0) + currentStep;
  return Math.round((completedSteps / totalSteps) * 100);
};

// ============================================================================
// UI COMPONENTS
// ============================================================================

// --- Header Component ---
const Header = ({
  currentPartIndex,
  currentStep,
  exploredRabbitHoles,
  totalRabbitHoles,
  onGlossaryClick,
  onRabbitHoleListClick,
  onRestartClick,
  onHeaderClick,
  soundEnabled,
  onSoundToggle
}) => {
  const progress = calculateProgress(currentPartIndex, currentStep);
  const currentPart = PARTS[currentPartIndex];
  
  return (
    <header style={{
      background: COLORS.primary,
      color: 'white',
      padding: '16px 24px',
      position: 'sticky',
      top: 0,
      zIndex: 100,
    }}>
      <div style={{
        maxWidth: '800px',
        margin: '0 auto',
      }}>
        {/* Title Row */}
        <div style={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '12px',
        }}>
          <h1 
            onClick={onHeaderClick}
            style={{
              fontSize: '18px',
              fontWeight: '600',
              margin: 0,
              cursor: 'default',
              userSelect: 'none',
            }}
          >
            Capital Projects and NPV
          </h1>
          
          <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
            {/* Sound Toggle */}
            <button
              onClick={onSoundToggle}
              style={{
                background: 'rgba(255,255,255,0.1)',
                border: 'none',
                borderRadius: '6px',
                padding: '6px',
                cursor: 'pointer',
                color: 'white',
                display: 'flex',
                alignItems: 'center',
              }}
              title={soundEnabled ? 'Mute sounds' : 'Enable sounds'}
            >
              {soundEnabled ? <LucideIcon name="Volume2" size={18} /> : <LucideIcon name="VolumeX" size={18} />}
            </button>
            
            {/* Rabbit Hole Counter (Clickable) */}
            <button
              onClick={onRabbitHoleListClick}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: '4px',
                background: COLORS.rabbitHoleLight,
                color: COLORS.rabbitHole,
                padding: '4px 10px',
                borderRadius: '12px',
                fontSize: '13px',
                fontWeight: '500',
                border: 'none',
                cursor: 'pointer',
                transition: 'all 0.2s ease',
              }}
              title="View all rabbit holes"
            >
              <LucideIcon name="Rabbit" size={14} />
              <span>{exploredRabbitHoles.length}/{totalRabbitHoles}</span>
            </button>
            
            {/* Glossary Button */}
            <button
              onClick={onGlossaryClick}
              style={{
                background: 'rgba(255,255,255,0.1)',
                border: 'none',
                borderRadius: '6px',
                padding: '6px 10px',
                cursor: 'pointer',
                color: 'white',
                display: 'flex',
                alignItems: 'center',
                gap: '4px',
                fontSize: '13px',
              }}
            >
              <LucideIcon name="BookOpen" size={16} />
              Glossary
            </button>
            
            {/* Restart Button */}
            <button
              onClick={onRestartClick}
              style={{
                background: 'rgba(255,255,255,0.1)',
                border: 'none',
                borderRadius: '6px',
                padding: '6px',
                cursor: 'pointer',
                color: 'white',
                display: 'flex',
                alignItems: 'center',
              }}
              title="Restart tutorial"
            >
              <LucideIcon name="RotateCcw" size={18} />
            </button>
          </div>
        </div>
        
        {/* Progress Section */}
        <div>
          <div style={{
            display: 'flex',
            justifyContent: 'space-between',
            fontSize: '13px',
            marginBottom: '6px',
            opacity: 0.9,
          }}>
            <span>Part {currentPartIndex + 1}: {currentPart.title}</span>
            <span>{progress}% complete</span>
          </div>
          
          {/* Progress Bar */}
          <div style={{
            background: 'rgba(255,255,255,0.2)',
            borderRadius: '4px',
            height: '6px',
            overflow: 'hidden',
          }}>
            <div style={{
              background: COLORS.goldBorder,
              height: '100%',
              width: `${progress}%`,
              transition: 'width 0.3s ease',
              borderRadius: '4px',
            }} />
          </div>
        </div>
      </div>
    </header>
  );
};

// --- Navigation Buttons ---
const NavButtons = ({ 
  onBack, 
  onContinue, 
  canGoBack, 
  canContinue, 
  continueLabel = 'Continue',
  soundEnabled 
}) => {
  const handleContinue = () => {
    if (soundEnabled) playSound('click');
    onContinue();
  };
  
  const handleBack = () => {
    if (soundEnabled) playSound('click');
    onBack();
  };
  
  return (
    <div style={{
      display: 'flex',
      justifyContent: 'space-between',
      marginTop: '32px',
      paddingTop: '24px',
      borderTop: `1px solid ${COLORS.border}`,
    }}>
      <button
        onClick={handleBack}
        disabled={!canGoBack}
        style={{
          display: 'flex',
          alignItems: 'center',
          gap: '6px',
          padding: '12px 20px',
          border: `1px solid ${COLORS.border}`,
          borderRadius: '8px',
          background: 'white',
          color: canGoBack ? COLORS.textPrimary : COLORS.textMuted,
          fontSize: '15px',
          cursor: canGoBack ? 'pointer' : 'not-allowed',
          opacity: canGoBack ? 1 : 0.5,
        }}
      >
        <LucideIcon name="ChevronLeft" size={18} />
        Back
      </button>
      
      <button
        onClick={handleContinue}
        disabled={!canContinue}
        style={{
          display: 'flex',
          alignItems: 'center',
          gap: '6px',
          padding: '12px 24px',
          border: 'none',
          borderRadius: '8px',
          background: canContinue ? COLORS.primary : COLORS.textMuted,
          color: 'white',
          fontSize: '15px',
          fontWeight: '500',
          cursor: canContinue ? 'pointer' : 'not-allowed',
        }}
      >
        {continueLabel}
        <LucideIcon name="ChevronRight" size={18} />
      </button>
    </div>
  );
};

// --- Calculation Box ---
const CalculationBox = ({ 
  prompt, 
  correctAnswer, 
  hint1, 
  hint2, 
  onCorrect,
  soundEnabled,
  tolerance = CONSTANTS.TOLERANCE_NORMAL,
  prefix = '$'
}) => {
  const [input, setInput] = useState('');
  const [attempts, setAttempts] = useState(0);
  const [isCorrect, setIsCorrect] = useState(false);
  const [showHint, setShowHint] = useState(null);
  
  const handleCheck = () => {
    const userValue = parseUserInput(input);
    
    if (isNaN(userValue)) {
      setShowHint('Please enter a valid number');
      return;
    }
    
    if (checkAnswer(userValue, correctAnswer, tolerance)) {
      setIsCorrect(true);
      if (soundEnabled) playSound('success');
      onCorrect?.();
    } else {
      const newAttempts = attempts + 1;
      setAttempts(newAttempts);
      if (soundEnabled) playSound('softNope');
      
      if (newAttempts >= 3) {
        setShowHint(`The answer is ${formatCurrency(correctAnswer, 0)}`);
        setIsCorrect(true); // Allow progression
        onCorrect?.();
      } else if (newAttempts === 2 && hint2) {
        setShowHint(hint2);
      } else if (hint1) {
        setShowHint(hint1);
      }
    }
  };
  
  return (
    <div style={{
      background: COLORS.surfaceAlt,
      border: `1px solid ${COLORS.border}`,
      borderRadius: '12px',
      padding: '20px',
      marginTop: '16px',
    }}>
      <p style={{
        margin: '0 0 16px 0',
        fontSize: '15px',
        color: COLORS.textPrimary,
      }}>
        {prompt}
      </p>
      
      <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
        <div style={{ position: 'relative', flex: 1 }}>
          <span style={{
            position: 'absolute',
            left: '12px',
            top: '50%',
            transform: 'translateY(-50%)',
            color: COLORS.textMuted,
          }}>{prefix}</span>
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            disabled={isCorrect}
            placeholder="0"
            style={{
              width: '100%',
              padding: '12px 12px 12px 28px',
              border: `2px solid ${isCorrect ? COLORS.successBorder : COLORS.border}`,
              borderRadius: '8px',
              fontSize: '16px',
              fontFamily: 'monospace',
              background: isCorrect ? COLORS.successBg : 'white',
              boxSizing: 'border-box',
            }}
            onKeyDown={(e) => e.key === 'Enter' && !isCorrect && handleCheck()}
          />
        </div>
        
        <button
          onClick={handleCheck}
          disabled={isCorrect || !input}
          style={{
            padding: '12px 20px',
            border: 'none',
            borderRadius: '8px',
            background: isCorrect ? COLORS.success : COLORS.primary,
            color: 'white',
            fontSize: '15px',
            fontWeight: '500',
            cursor: isCorrect || !input ? 'default' : 'pointer',
            display: 'flex',
            alignItems: 'center',
            gap: '6px',
          }}
        >
          {isCorrect ? <LucideIcon name="Check" size={18} /> : 'Check'}
        </button>
      </div>
      
      {showHint && (
        <p style={{
          marginTop: '12px',
          padding: '10px 12px',
          background: isCorrect && attempts >= 3 ? COLORS.warningBg : COLORS.accentLight,
          borderRadius: '6px',
          fontSize: '14px',
          color: isCorrect && attempts >= 3 ? COLORS.warning : COLORS.accent,
        }}>
          {showHint}
        </p>
      )}
    </div>
  );
};

// --- Insight Box ---
const InsightBox = ({ children, icon }) => (
  <div style={{
    background: COLORS.goldLight,
    border: `2px solid ${COLORS.goldBorder}`,
    borderRadius: '12px',
    padding: '20px',
    marginTop: '20px',
    marginBottom: '20px',
  }}>
    <div style={{
      display: 'flex',
      gap: '12px',
      alignItems: 'flex-start',
    }}>
      {icon || <LucideIcon name="Lightbulb" size={24} color={COLORS.gold} style={{ flexShrink: 0, marginTop: '2px' }} />}
      <div style={{
        fontSize: '16px',
        lineHeight: '1.6',
        color: COLORS.textPrimary,
      }}>
        {children}
      </div>
    </div>
  </div>
);

// --- Rabbit Hole Button ---
const RabbitHoleButton = ({ 
  rabbitHole, 
  explored, 
  onClick,
  soundEnabled 
}) => {
  const handleClick = () => {
    if (soundEnabled) playSound('rabbitHole');
    onClick();
  };
  
  return (
    <button
      onClick={handleClick}
      style={{
        display: 'flex',
        alignItems: 'center',
        gap: '10px',
        width: '100%',
        padding: '14px 16px',
        border: `2px dashed ${COLORS.rabbitHoleBorder}`,
        borderRadius: '10px',
        background: explored ? COLORS.rabbitHoleLight : 'white',
        color: COLORS.rabbitHole,
        cursor: 'pointer',
        fontSize: '14px',
        textAlign: 'left',
        marginTop: '16px',
        transition: 'all 0.2s ease',
      }}
    >
      <LucideIcon name="Rabbit" size={20} style={{ flexShrink: 0 }} />
      <span style={{ flex: 1 }}>{rabbitHole.title}</span>
      {explored && <LucideIcon name="Check" size={18} />}
    </button>
  );
};

// --- Rabbit Hole Modal ---
const RabbitHoleModal = ({ rabbitHole, onClose }) => {
  if (!rabbitHole) return null;
  
  return (
    <div style={{
      position: 'fixed',
      inset: 0,
      background: 'rgba(0,0,0,0.5)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      padding: '20px',
      zIndex: 1000,
    }}>
      <div style={{
        background: 'white',
        borderRadius: '16px',
        maxWidth: '600px',
        maxHeight: '80vh',
        overflow: 'auto',
        boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
      }}>
        {/* Header */}
        <div style={{
          background: COLORS.rabbitHole,
          color: 'white',
          padding: '20px 24px',
          display: 'flex',
          alignItems: 'center',
          gap: '12px',
        }}>
          <LucideIcon name="Rabbit" size={24} />
          <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600' }}>
            {rabbitHole.title}
          </h2>
        </div>
        
        {/* Content */}
        <div style={{
          padding: '24px',
          fontSize: '15px',
          lineHeight: '1.7',
          color: COLORS.textPrimary,
        }}>
          {rabbitHole.content.split('\n\n').map((paragraph, i) => (
            <p key={i} style={{ margin: i === 0 ? 0 : '16px 0 0 0' }}>
              {paragraph}
            </p>
          ))}
        </div>
        
        {/* Footer */}
        <div style={{
          padding: '16px 24px',
          borderTop: `1px solid ${COLORS.border}`,
          display: 'flex',
          justifyContent: 'flex-end',
        }}>
          <button
            onClick={onClose}
            style={{
              padding: '10px 24px',
              border: 'none',
              borderRadius: '8px',
              background: COLORS.rabbitHole,
              color: 'white',
              fontSize: '15px',
              fontWeight: '500',
              cursor: 'pointer',
            }}
          >
            Back to Tutorial
          </button>
        </div>
      </div>
    </div>
  );
};

// --- Rabbit Hole List Modal ---
const RabbitHoleListModal = ({ exploredRabbitHoles, onSelectRabbitHole, onClose }) => (
  <div style={{
    position: 'fixed',
    inset: 0,
    background: 'rgba(0,0,0,0.5)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    padding: '20px',
    zIndex: 1000,
  }}>
    <div style={{
      background: 'white',
      borderRadius: '16px',
      maxWidth: '500px',
      width: '100%',
      maxHeight: '80vh',
      overflow: 'auto',
      boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
    }}>
      {/* Header */}
      <div style={{
        background: COLORS.rabbitHole,
        color: 'white',
        padding: '20px 24px',
        display: 'flex',
        alignItems: 'center',
        gap: '12px',
      }}>
        <LucideIcon name="Rabbit" size={24} />
        <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600' }}>
          Rabbit Holes
        </h2>
        <span style={{
          marginLeft: 'auto',
          background: 'rgba(255,255,255,0.2)',
          padding: '4px 10px',
          borderRadius: '12px',
          fontSize: '13px',
        }}>
          {exploredRabbitHoles.length}/{Object.keys(RABBIT_HOLES).length} explored
        </span>
      </div>

      {/* Content */}
      <div style={{ padding: '16px' }}>
        {Object.values(RABBIT_HOLES).map((rabbitHole) => {
          const isExplored = exploredRabbitHoles.includes(rabbitHole.id);
          return (
            <button
              key={rabbitHole.id}
              onClick={() => onSelectRabbitHole(rabbitHole)}
              style={{
                display: 'flex',
                alignItems: 'center',
                gap: '12px',
                width: '100%',
                padding: '14px 16px',
                marginBottom: '8px',
                border: `2px solid ${isExplored ? COLORS.rabbitHoleBorder : COLORS.border}`,
                borderRadius: '10px',
                background: isExplored ? COLORS.rabbitHoleLight : 'white',
                color: COLORS.textPrimary,
                cursor: 'pointer',
                textAlign: 'left',
                transition: 'all 0.2s ease',
              }}
            >
              <LucideIcon name="Rabbit" size={20} color={isExplored ? COLORS.rabbitHole : COLORS.textMuted} />
              <span style={{ flex: 1, fontWeight: '500' }}>{rabbitHole.title}</span>
              {isExplored && <LucideIcon name="Check" size={18} color={COLORS.rabbitHole} />}
            </button>
          );
        })}
      </div>

      {/* Footer */}
      <div style={{
        padding: '16px 24px',
        borderTop: `1px solid ${COLORS.border}`,
        display: 'flex',
        justifyContent: 'flex-end',
      }}>
        <button
          onClick={onClose}
          style={{
            padding: '10px 24px',
            border: 'none',
            borderRadius: '8px',
            background: COLORS.rabbitHole,
            color: 'white',
            fontSize: '15px',
            fontWeight: '500',
            cursor: 'pointer',
          }}
        >
          Close
        </button>
      </div>
    </div>
  </div>
);

// --- Glossary Modal ---
const GlossaryModal = ({ onClose }) => (
  <div style={{
    position: 'fixed',
    inset: 0,
    background: 'rgba(0,0,0,0.5)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    padding: '20px',
    zIndex: 1000,
  }}>
    <div style={{
      background: 'white',
      borderRadius: '16px',
      maxWidth: '600px',
      maxHeight: '80vh',
      overflow: 'auto',
      boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
    }}>
      {/* Header */}
      <div style={{
        background: COLORS.primary,
        color: 'white',
        padding: '20px 24px',
        display: 'flex',
        alignItems: 'center',
        gap: '12px',
      }}>
        <LucideIcon name="BookOpen" size={24} />
        <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600' }}>
          Glossary
        </h2>
      </div>
      
      {/* Terms */}
      <div style={{ padding: '16px 24px' }}>
        {Object.values(GLOSSARY).map((item, i) => (
          <div key={item.term} style={{
            padding: '16px 0',
            borderBottom: i < Object.values(GLOSSARY).length - 1 ? `1px solid ${COLORS.border}` : 'none',
          }}>
            <h3 style={{
              margin: '0 0 6px 0',
              fontSize: '16px',
              fontWeight: '600',
              color: COLORS.primary,
            }}>
              {item.term}
            </h3>
            <p style={{
              margin: 0,
              fontSize: '14px',
              lineHeight: '1.5',
              color: COLORS.textSecondary,
            }}>
              {item.definition}
            </p>
          </div>
        ))}
      </div>
      
      {/* Footer */}
      <div style={{
        padding: '16px 24px',
        borderTop: `1px solid ${COLORS.border}`,
        display: 'flex',
        justifyContent: 'flex-end',
      }}>
        <button
          onClick={onClose}
          style={{
            padding: '10px 24px',
            border: 'none',
            borderRadius: '8px',
            background: COLORS.primary,
            color: 'white',
            fontSize: '15px',
            fontWeight: '500',
            cursor: 'pointer',
          }}
        >
          Close
        </button>
      </div>
    </div>
  </div>
);

// --- Restart Confirm Modal ---
const RestartConfirmModal = ({ onConfirm, onCancel }) => (
  <div style={{
    position: 'fixed',
    inset: 0,
    background: 'rgba(0,0,0,0.5)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    padding: '20px',
    zIndex: 1000,
  }}>
    <div style={{
      background: 'white',
      borderRadius: '16px',
      maxWidth: '400px',
      boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
    }}>
      {/* Header */}
      <div style={{
        background: COLORS.warning,
        color: 'white',
        padding: '20px 24px',
        display: 'flex',
        alignItems: 'center',
        gap: '12px',
        borderRadius: '16px 16px 0 0',
      }}>
        <LucideIcon name="RotateCcw" size={24} />
        <h2 style={{ margin: 0, fontSize: '20px', fontWeight: '600' }}>
          Restart Tutorial?
        </h2>
      </div>
      
      {/* Content */}
      <div style={{ padding: '24px' }}>
        <p style={{
          margin: 0,
          fontSize: '15px',
          lineHeight: '1.6',
          color: COLORS.textPrimary,
        }}>
          Are you sure you want to restart? All progress will be lost, including completed calculations and explored rabbit holes.
        </p>
      </div>
      
      {/* Footer */}
      <div style={{
        padding: '16px 24px',
        borderTop: `1px solid ${COLORS.border}`,
        display: 'flex',
        justifyContent: 'flex-end',
        gap: '12px',
      }}>
        <button
          onClick={onCancel}
          style={{
            padding: '10px 20px',
            border: `1px solid ${COLORS.border}`,
            borderRadius: '8px',
            background: 'white',
            color: COLORS.textPrimary,
            fontSize: '15px',
            cursor: 'pointer',
          }}
        >
          Cancel
        </button>
        <button
          onClick={onConfirm}
          style={{
            padding: '10px 20px',
            border: 'none',
            borderRadius: '8px',
            background: COLORS.warning,
            color: 'white',
            fontSize: '15px',
            fontWeight: '500',
            cursor: 'pointer',
          }}
        >
          Restart
        </button>
      </div>
    </div>
  </div>
);

// --- Dev Mode Panel ---
const DevModePanel = ({ onJumpToPart, currentPartIndex, onClose }) => (
  <div style={{
    position: 'fixed',
    bottom: '20px',
    right: '20px',
    background: 'white',
    border: `2px solid ${COLORS.warning}`,
    borderRadius: '12px',
    padding: '16px',
    boxShadow: '0 10px 40px rgba(0,0,0,0.15)',
    zIndex: 999,
    maxHeight: '400px',
    overflow: 'auto',
  }}>
    <div style={{
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: '12px',
    }}>
      <h3 style={{ 
        margin: 0, 
        fontSize: '14px', 
        color: COLORS.warning,
        fontWeight: '600',
      }}>
        ðŸ›  Dev Mode
      </h3>
      <button
        onClick={onClose}
        style={{
          background: 'none',
          border: 'none',
          cursor: 'pointer',
          color: COLORS.textMuted,
        }}
      >
        <LucideIcon name="X" size={18} />
      </button>
    </div>
    
    <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
      {PARTS.map((part, index) => (
        <button
          key={part.id}
          onClick={() => onJumpToPart(index)}
          style={{
            padding: '8px 12px',
            border: `1px solid ${index === currentPartIndex ? COLORS.warning : COLORS.border}`,
            borderRadius: '6px',
            background: index === currentPartIndex ? COLORS.warningBg : 'white',
            color: COLORS.textPrimary,
            fontSize: '13px',
            textAlign: 'left',
            cursor: 'pointer',
          }}
        >
          {index + 1}. {part.title}
        </button>
      ))}
    </div>
  </div>
);

// ============================================================================
// PROJECT CASH FLOW DIAGRAM
// ============================================================================

const ProjectCashFlowDiagram = ({ showPVResult = false, pvResult = null }) => {
  const years = [0, 1, 2, 3, 4, 5];
  const cashFlows = [-CONSTANTS.EQUIP_COST, ...Array(5).fill(CONSTANTS.EQUIP_ANNUAL_CF)];
  
  return (
    <div style={{
      background: COLORS.surfaceAlt,
      borderRadius: '12px',
      padding: '24px',
      marginTop: '16px',
      marginBottom: '16px',
      overflowX: 'auto',
    }}>
      <div style={{ 
        fontSize: '14px', 
        fontWeight: '600', 
        color: COLORS.textSecondary, 
        marginBottom: '20px',
        textAlign: 'center'
      }}>
        Equipment Project Cash Flows
      </div>
      
      <div style={{
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'flex-end',
        position: 'relative',
        minHeight: '150px',
        paddingBottom: '40px',
        minWidth: '500px',
      }}>
        {/* Timeline line */}
        <div style={{
          position: 'absolute',
          bottom: '20px',
          left: '40px',
          right: '40px',
          height: '2px',
          background: COLORS.borderDark,
        }} />
        
        {/* Arrow at end */}
        <div style={{
          position: 'absolute',
          bottom: '16px',
          right: '35px',
          width: 0,
          height: 0,
          borderTop: '5px solid transparent',
          borderBottom: '5px solid transparent',
          borderLeft: `8px solid ${COLORS.borderDark}`,
        }} />
        
        {/* Cash flow points */}
        {years.map((year, i) => {
          const cf = cashFlows[i];
          const isNegative = cf < 0;
          
          return (
            <div key={year} style={{
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              flex: 1,
              position: 'relative',
            }}>
              {/* Cash flow amount */}
              <div style={{
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                marginBottom: isNegative ? '8px' : '8px',
              }}>
                {/* Arrow indicator */}
                <div style={{
                  marginBottom: '4px',
                }}>
                  {isNegative ? (
                    <LucideIcon name="ArrowDown" size={20} color={COLORS.negativeColor} />
                  ) : (
                    <div style={{ transform: 'rotate(180deg)' }}>
                      <LucideIcon name="ArrowDown" size={20} color={COLORS.positiveColor} />
                    </div>
                  )}
                </div>
                
                {/* Amount box */}
                <div style={{
                  background: isNegative ? COLORS.negativeColorLight : COLORS.positiveColorLight,
                  border: `2px solid ${isNegative ? COLORS.negativeColor : COLORS.positiveColor}`,
                  borderRadius: '8px',
                  padding: '8px 12px',
                  fontFamily: 'monospace',
                  fontSize: '14px',
                  fontWeight: '600',
                  color: isNegative ? COLORS.negativeColor : COLORS.positiveColor,
                }}>
                  {isNegative ? 'âˆ’' : '+'}{formatCurrency(Math.abs(cf), 0)}
                </div>
              </div>
              
              {/* Timeline dot */}
              <div style={{
                width: '12px',
                height: '12px',
                borderRadius: '50%',
                background: isNegative ? COLORS.negativeColor : COLORS.positiveColor,
                border: '2px solid white',
                position: 'absolute',
                bottom: '14px',
              }} />
              
              {/* Year label */}
              <span style={{
                position: 'absolute',
                bottom: '-8px',
                fontSize: '13px',
                color: COLORS.textSecondary,
                fontWeight: '500',
              }}>
                Year {year}
              </span>
            </div>
          );
        })}
      </div>
      
      {/* Optional NPV result display */}
      {showPVResult && pvResult !== null && (
        <div style={{
          marginTop: '16px',
          paddingTop: '16px',
          borderTop: `1px solid ${COLORS.border}`,
          textAlign: 'center',
        }}>
          <span style={{ color: COLORS.textSecondary, fontSize: '14px' }}>
            Net Present Value = 
          </span>
          <span style={{ 
            marginLeft: '8px',
            fontFamily: 'monospace',
            fontSize: '20px',
            fontWeight: '600',
            color: pvResult >= 0 ? COLORS.positiveColor : COLORS.negativeColor,
          }}>
            {formatCurrency(pvResult, 0)}
          </span>
        </div>
      )}
    </div>
  );
};

// ============================================================================
// RECAP CARD COMPONENT
// ============================================================================

const RecapCard = ({ icon: Icon, title, value, color, colorLight }) => (
  <div style={{
    background: colorLight,
    border: `2px solid ${color}`,
    borderRadius: '12px',
    padding: '16px 20px',
    display: 'flex',
    alignItems: 'center',
    gap: '16px',
    flex: 1,
  }}>
    <div style={{
      background: 'white',
      borderRadius: '10px',
      padding: '10px',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
    }}>
      <Icon size={28} color={color} />
    </div>
    <div>
      <div style={{ 
        fontSize: '13px', 
        color: COLORS.textSecondary,
        marginBottom: '4px',
      }}>
        {title}
      </div>
      <div style={{
        fontSize: '20px',
        fontWeight: '600',
        fontFamily: 'monospace',
        color: color,
      }}>
        {value}
      </div>
    </div>
  </div>
);

// ============================================================================
// NPV DECISION BOX COMPONENT
// ============================================================================

const NPVDecisionBox = () => (
  <div style={{
    background: 'white',
    border: `2px solid ${COLORS.border}`,
    borderRadius: '12px',
    padding: '24px',
    marginTop: '20px',
  }}>
    <h3 style={{ 
      margin: '0 0 16px 0', 
      fontSize: '16px', 
      fontWeight: '600',
      color: COLORS.textPrimary,
      textAlign: 'center',
    }}>
      The NPV Decision Rule
    </h3>
    
    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
      {/* Positive NPV */}
      <div style={{
        display: 'flex',
        alignItems: 'center',
        gap: '16px',
        padding: '14px 16px',
        background: COLORS.positiveColorLight,
        borderRadius: '8px',
        border: `1px solid ${COLORS.positiveColor}`,
      }}>
        <LucideIcon name="CheckCircle" size={28} color={COLORS.positiveColor} />
        <div style={{ flex: 1 }}>
          <div style={{ 
            fontWeight: '600', 
            color: COLORS.positiveColor,
            marginBottom: '2px',
          }}>
            NPV &gt; 0
          </div>
          <div style={{ fontSize: '14px', color: COLORS.textSecondary }}>
            Project creates value â†’ <strong>Invest</strong>
          </div>
        </div>
      </div>
      
      {/* Negative NPV */}
      <div style={{
        display: 'flex',
        alignItems: 'center',
        gap: '16px',
        padding: '14px 16px',
        background: COLORS.negativeColorLight,
        borderRadius: '8px',
        border: `1px solid ${COLORS.negativeColor}`,
      }}>
        <LucideIcon name="XCircle" size={28} color={COLORS.negativeColor} />
        <div style={{ flex: 1 }}>
          <div style={{ 
            fontWeight: '600', 
            color: COLORS.negativeColor,
            marginBottom: '2px',
          }}>
            NPV &lt; 0
          </div>
          <div style={{ fontSize: '14px', color: COLORS.textSecondary }}>
            Project destroys value â†’ <strong>Don't invest</strong>
          </div>
        </div>
      </div>
      
      {/* Zero NPV */}
      <div style={{
        display: 'flex',
        alignItems: 'center',
        gap: '16px',
        padding: '14px 16px',
        background: COLORS.warningBg,
        borderRadius: '8px',
        border: `1px solid ${COLORS.warning}`,
      }}>
        <LucideIcon name="MinusCircle" size={28} color={COLORS.warning} />
        <div style={{ flex: 1 }}>
          <div style={{ 
            fontWeight: '600', 
            color: COLORS.warning,
            marginBottom: '2px',
          }}>
            NPV = 0
          </div>
          <div style={{ fontSize: '14px', color: COLORS.textSecondary }}>
            Project breaks even â†’ <strong>Indifferent</strong>
          </div>
        </div>
      </div>
    </div>
  </div>
);

// ============================================================================
// THREE ASSET COMPARISON COMPONENT
// ============================================================================

const ThreeAssetComparison = () => {
  const assets = [
    {
      icon: FileText,
      title: 'Bond',
      color: COLORS.bondColor,
      colorLight: COLORS.bondColorLight,
      attributes: [
        { label: 'Cash Flows', value: 'Contractual' },
        { label: 'Initial Cost', value: '$100 (purchase)' },
        { label: 'Horizon', value: '3 years' },
        { label: 'Discount Rate', value: '6%' },
        { label: 'Method', value: 'DCF' },
        { label: 'Value', value: formatCurrency(CONSTANTS.BOND_PV, 0) },
      ],
    },
    {
      icon: Coffee,
      title: 'Business',
      color: COLORS.businessColor,
      colorLight: COLORS.businessColorLight,
      attributes: [
        { label: 'Cash Flows', value: 'Projected' },
        { label: 'Initial Cost', value: 'â€”' },
        { label: 'Horizon', value: 'Forever (via TV)' },
        { label: 'Discount Rate', value: '10%' },
        { label: 'Method', value: 'DCF' },
        { label: 'Value', value: formatCurrency(CONSTANTS.COFFEE_TOTAL_PV, 0) },
      ],
    },
    {
      icon: Factory,
      title: 'Project',
      color: COLORS.projectColor,
      colorLight: COLORS.projectColorLight,
      attributes: [
        { label: 'Cash Flows', value: 'Projected' },
        { label: 'Initial Cost', value: `âˆ’${formatCurrency(CONSTANTS.EQUIP_COST, 0)}` },
        { label: 'Horizon', value: '5 years' },
        { label: 'Discount Rate', value: '8%' },
        { label: 'Method', value: 'DCF' },
        { label: 'NPV', value: formatCurrency(CONSTANTS.EQUIP_NPV, 0) },
      ],
    },
  ];
  
  return (
    <div style={{
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fit, minmax(220px, 1fr))',
      gap: '16px',
      marginTop: '20px',
    }}>
      {assets.map((asset) => {
        const Icon = asset.icon;
        return (
          <div key={asset.title} style={{
            background: asset.colorLight,
            border: `2px solid ${asset.color}`,
            borderRadius: '12px',
            overflow: 'hidden',
          }}>
            {/* Card Header */}
            <div style={{
              background: asset.color,
              padding: '16px',
              display: 'flex',
              alignItems: 'center',
              gap: '12px',
            }}>
              <div style={{
                background: 'rgba(255,255,255,0.2)',
                borderRadius: '8px',
                padding: '8px',
                display: 'flex',
              }}>
                <Icon size={24} color="white" />
              </div>
              <h3 style={{ 
                margin: 0, 
                color: 'white', 
                fontSize: '18px',
                fontWeight: '600',
              }}>
                {asset.title}
              </h3>
            </div>
            
            {/* Card Body */}
            <div style={{ padding: '16px' }}>
              {asset.attributes.map((attr, i) => (
                <div key={attr.label} style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  padding: '8px 0',
                  borderBottom: i < asset.attributes.length - 1 ? `1px solid ${asset.color}30` : 'none',
                }}>
                  <span style={{ 
                    fontSize: '13px', 
                    color: COLORS.textSecondary,
                  }}>
                    {attr.label}
                  </span>
                  <span style={{ 
                    fontSize: '13px', 
                    fontWeight: '600',
                    color: attr.label === 'NPV' || attr.label === 'Value' ? asset.color : COLORS.textPrimary,
                    fontFamily: attr.label === 'NPV' || attr.label === 'Value' || attr.label === 'Initial Cost' ? 'monospace' : 'inherit',
                  }}>
                    {attr.value}
                  </span>
                </div>
              ))}
            </div>
          </div>
        );
      })}
    </div>
  );
};

// ============================================================================
// PART CONTENT COMPONENTS
// ============================================================================

// --- Part 0: Quick Recap ---
const QuickRecapPart = ({ step, onContinue, onBack, canGoBack, soundEnabled }) => {
  return (
    <div style={{
      background: 'white',
      borderRadius: '16px',
      padding: '32px',
      boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
    }}>
      <h2 style={{ 
        color: COLORS.primary, 
        marginBottom: '16px',
        marginTop: 0,
        fontSize: '24px',
      }}>
        Quick Recap
      </h2>
      
      <p style={{ 
        color: COLORS.textSecondary, 
        lineHeight: 1.7,
        fontSize: '16px',
      }}>
        In the previous tutorials, you valued two different assets using <strong>Discounted Cash Flow (DCF)</strong> analysis:
      </p>
      
      <div style={{
        display: 'flex',
        gap: '16px',
        marginTop: '24px',
        marginBottom: '24px',
        flexWrap: 'wrap',
      }}>
        <RecapCard 
          icon={FileText}
          title="3-Year Bond"
          value={formatCurrency(CONSTANTS.BOND_PV, 0)}
          color={COLORS.bondColor}
          colorLight={COLORS.bondColorLight}
        />
        <RecapCard 
          icon={Coffee}
          title="Coffee Shop"
          value={formatCurrency(CONSTANTS.COFFEE_TOTAL_PV, 0)}
          color={COLORS.businessColor}
          colorLight={COLORS.businessColorLight}
        />
      </div>
      
      <p style={{ 
        color: COLORS.textSecondary, 
        lineHeight: 1.7,
        fontSize: '16px',
      }}>
        Same method for both: <strong>discount future cash flows to today, then add them up</strong>.
      </p>
      
      <p style={{ 
        color: COLORS.textSecondary, 
        lineHeight: 1.7,
        fontSize: '16px',
        marginTop: '16px',
      }}>
        Now let's see DCF applied to a different kind of decision...
      </p>
      
      <NavButtons
        onBack={onBack}
        onContinue={onContinue}
        canGoBack={canGoBack}
        canContinue={true}
        soundEnabled={soundEnabled}
      />
    </div>
  );
};

// --- Part 1: A New Question ---
const ANewQuestionPart = ({ step, onContinue, onBack, canGoBack, soundEnabled }) => {
  if (step === 0) {
    return (
      <div style={{
        background: 'white',
        borderRadius: '16px',
        padding: '32px',
        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
      }}>
        <h2 style={{ 
          color: COLORS.primary, 
          marginBottom: '16px',
          marginTop: 0,
          fontSize: '24px',
        }}>
          A Different Kind of Question
        </h2>
        
        <p style={{ 
          color: COLORS.textSecondary, 
          lineHeight: 1.7,
          fontSize: '16px',
        }}>
          Imagine you're a manager at a manufacturing company.
        </p>
        
        <p style={{ 
          color: COLORS.textSecondary, 
          lineHeight: 1.7,
          fontSize: '16px',
          marginTop: '16px',
        }}>
          Your team proposes buying new equipment that would increase efficiency and profits. The question isn't <em>"what is this equipment worth?"</em> â€” it's:
        </p>
        
        <div style={{
          background: COLORS.projectColorLight,
          border: `2px solid ${COLORS.projectColor}`,
          borderRadius: '12px',
          padding: '24px',
          marginTop: '20px',
          textAlign: 'center',
        }}>
          <LucideIcon name="Factory" size={40} color={COLORS.projectColor} style={{ marginBottom: '12px' }} />
          <p style={{ 
            fontSize: '20px', 
            fontWeight: '600', 
            color: COLORS.projectColor,
            margin: 0,
          }}>
            "Should we do this?"
          </p>
        </div>
        
        <p style={{ 
          color: COLORS.textSecondary, 
          lineHeight: 1.7,
          fontSize: '16px',
          marginTop: '20px',
        }}>
          This is called a <strong>capital budgeting decision</strong> â€” deciding whether to invest in a project or piece of equipment.
        </p>
        
        <NavButtons
          onBack={onBack}
          onContinue={onContinue}
          canGoBack={canGoBack}
          canContinue={true}
          soundEnabled={soundEnabled}
        />
      </div>
    );
  }
  
  // Step 1: The Equipment Proposal
  return (
    <div style={{
      background: 'white',
      borderRadius: '16px',
      padding: '32px',
      boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
    }}>
      <h2 style={{ 
        color: COLORS.primary, 
        marginBottom: '16px',
        marginTop: 0,
        fontSize: '24px',
      }}>
        The Equipment Proposal
      </h2>
      
      <p style={{ 
        color: COLORS.textSecondary, 
        lineHeight: 1.7,
        fontSize: '16px',
      }}>
        Here's the proposal your team has put together:
      </p>
      
      <div style={{
        background: 'white',
        border: `2px solid ${COLORS.projectColor}`,
        borderRadius: '12px',
        padding: '20px',
        marginTop: '20px',
      }}>
        <div style={{ 
          display: 'flex', 
          alignItems: 'center', 
          gap: '10px', 
          marginBottom: '16px' 
        }}>
          <LucideIcon name="Factory" size={24} color={COLORS.projectColor} />
          <span style={{ 
            fontWeight: '600', 
            color: COLORS.projectColor, 
            fontSize: '17px' 
          }}>
            New Equipment Purchase
          </span>
        </div>
        
        <div style={{ fontSize: '15px' }}>
          <div style={{ 
            display: 'grid', 
            gridTemplateColumns: 'auto 1fr', 
            gap: '8px 16px', 
            marginBottom: '16px' 
          }}>
            <span style={{ color: COLORS.textSecondary }}>Purchase cost (Year 0):</span>
            <span style={{ 
              fontWeight: '600', 
              color: COLORS.negativeColor 
            }}>
              âˆ’{formatCurrency(CONSTANTS.EQUIP_COST, 0)}
            </span>
            
            <span style={{ color: COLORS.textSecondary }}>Annual profit increase (Years 1-5):</span>
            <span style={{ 
              fontWeight: '600', 
              color: COLORS.positiveColor 
            }}>
              +{formatCurrency(CONSTANTS.EQUIP_ANNUAL_CF, 0)}/year
            </span>
          </div>
          
          <div style={{ 
            paddingTop: '12px', 
            borderTop: `1px solid ${COLORS.border}`, 
            display: 'flex', 
            justifyContent: 'space-between' 
          }}>
            <span style={{ color: COLORS.textSecondary }}>Discount Rate:</span>
            <span style={{ fontWeight: '600' }}>{(CONSTANTS.EQUIP_RATE * 100).toFixed(0)}% per year</span>
          </div>
        </div>
      </div>
      
      <InsightBox icon={<LucideIcon name="HelpCircle" size={24} color={COLORS.gold} style={{ flexShrink: 0, marginTop: '2px' }} />}>
        Notice the <strong style={{ color: COLORS.negativeColor }}>negative</strong> cash flow at Year 0. You have to <em>pay</em> for the equipment before you can benefit from it. This is what makes it an <strong>investment</strong>.
      </InsightBox>
      
      <ProjectCashFlowDiagram />
      
      <NavButtons
        onBack={onBack}
        onContinue={onContinue}
        canGoBack={canGoBack}
        canContinue={true}
        soundEnabled={soundEnabled}
      />
    </div>
  );
};

// --- Part 2: The Equipment Decision ---
const EquipmentDecisionPart = ({ 
  step, 
  onContinue, 
  onBack, 
  canGoBack, 
  soundEnabled,
  calcCompleted,
  onCalcComplete,
  onRabbitHole,
  exploredRabbitHoles
}) => {
  // Step 0: The Inflows
  if (step === 0) {
    return (
      <div style={{
        background: 'white',
        borderRadius: '16px',
        padding: '32px',
        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
      }}>
        <h2 style={{ 
          color: COLORS.primary, 
          marginBottom: '16px',
          marginTop: 0,
          fontSize: '24px',
        }}>
          Step 1: Value the Inflows
        </h2>
        
        <p style={{ 
          color: COLORS.textSecondary, 
          lineHeight: 1.7,
          fontSize: '16px',
        }}>
          The {formatCurrency(CONSTANTS.EQUIP_ANNUAL_CF, 0)} annual profit is an <strong>annuity</strong> â€” equal payments for 5 years. You learned how to value these in earlier tutorials.
        </p>
        
        <div style={{
          background: COLORS.surfaceAlt,
          border: `1px solid ${COLORS.border}`,
          borderRadius: '12px',
          padding: '20px',
          marginTop: '16px',
        }}>
          <div style={{ 
            fontSize: '14px',
            color: COLORS.textSecondary,
            marginBottom: '12px',
          }}>
            Using the annuity present value method from earlier:
          </div>
          <div style={{ 
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            flexWrap: 'wrap',
            gap: '8px',
          }}>
            <span style={{ color: COLORS.textSecondary }}>5 years at 8% gives a factor of:</span>
            <span style={{ 
              fontFamily: 'monospace',
              fontSize: '18px',
              fontWeight: '600',
              color: COLORS.textPrimary,
            }}>
              {CONSTANTS.EQUIP_ANNUITY_FACTOR}
            </span>
          </div>
        </div>
        
        <p style={{ 
          color: COLORS.textSecondary, 
          lineHeight: 1.7,
          fontSize: '16px',
          marginTop: '16px',
        }}>
          So the present value of the inflows is:
        </p>
        
        <div style={{
          background: COLORS.surfaceAlt,
          borderRadius: '8px',
          padding: '12px 16px',
          fontFamily: 'monospace',
          fontSize: '15px',
          textAlign: 'center',
          marginTop: '8px',
        }}>
          PV of Inflows = {formatCurrency(CONSTANTS.EQUIP_ANNUAL_CF, 0)} Ã— {CONSTANTS.EQUIP_ANNUITY_FACTOR} = ?
        </div>
        
        <CalculationBox
          prompt="What is the present value of the $15,000 annual inflows?"
          correctAnswer={CONSTANTS.EQUIP_INFLOW_PV}
          hint1={`Multiply ${formatCurrency(CONSTANTS.EQUIP_ANNUAL_CF, 0)} by the factor (${CONSTANTS.EQUIP_ANNUITY_FACTOR})`}
          hint2={`${formatCurrency(CONSTANTS.EQUIP_ANNUAL_CF, 0)} Ã— ${CONSTANTS.EQUIP_ANNUITY_FACTOR} = ${formatNumber(CONSTANTS.EQUIP_INFLOW_PV)}`}
          tolerance={CONSTANTS.TOLERANCE_NORMAL}
          onCorrect={() => onCalcComplete('inflowPV')}
          soundEnabled={soundEnabled}
        />
        
        <NavButtons
          onBack={onBack}
          onContinue={onContinue}
          canGoBack={canGoBack}
          canContinue={calcCompleted.inflowPV}
          soundEnabled={soundEnabled}
        />
      </div>
    );
  }
  
  // Step 1: The Net Value
  if (step === 1) {
    return (
      <div style={{
        background: 'white',
        borderRadius: '16px',
        padding: '32px',
        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
      }}>
        <h2 style={{ 
          color: COLORS.primary, 
          marginBottom: '16px',
          marginTop: 0,
          fontSize: '24px',
        }}>
          Step 2: Calculate the Net Value
        </h2>
        
        <p style={{ 
          color: COLORS.textSecondary, 
          lineHeight: 1.7,
          fontSize: '16px',
        }}>
          Now combine the outflow and inflows:
        </p>
        
        <div style={{
          background: COLORS.surfaceAlt,
          borderRadius: '12px',
          padding: '20px',
          marginTop: '16px',
        }}>
          <div style={{ 
            display: 'flex', 
            justifyContent: 'center', 
            alignItems: 'center', 
            gap: '16px',
            flexWrap: 'wrap',
          }}>
            <div style={{
              background: COLORS.negativeColorLight,
              border: `2px solid ${COLORS.negativeColor}`,
              borderRadius: '8px',
              padding: '12px 16px',
              textAlign: 'center',
            }}>
              <div style={{ fontSize: '12px', color: COLORS.textSecondary, marginBottom: '4px' }}>
                Initial Cost
              </div>
              <div style={{ 
                fontFamily: 'monospace', 
                fontSize: '18px', 
                fontWeight: '600',
                color: COLORS.negativeColor,
              }}>
                âˆ’{formatCurrency(CONSTANTS.EQUIP_COST, 0)}
              </div>
            </div>
            
            <span style={{ fontSize: '24px', color: COLORS.textMuted }}>+</span>
            
            <div style={{
              background: COLORS.positiveColorLight,
              border: `2px solid ${COLORS.positiveColor}`,
              borderRadius: '8px',
              padding: '12px 16px',
              textAlign: 'center',
            }}>
              <div style={{ fontSize: '12px', color: COLORS.textSecondary, marginBottom: '4px' }}>
                PV of Inflows
              </div>
              <div style={{ 
                fontFamily: 'monospace', 
                fontSize: '18px', 
                fontWeight: '600',
                color: COLORS.positiveColor,
              }}>
                +{formatCurrency(CONSTANTS.EQUIP_INFLOW_PV, 0)}
              </div>
            </div>
            
            <span style={{ fontSize: '24px', color: COLORS.textMuted }}>=</span>
            
            <div style={{
              background: COLORS.goldLight,
              border: `2px solid ${COLORS.goldBorder}`,
              borderRadius: '8px',
              padding: '12px 16px',
              textAlign: 'center',
            }}>
              <div style={{ fontSize: '12px', color: COLORS.textSecondary, marginBottom: '4px' }}>
                NPV
              </div>
              <div style={{ 
                fontFamily: 'monospace', 
                fontSize: '18px', 
                fontWeight: '600',
                color: COLORS.gold,
              }}>
                ?
              </div>
            </div>
          </div>
        </div>
        
        <CalculationBox
          prompt="What is the Net Present Value (NPV) of this project?"
          correctAnswer={CONSTANTS.EQUIP_NPV}
          hint1="Add the initial cost (negative) to the PV of inflows"
          hint2={`âˆ’${formatCurrency(CONSTANTS.EQUIP_COST, 0)} + ${formatCurrency(CONSTANTS.EQUIP_INFLOW_PV, 0)} = ?`}
          tolerance={CONSTANTS.TOLERANCE_NORMAL}
          onCorrect={() => onCalcComplete('npv')}
          soundEnabled={soundEnabled}
        />
        
        <NavButtons
          onBack={onBack}
          onContinue={onContinue}
          canGoBack={canGoBack}
          canContinue={calcCompleted.npv}
          soundEnabled={soundEnabled}
        />
      </div>
    );
  }
  
  // Step 2: The Verdict
  return (
    <div style={{
      background: 'white',
      borderRadius: '16px',
      padding: '32px',
      boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
    }}>
      <h2 style={{ 
        color: COLORS.primary, 
        marginBottom: '16px',
        marginTop: 0,
        fontSize: '24px',
      }}>
        The Verdict
      </h2>
      
      <InsightBox>
        <strong>The project has a positive NPV of {formatCurrency(CONSTANTS.EQUIP_NPV, 0)}!</strong>
        <br /><br />
        This means the present value of benefits exceeds the cost. The project <strong>creates value</strong> â€” you should invest.
      </InsightBox>
      
      <ProjectCashFlowDiagram showPVResult={true} pvResult={CONSTANTS.EQUIP_NPV} />
      
      <p style={{ 
        color: COLORS.textSecondary, 
        lineHeight: 1.7,
        fontSize: '16px',
      }}>
        Think of it this way: if you could borrow {formatCurrency(CONSTANTS.EQUIP_COST, 0)} at 8% to buy this equipment, the cash flows would more than cover the loan payments â€” and you'd still have {formatCurrency(CONSTANTS.EQUIP_NPV, 0)} of value left over.
      </p>
      
      <RabbitHoleButton
        rabbitHole={RABBIT_HOLES.discountRates}
        explored={exploredRabbitHoles.includes('discountRates')}
        onClick={() => onRabbitHole('discountRates')}
        soundEnabled={soundEnabled}
      />
      
      <NavButtons
        onBack={onBack}
        onContinue={onContinue}
        canGoBack={canGoBack}
        canContinue={true}
        soundEnabled={soundEnabled}
      />
    </div>
  );
};

// --- Part 3: The NPV Rule ---
const NPVRulePart = ({ 
  step, 
  onContinue, 
  onBack, 
  canGoBack, 
  soundEnabled,
  onRabbitHole,
  exploredRabbitHoles
}) => {
  // Step 0: The Decision Rule
  if (step === 0) {
    return (
      <div style={{
        background: 'white',
        borderRadius: '16px',
        padding: '32px',
        boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
      }}>
        <h2 style={{ 
          color: COLORS.primary, 
          marginBottom: '16px',
          marginTop: 0,
          fontSize: '24px',
        }}>
          The Decision Rule
        </h2>
        
        <p style={{ 
          color: COLORS.textSecondary, 
          lineHeight: 1.7,
          fontSize: '16px',
        }}>
          We've just applied what's called the <strong>NPV Rule</strong> â€” the cornerstone of capital budgeting decisions:
        </p>
        
        <NPVDecisionBox />
        
        <p style={{ 
          color: COLORS.textSecondary, 
          lineHeight: 1.7,
          fontSize: '16px',
          marginTop: '20px',
        }}>
          This is how businesses evaluate capital investments. Whether it's buying equipment, building a factory, or launching a new product line â€” the question is always: <strong>Is the NPV positive?</strong>
        </p>
        
        <NavButtons
          onBack={onBack}
          onContinue={onContinue}
          canGoBack={canGoBack}
          canContinue={true}
          soundEnabled={soundEnabled}
        />
      </div>
    );
  }
  
  // Step 1: Why It Works
  return (
    <div style={{
      background: 'white',
      borderRadius: '16px',
      padding: '32px',
      boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
    }}>
      <h2 style={{ 
        color: COLORS.primary, 
        marginBottom: '16px',
        marginTop: 0,
        fontSize: '24px',
      }}>
        Why the NPV Rule Works
      </h2>
      
      <p style={{ 
        color: COLORS.textSecondary, 
        lineHeight: 1.7,
        fontSize: '16px',
      }}>
        NPV tells you the <strong>dollar amount</strong> of value created or destroyed by a project.
      </p>
      
      <div style={{
        background: COLORS.surfaceAlt,
        borderRadius: '12px',
        padding: '20px',
        marginTop: '16px',
      }}>
        <p style={{ 
          margin: 0,
          fontSize: '15px',
          lineHeight: 1.7,
          color: COLORS.textPrimary,
        }}>
          When we calculated NPV = <strong style={{ color: COLORS.positiveColor }}>{formatCurrency(CONSTANTS.EQUIP_NPV, 0)}</strong>, this means:
        </p>
        <ul style={{ 
          margin: '12px 0 0 0', 
          paddingLeft: '20px',
          color: COLORS.textSecondary,
          lineHeight: 1.7,
        }}>
          <li>Shareholders are <strong style={{ color: COLORS.positiveColor }}>{formatCurrency(CONSTANTS.EQUIP_NPV, 0)} better off</strong> if the company invests</li>
          <li>The project returns more than the 8% cost of capital</li>
          <li>There's a clear "yes" signal for this investment</li>
        </ul>
      </div>
      
      <p style={{ 
        color: COLORS.textSecondary, 
        lineHeight: 1.7,
        fontSize: '16px',
        marginTop: '20px',
      }}>
        The discount rate reflects <strong>opportunity cost</strong> â€” what the company could earn on similar-risk investments elsewhere. A positive NPV means this project beats that alternative.
      </p>
      
      <RabbitHoleButton
        rabbitHole={RABBIT_HOLES.irrVsNpv}
        explored={exploredRabbitHoles.includes('irrVsNpv')}
        onClick={() => onRabbitHole('irrVsNpv')}
        soundEnabled={soundEnabled}
      />
      
      <NavButtons
        onBack={onBack}
        onContinue={onContinue}
        canGoBack={canGoBack}
        canContinue={true}
        soundEnabled={soundEnabled}
      />
    </div>
  );
};

// --- Part 4: Three Assets Compared ---
const ThreeAssetsComparedPart = ({ 
  step, 
  onContinue, 
  onBack, 
  canGoBack, 
  soundEnabled 
}) => {
  return (
    <div style={{
      background: 'white',
      borderRadius: '16px',
      padding: '32px',
      boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
    }}>
      <h2 style={{ 
        color: COLORS.primary, 
        marginBottom: '16px',
        marginTop: 0,
        fontSize: '24px',
      }}>
        Same Framework, Different Contexts
      </h2>
      
      <p style={{ 
        color: COLORS.textSecondary, 
        lineHeight: 1.7,
        fontSize: '16px',
      }}>
        Look at the three assets you've valued across the recent tutorials:
      </p>
      
      <ThreeAssetComparison />
      
      <InsightBox>
        <strong>DCF doesn't just tell you what something is worth â€” it tells you whether an action creates or destroys value.</strong>
        <br /><br />
        The same framework applies to bonds, businesses, and capital projects. The only differences are the cash flows, time horizons, and discount rates.
      </InsightBox>
      
      <NavButtons
        onBack={onBack}
        onContinue={onContinue}
        canGoBack={canGoBack}
        canContinue={true}
        soundEnabled={soundEnabled}
      />
    </div>
  );
};

// --- Part 5: Complete ---
const CompletePart = ({ 
  step, 
  onContinue, 
  onBack, 
  canGoBack, 
  soundEnabled,
  calcCompleted,
  exploredRabbitHoles,
  onRabbitHole
}) => {
  const totalCalcs = Object.keys(calcCompleted).length;
  const completedCalcs = Object.values(calcCompleted).filter(Boolean).length;
  const totalRabbitHoles = Object.keys(RABBIT_HOLES).length;
  const exploredCount = exploredRabbitHoles.length;
  
  return (
    <div style={{
      background: 'white',
      borderRadius: '16px',
      padding: '32px',
      boxShadow: '0 2px 8px rgba(0,0,0,0.06)',
    }}>
      {/* Celebration Header */}
      <div style={{ textAlign: 'center', marginBottom: '32px' }}>
        <div style={{
          display: 'inline-flex',
          alignItems: 'center',
          justifyContent: 'center',
          width: '64px',
          height: '64px',
          background: COLORS.goldLight,
          borderRadius: '50%',
          marginBottom: '16px',
        }}>
          <LucideIcon name="Award" size={36} color={COLORS.gold} />
        </div>
        
        <h2 style={{ 
          color: COLORS.primary, 
          marginBottom: '8px',
          marginTop: 0,
          fontSize: '28px',
        }}>
          Tutorial Complete!
        </h2>
        
        <p style={{
          color: COLORS.textSecondary,
          fontSize: '16px',
          margin: 0,
        }}>
          You've learned to use DCF for decision-making.
        </p>
      </div>
      
      {/* Key Takeaways */}
      <div style={{
        background: COLORS.goldLight,
        border: `2px solid ${COLORS.goldBorder}`,
        borderRadius: '12px',
        padding: '24px',
        marginBottom: '24px',
      }}>
        <h3 style={{ 
          margin: '0 0 16px 0', 
          fontSize: '18px', 
          fontWeight: '600',
          color: COLORS.gold,
          display: 'flex',
          alignItems: 'center',
          gap: '8px',
        }}>
          <LucideIcon name="Lightbulb" size={20} />
          Key Takeaways
        </h3>
        
        <ul style={{ 
          margin: 0, 
          paddingLeft: '20px',
          color: COLORS.textPrimary,
          lineHeight: 1.8,
          fontSize: '15px',
        }}>
          <li><strong>Cash flows can be negative</strong> â€” DCF handles investments just like receipts</li>
          <li><strong>NPV = Present Value of all cash flows</strong> (positive and negative)</li>
          <li><strong>Positive NPV means value creation</strong> â€” the project is worth doing</li>
          <li><strong>Same DCF framework</strong> applies to valuation AND decision-making</li>
        </ul>
      </div>
      
      {/* Stats Display */}
      <div style={{
        display: 'flex',
        gap: '16px',
        marginBottom: '24px',
        flexWrap: 'wrap',
      }}>
        <div style={{
          flex: 1,
          minWidth: '140px',
          background: COLORS.surfaceAlt,
          borderRadius: '12px',
          padding: '20px',
          textAlign: 'center',
        }}>
          <div style={{ 
            fontSize: '13px', 
            color: COLORS.textSecondary,
            marginBottom: '8px',
          }}>
            Calculations
          </div>
          <div style={{ 
            fontSize: '28px', 
            fontWeight: '700',
            color: COLORS.primary,
          }}>
            {completedCalcs}/{totalCalcs}
          </div>
        </div>
        
        <div style={{
          flex: 1,
          minWidth: '140px',
          background: COLORS.rabbitHoleLight,
          borderRadius: '12px',
          padding: '20px',
          textAlign: 'center',
        }}>
          <div style={{ 
            fontSize: '13px', 
            color: COLORS.textSecondary,
            marginBottom: '8px',
          }}>
            Rabbit Holes
          </div>
          <div style={{ 
            fontSize: '28px', 
            fontWeight: '700',
            color: COLORS.rabbitHole,
          }}>
            {exploredCount}/{totalRabbitHoles}
          </div>
        </div>
      </div>
      
      {/* Rabbit Holes Section - CLICKABLE per Standards v3.2 */}
      <div style={{
        background: COLORS.surfaceAlt,
        borderRadius: '12px',
        padding: '20px',
        marginBottom: '24px',
      }}>
        <h3 style={{ 
          margin: '0 0 12px 0', 
          fontSize: '15px', 
          fontWeight: '600',
          color: COLORS.textSecondary,
          display: 'flex',
          alignItems: 'center',
          gap: '8px',
        }}>
          <LucideIcon name="Rabbit" size={18} color={COLORS.rabbitHole} />
          Explore the Rabbit Holes
        </h3>
        
        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
          {Object.values(RABBIT_HOLES).map((rh) => (
            <button
              key={rh.id}
              onClick={() => {
                if (soundEnabled) playSound('rabbitHole');
                onRabbitHole(rh.id);
              }}
              style={{
                padding: '12px 14px',
                border: `1px solid ${COLORS.rabbitHoleBorder}`,
                borderRadius: '8px',
                background: exploredRabbitHoles.includes(rh.id) ? COLORS.rabbitHoleLight : 'white',
                color: COLORS.rabbitHole,
                fontSize: '14px',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: '10px',
                textAlign: 'left',
                transition: 'all 0.2s ease',
              }}
            >
              <LucideIcon name="Rabbit" size={16} style={{ flexShrink: 0 }} />
              <span style={{ flex: 1 }}>{rh.title}</span>
              {exploredRabbitHoles.includes(rh.id) && <LucideIcon name="Check" size={16} />}
            </button>
          ))}
        </div>
      </div>
      
      {/* Return to Hub */}
      <div style={{
        background: COLORS.primaryLight,
        color: 'white',
        borderRadius: '12px',
        padding: '20px',
        textAlign: 'center',
      }}>
        <p style={{
          margin: '0 0 12px 0',
          fontSize: '15px',
          lineHeight: 1.7,
          opacity: 0.95,
        }}>
          You've now seen DCF applied to bonds, businesses, and capital projects. The framework is universal â€” wherever there are cash flows and a discount rate, you can calculate value.
        </p>
        <a href="index.html" style={{
          display: 'inline-block',
          padding: '10px 24px',
          background: 'white',
          color: COLORS.primary,
          borderRadius: '8px',
          textDecoration: 'none',
          fontWeight: '500',
          fontSize: '15px',
        }}>
          Return to Hub
        </a>
      </div>
    </div>
  );
};

// ============================================================================
// MAIN TUTORIAL COMPONENT
// ============================================================================

const Tutorial02I = () => {
  // --- Core State ---
  const [currentPartIndex, setCurrentPartIndex] = useState(0);
  const [currentStep, setCurrentStep] = useState(0);
  const [soundEnabled, setSoundEnabled] = useState(true);
  
  // --- Modal State ---
  const [showGlossary, setShowGlossary] = useState(false);
  const [showRabbitHoleList, setShowRabbitHoleList] = useState(false);
  const [showRestartConfirm, setShowRestartConfirm] = useState(false);
  const [activeRabbitHole, setActiveRabbitHole] = useState(null);
  
  // --- Exploration Tracking ---
  const [exploredRabbitHoles, setExploredRabbitHoles] = useState([]);
  
  // --- Calculation Completion Tracking ---
  const [calcCompleted, setCalcCompleted] = useState({
    inflowPV: false,
    npv: false,
  });
  
  // --- Dev Mode ---
  const [devMode, setDevMode] = useState(false);
  const [headerClickCount, setHeaderClickCount] = useState(0);
  const [lastClickTime, setLastClickTime] = useState(0);
  
  // --- Handlers ---
  const handleCalcComplete = useCallback((calcId) => {
    setCalcCompleted(prev => ({
      ...prev,
      [calcId]: true
    }));
  }, []);
  
  const handleContinue = useCallback(() => {
    const currentPart = PARTS[currentPartIndex];
    
    if (currentStep < currentPart.steps - 1) {
      setCurrentStep(prev => prev + 1);
    } else if (currentPartIndex < PARTS.length - 1) {
      setCurrentPartIndex(prev => prev + 1);
      setCurrentStep(0);
    }
  }, [currentPartIndex, currentStep]);
  
  const handleBack = useCallback(() => {
    if (currentStep > 0) {
      setCurrentStep(prev => prev - 1);
    } else if (currentPartIndex > 0) {
      const prevPartIndex = currentPartIndex - 1;
      setCurrentPartIndex(prevPartIndex);
      setCurrentStep(PARTS[prevPartIndex].steps - 1);
    }
  }, [currentPartIndex, currentStep]);
  
  const handleRestart = useCallback(() => {
    setCurrentPartIndex(0);
    setCurrentStep(0);
    setExploredRabbitHoles([]);
    setCalcCompleted({
      inflowPV: false,
      npv: false,
    });
    setShowRestartConfirm(false);
  }, []);
  
  const handleRabbitHoleClick = useCallback((rabbitHoleId) => {
    setActiveRabbitHole(RABBIT_HOLES[rabbitHoleId]);
    if (!exploredRabbitHoles.includes(rabbitHoleId)) {
      setExploredRabbitHoles(prev => [...prev, rabbitHoleId]);
    }
  }, [exploredRabbitHoles]);

  const handleRabbitHoleFromList = useCallback((rabbitHole) => {
    setShowRabbitHoleList(false);
    setActiveRabbitHole(rabbitHole);
    if (!exploredRabbitHoles.includes(rabbitHole.id)) {
      setExploredRabbitHoles(prev => [...prev, rabbitHole.id]);
    }
  }, [exploredRabbitHoles]);

  const handleHeaderClick = useCallback(() => {
    const now = Date.now();
    if (now - lastClickTime < 500) {
      const newCount = headerClickCount + 1;
      setHeaderClickCount(newCount);
      if (newCount >= 3) {
        setDevMode(prev => !prev);
        setHeaderClickCount(0);
      }
    } else {
      setHeaderClickCount(1);
    }
    setLastClickTime(now);
  }, [headerClickCount, lastClickTime]);
  
  const handleJumpToPart = useCallback((partIndex) => {
    setCurrentPartIndex(partIndex);
    setCurrentStep(0);
  }, []);
  
  // --- Computed Values ---
  const currentPart = PARTS[currentPartIndex];
  const canGoBack = currentPartIndex > 0 || currentStep > 0;
  const totalRabbitHoles = Object.keys(RABBIT_HOLES).length;
  
  // --- Common props for part components ---
  const commonProps = {
    step: currentStep,
    onContinue: handleContinue,
    onBack: handleBack,
    canGoBack,
    soundEnabled,
    calcCompleted,
    onCalcComplete: handleCalcComplete,
    onRabbitHole: handleRabbitHoleClick,
    exploredRabbitHoles,
  };
  
  // --- Render current part ---
  const renderCurrentPart = () => {
    switch (currentPart.id) {
      case 'quickRecap':
        return <QuickRecapPart {...commonProps} />;
      case 'aNewQuestion':
        return <ANewQuestionPart {...commonProps} />;
      case 'equipmentDecision':
        return <EquipmentDecisionPart {...commonProps} />;
      case 'npvRule':
        return <NPVRulePart {...commonProps} />;
      case 'threeAssetsCompared':
        return <ThreeAssetsComparedPart {...commonProps} />;
      case 'complete':
        return <CompletePart {...commonProps} />;
      default:
        return null;
    }
  };
  
  // --- Render ---
  return (
    <div style={{
      minHeight: '100vh',
      background: COLORS.background,
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
    }}>
      <Header
        currentPartIndex={currentPartIndex}
        currentStep={currentStep}
        exploredRabbitHoles={exploredRabbitHoles}
        totalRabbitHoles={totalRabbitHoles}
        onGlossaryClick={() => setShowGlossary(true)}
        onRabbitHoleListClick={() => setShowRabbitHoleList(true)}
        onRestartClick={() => setShowRestartConfirm(true)}
        onHeaderClick={handleHeaderClick}
        soundEnabled={soundEnabled}
        onSoundToggle={() => setSoundEnabled(prev => !prev)}
      />
      
      <main style={{
        maxWidth: '800px',
        margin: '0 auto',
        padding: '32px 24px',
      }}>
        {renderCurrentPart()}
      </main>

      {/* Tutorial Navigation Footer */}
      <div style={{
        background: '#00356b',
        padding: '24px',
        display: 'flex',
        justifyContent: 'center',
        alignItems: 'center',
        gap: '16px',
        marginTop: '40px',
      }}>
        <a href="index.html" style={{
          padding: '12px 24px',
          background: '#b8860b',
          borderRadius: '8px',
          color: 'white',
          textDecoration: 'none',
          textAlign: 'center',
          minWidth: '140px',
          fontWeight: '500',
        }}>
          Hub
        </a>
      </div>

      {/* Modals */}
      {showGlossary && <GlossaryModal onClose={() => setShowGlossary(false)} />}

      {showRabbitHoleList && (
        <RabbitHoleListModal
          exploredRabbitHoles={exploredRabbitHoles}
          onSelectRabbitHole={handleRabbitHoleFromList}
          onClose={() => setShowRabbitHoleList(false)}
        />
      )}

      {showRestartConfirm && (
        <RestartConfirmModal 
          onConfirm={handleRestart}
          onCancel={() => setShowRestartConfirm(false)}
        />
      )}
      
      {activeRabbitHole && (
        <RabbitHoleModal
          rabbitHole={activeRabbitHole}
          onClose={() => setActiveRabbitHole(null)}
        />
      )}
      
      {/* Dev Mode Panel */}
      {devMode && (
        <DevModePanel
          onJumpToPart={handleJumpToPart}
          currentPartIndex={currentPartIndex}
          onClose={() => setDevMode(false)}
        />
      )}
    </div>
  );
};



// Render
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<Tutorial02I />);
    </script>
</body>
</html>
