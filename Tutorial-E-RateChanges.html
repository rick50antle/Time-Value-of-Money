<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>When Rates Change - Tutorial E</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; }
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      background: #e2e8f0;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: #00356b;
      border-radius: 50%;
      cursor: pointer;
    }
    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: #00356b;
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useCallback, useEffect, useRef } = React;

    // LucideIcon helper component
    const LucideIcon = ({ name, size = 24, color = 'currentColor', style = {} }) => {
      const iconRef = useRef(null);

      useEffect(() => {
        if (iconRef.current && lucide && lucide[name]) {
          iconRef.current.innerHTML = '';
          const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          svg.setAttribute('width', size);
          svg.setAttribute('height', size);
          svg.setAttribute('viewBox', '0 0 24 24');
          svg.setAttribute('fill', 'none');
          svg.setAttribute('stroke', color);
          svg.setAttribute('stroke-width', '2');
          svg.setAttribute('stroke-linecap', 'round');
          svg.setAttribute('stroke-linejoin', 'round');

          const iconData = lucide[name];
          if (iconData && iconData[2]) {
            iconData[2].forEach(pathData => {
              const element = document.createElementNS('http://www.w3.org/2000/svg', pathData[0]);
              const attrs = pathData[1];
              Object.keys(attrs).forEach(attr => {
                element.setAttribute(attr, attrs[attr]);
              });
              svg.appendChild(element);
            });
          }
          iconRef.current.appendChild(svg);
        }
      }, [name, size, color]);

      return <span ref={iconRef} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center', ...style }} />;
    };

    // Constants
    const CONSTANTS = {
      FACE_VALUE: 100, COUPON_RATE: 0.06, PERIODS: 3, COUPON_PAYMENT: 6.00, FINAL_PAYMENT: 106.00,
      MIN_RATE: 0.02, MAX_RATE: 0.12, TOLERANCE: 0.10,
      PV_AT_8PCT: 96.44,
      PV_AT_4PCT: 103.85,
    };

    const calculateBondPrice = (rate) => {
      const cf1 = CONSTANTS.COUPON_PAYMENT / Math.pow(1 + rate, 1);
      const cf2 = CONSTANTS.COUPON_PAYMENT / Math.pow(1 + rate, 2);
      const cf3 = CONSTANTS.FINAL_PAYMENT / Math.pow(1 + rate, 3);
      return cf1 + cf2 + cf3;
    };

    // Colors
    const COLORS = {
      primary: '#00356b', primaryLight: '#1a4a7a', background: '#f8fafc', surface: '#ffffff', surfaceAlt: '#f1f5f9',
      border: '#e2e8f0', borderDark: '#cbd5e1', textPrimary: '#1e293b', textSecondary: '#64748b', textMuted: '#94a3b8',
      accent: '#0369a1', accentLight: '#e0f2fe', gold: '#ca8a04', goldLight: '#fef9c3', goldBorder: '#eab308',
      success: '#16a34a', successBg: '#f0fdf4', successBorder: '#86efac', warning: '#d97706', warningBg: '#fffbeb',
      warningBorder: '#fcd34d', error: '#dc2626', errorBg: '#fef2f2', rabbitHole: '#7c3aed', rabbitHoleLight: '#ede9fe', rabbitHoleBorder: '#a78bfa',
    };

    const PARTS = [
      { id: 'setup', title: 'Your Bond, Changing Rates', steps: 2 },
      { id: 'interactive', title: 'Watching Prices Move', steps: 2 },
      { id: 'inverse', title: 'The Inverse Relationship', steps: 2 },
      { id: 'rateChange', title: 'When Rates Change', steps: 4 },
      { id: 'realWorld', title: 'Why This Matters', steps: 2 },
      { id: 'lookingAhead', title: 'Looking Ahead', steps: 2 },
      { id: 'complete', title: 'Complete', steps: 1 },
    ];

    const RABBIT_HOLES = {
      negativeRates: {
        id: 'negativeRates', title: 'Negative Interest Rates: Paying to Lend?',
        content: `In the 2010s, something strange happened in Europe and Japan: interest rates went negative. Investors were literally paying governments to hold their money.\n\nHow is that possible? Why would anyone accept a guaranteed loss?\n\nThe answer comes down to storage costs. If you're a pension fund with $3 billion, you can't stuff it under a mattress. Physical cash at that scale requires vaults, security, insurance — and it can be stolen or destroyed.\n\nA government bond, even at -0.5%, gives you safety and convenience. You're essentially paying a small fee for secure storage of your wealth. The "interest rate" becomes a storage cost.\n\nAt the extreme, negative rates reveal that "risk-free" really means "least risky option available" — and sometimes the least risky option still costs you money.`
      },
      perpetuities: {
        id: 'perpetuities', title: 'Perpetuities: The Simplest Way to See It',
        content: `A perpetuity is a bond that pays a fixed amount forever — no maturity date, no principal repayment. Just $C every period, forever.\n\nHow do you price something that never ends? Think about what you're buying: the right to receive $C per period indefinitely.\n\nFor this to be a fair deal, that payment must exactly cover what you'd earn by lending your money at the market rate. If you invest $Value at rate r, you earn r × Value per period.\n\nSo for a fairly-priced perpetuity:\n\nr × Value = C\n\nRearrange:\n\nValue = C / r\n\nThat's it. The interest rate is in the denominator.\n\nNow the inverse relationship is just algebra:\n• If C = $6 and r = 6%: Value = $6 / 0.06 = $100\n• If r rises to 8%: Value = $6 / 0.08 = $75\n• If r falls to 4%: Value = $6 / 0.04 = $150\n\nHigher rate → lower value. No complicated discounting required.\n\nReal perpetuities are rare (though the British government once issued "consols" that worked this way). But this intuition carries over to all bonds — the rate is always working against the price.`
      },
      rateShock2022: {
        id: 'rateShock2022', title: 'The 2022 Rate Shock and Bank Failures',
        content: `For nearly 40 years, interest rates trended downward. In 1981, the Federal Reserve's benchmark rate peaked above 19%. By 2020, it was near zero.\n\nThen came 2022. To fight inflation, the Federal Reserve raised rates at the fastest pace in decades — from near zero to over 5% in about 18 months.\n\nThe 2022 Bond Crash: The Bloomberg U.S. Aggregate Bond Index fell over 13% — its worst year in decades.\n\nSilicon Valley Bank (March 2023): SVB had invested heavily in long-term bonds when rates were low. When rates rose sharply, those bonds lost billions in value. But then depositors wanted their money. SVB had to sell bonds at a loss. Once word spread, more depositors fled. The bank failed within 48 hours.\n\nThe lesson: The inverse relationship between rates and bond prices isn't abstract theory. It bankrupted a $200 billion bank.`
      },
    };

    const GLOSSARY = {
      bond: { term: 'Bond', definition: 'A promise to pay periodic coupon payments plus the face value at maturity.' },
      couponRate: { term: 'Coupon Rate', definition: 'The percentage stated on a bond that determines coupon payments. This is contractual — NOT an interest rate.' },
      interestRate: { term: 'Interest Rate', definition: 'The market price of borrowing money through time. This determines what cash flows are WORTH today.' },
      inverseRelationship: { term: 'Inverse Relationship', definition: 'Bond prices move opposite to interest rates. Rates up → prices down. Rates down → prices up.' },
      interestRateRisk: { term: 'Interest Rate Risk', definition: 'The risk that rate changes will affect your bond\'s value, even if the issuer never misses a payment.' },
      remainingCashFlows: { term: 'Remaining Cash Flows', definition: 'The cash flows a bond will pay from the current time until maturity. Mid-life bond value = PV of remaining cash flows.' },
      perpetuity: { term: 'Perpetuity', definition: 'A bond that pays a fixed amount forever with no maturity date. Value = C / r, where C is the payment and r is the interest rate.' },
    };

    // Utilities
    const formatCurrency = (v) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(v);
    const formatPercent = (v) => `${(v * 100).toFixed(0)}%`;
    const parseUserInput = (input) => parseFloat(String(input).replace(/[$,\s]/g, ''));
    const checkAnswer = (user, correct, tol = CONSTANTS.TOLERANCE) => Math.abs(user - correct) <= tol;
    const calculateProgress = (partIdx, step) => {
      const total = PARTS.reduce((s, p) => s + p.steps, 0);
      if (partIdx === PARTS.length - 1) return 100;
      const done = PARTS.slice(0, partIdx).reduce((s, p) => s + p.steps, 0) + step;
      return Math.round((done / total) * 100);
    };

    // Components
    const Header = ({ currentPartIndex, currentStep, exploredRabbitHoles, onGlossaryClick, onRabbitHoleListClick, onRestartClick, onHeaderClick, soundEnabled, onSoundToggle }) => {
      const progress = calculateProgress(currentPartIndex, currentStep);
      const currentPart = PARTS[currentPartIndex];
      return (
        <header style={{ background: COLORS.primary, color: 'white', padding: '12px 16px', position: 'sticky', top: 0, zIndex: 100 }}>
          <div style={{ maxWidth: '800px', margin: '0 auto' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px', flexWrap: 'wrap', gap: '8px' }}>
              <h1 onClick={onHeaderClick} style={{ fontSize: '16px', fontWeight: '600', margin: 0, cursor: 'default' }}>When Rates Change</h1>
              <div style={{ display: 'flex', gap: '6px', alignItems: 'center' }}>
                <button onClick={onSoundToggle} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '6px', padding: '4px', cursor: 'pointer', color: 'white', display: 'flex' }}>
                  {soundEnabled ? <LucideIcon name="Volume2" size={16} /> : <LucideIcon name="VolumeX" size={16} />}
                </button>
                <button onClick={onRabbitHoleListClick} style={{ display: 'flex', alignItems: 'center', gap: '4px', background: COLORS.rabbitHoleLight, color: COLORS.rabbitHole, padding: '3px 8px', borderRadius: '10px', fontSize: '12px', fontWeight: '500', border: 'none', cursor: 'pointer', transition: 'all 0.2s ease' }} title="View all rabbit holes">
                  <LucideIcon name="Rabbit" size={12} /><span>{exploredRabbitHoles.length}/3</span>
                </button>
                <button onClick={onGlossaryClick} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '6px', padding: '4px 8px', cursor: 'pointer', color: 'white', display: 'flex', alignItems: 'center', gap: '4px', fontSize: '12px' }}>
                  <LucideIcon name="BookOpen" size={14} />
                  Glossary
                </button>
                <button onClick={onRestartClick} style={{ background: 'rgba(255,255,255,0.1)', border: 'none', borderRadius: '6px', padding: '4px', cursor: 'pointer', color: 'white', display: 'flex' }}>
                  <LucideIcon name="RotateCcw" size={16} />
                </button>
              </div>
            </div>
            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '11px', marginBottom: '4px', opacity: 0.9 }}>
              <span>Part {currentPartIndex + 1}: {currentPart.title}</span>
              <span>{progress}%</span>
            </div>
            <div style={{ background: 'rgba(255,255,255,0.2)', borderRadius: '3px', height: '4px', overflow: 'hidden' }}>
              <div style={{ background: COLORS.goldBorder, height: '100%', width: `${progress}%`, transition: 'width 0.3s ease' }} />
            </div>
          </div>
        </header>
      );
    };

    const NavButtons = ({ onBack, onContinue, canGoBack, canContinue }) => (
      <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '24px', paddingTop: '16px', borderTop: `1px solid ${COLORS.border}` }}>
        <button onClick={onBack} disabled={!canGoBack} style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '8px 16px', border: `1px solid ${COLORS.border}`, borderRadius: '6px', background: 'white', color: canGoBack ? COLORS.textPrimary : COLORS.textMuted, cursor: canGoBack ? 'pointer' : 'not-allowed', fontSize: '14px', opacity: canGoBack ? 1 : 0.5 }}>
          <LucideIcon name="ChevronLeft" size={16} />Back
        </button>
        <button onClick={onContinue} disabled={!canContinue} style={{ display: 'flex', alignItems: 'center', gap: '4px', padding: '8px 20px', border: 'none', borderRadius: '6px', background: canContinue ? COLORS.primary : COLORS.textMuted, color: 'white', cursor: canContinue ? 'pointer' : 'not-allowed', fontSize: '14px', fontWeight: '500' }}>
          Continue<LucideIcon name="ChevronRight" size={16} />
        </button>
      </div>
    );

    const ChoiceButton = ({ label, selected, correct, submitted, onClick }) => {
      let bg = 'white', border = COLORS.border, text = COLORS.textPrimary;
      if (selected && !submitted) { bg = COLORS.accentLight; border = COLORS.accent; }
      else if (submitted) {
        if (correct) { bg = COLORS.successBg; border = COLORS.successBorder; }
        else if (selected) { bg = COLORS.warningBg; border = COLORS.warningBorder; }
        else { text = COLORS.textMuted; }
      }
      return (
        <button onClick={onClick} disabled={submitted} style={{ display: 'flex', alignItems: 'center', gap: '10px', width: '100%', padding: '12px 14px', border: `2px solid ${border}`, borderRadius: '8px', background: bg, color: text, cursor: submitted ? 'default' : 'pointer', fontSize: '14px', textAlign: 'left', marginBottom: '6px' }}>
          {submitted && correct && <LucideIcon name="Check" size={18} color={COLORS.success} />}
          {submitted && selected && !correct && <LucideIcon name="X" size={18} color={COLORS.warning} />}
          {!submitted && <div style={{ width: '18px', height: '18px', borderRadius: '50%', border: `2px solid ${selected ? COLORS.accent : COLORS.border}`, background: selected ? COLORS.accent : 'white', flexShrink: 0 }} />}
          <span>{label}</span>
        </button>
      );
    };

    const CalculationBox = ({ prompt, correctAnswer, hint1, hint2, onCorrect, tolerance = CONSTANTS.TOLERANCE, disabled = false }) => {
      const [input, setInput] = useState('');
      const [attempts, setAttempts] = useState(0);
      const [isCorrect, setIsCorrect] = useState(false);
      const [showHint, setShowHint] = useState(null);

      const handleCheck = () => {
        if (isCorrect || disabled) return;
        const userValue = parseUserInput(input);
        if (isNaN(userValue)) { setShowHint('Please enter a valid number'); return; }
        if (checkAnswer(userValue, correctAnswer, tolerance)) {
          setIsCorrect(true); onCorrect?.();
        } else {
          const newAttempts = attempts + 1;
          setAttempts(newAttempts);
          if (newAttempts >= 3) { setShowHint(`The answer is ${formatCurrency(correctAnswer)}`); setIsCorrect(true); onCorrect?.(); }
          else if (newAttempts === 2 && hint2) { setShowHint(hint2); }
          else if (hint1) { setShowHint(hint1); }
        }
      };

      return (
        <div style={{ background: COLORS.surfaceAlt, border: `1px solid ${COLORS.border}`, borderRadius: '10px', padding: '16px', marginTop: '12px', opacity: disabled ? 0.5 : 1 }}>
          <p style={{ margin: '0 0 12px 0', fontSize: '14px', color: COLORS.textPrimary, fontFamily: 'monospace' }}>{prompt}</p>
          <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
            <div style={{ position: 'relative', flex: 1 }}>
              <span style={{ position: 'absolute', left: '10px', top: '50%', transform: 'translateY(-50%)', color: COLORS.textMuted }}>$</span>
              <input type="text" inputMode="decimal" value={input} onChange={(e) => setInput(e.target.value)} disabled={isCorrect || disabled} placeholder="0.00" style={{ width: '100%', padding: '10px 10px 10px 24px', border: `2px solid ${isCorrect ? COLORS.successBorder : COLORS.border}`, borderRadius: '6px', fontSize: '15px', fontFamily: 'monospace', background: isCorrect ? COLORS.successBg : 'white', boxSizing: 'border-box' }} onKeyDown={(e) => e.key === 'Enter' && handleCheck()} />
            </div>
            <button onClick={handleCheck} disabled={isCorrect || !input || disabled} style={{ padding: '10px 16px', border: 'none', borderRadius: '6px', background: isCorrect ? COLORS.success : COLORS.primary, color: 'white', fontSize: '14px', fontWeight: '500', cursor: isCorrect || !input || disabled ? 'default' : 'pointer', display: 'flex', alignItems: 'center', gap: '4px' }}>
              {isCorrect ? <LucideIcon name="Check" size={16} /> : 'Check'}
            </button>
          </div>
          {showHint && <p style={{ marginTop: '10px', padding: '8px 10px', background: isCorrect && attempts >= 3 ? COLORS.warningBg : COLORS.accentLight, borderRadius: '6px', fontSize: '13px', color: isCorrect && attempts >= 3 ? COLORS.warning : COLORS.accent }}>{showHint}</p>}
        </div>
      );
    };

    const InsightBox = ({ children, warning = false }) => (
      <div style={{ background: warning ? COLORS.warningBg : COLORS.goldLight, border: `2px solid ${warning ? COLORS.warningBorder : COLORS.goldBorder}`, borderRadius: '10px', padding: '16px', marginTop: '16px', marginBottom: '16px' }}>
        <div style={{ display: 'flex', gap: '10px', alignItems: 'flex-start' }}>
          {warning ? <LucideIcon name="AlertTriangle" size={20} color={COLORS.warning} style={{ flexShrink: 0, marginTop: '2px' }} /> : <LucideIcon name="TrendingUp" size={20} color={COLORS.gold} style={{ flexShrink: 0, marginTop: '2px' }} />}
          <div style={{ fontSize: '14px', lineHeight: '1.5', color: COLORS.textPrimary }}>{children}</div>
        </div>
      </div>
    );

    const RateSlider = ({ rate, onChange }) => {
      const getMarkerPosition = (r) => ((r - CONSTANTS.MIN_RATE) / (CONSTANTS.MAX_RATE - CONSTANTS.MIN_RATE)) * 100;
      const markers = [{ rate: 0.02, label: '2%' }, { rate: 0.06, label: '6%', highlight: true }, { rate: 0.12, label: '12%' }];
      const price = calculateBondPrice(rate);

      return (
        <div style={{ background: COLORS.surfaceAlt, borderRadius: '10px', padding: '20px', marginTop: '12px' }}>
          <div style={{ textAlign: 'center', marginBottom: '20px' }}>
            <div style={{ fontSize: '12px', color: COLORS.textSecondary, marginBottom: '4px' }}>Bond Price</div>
            <div style={{ fontSize: '32px', fontWeight: '700', fontFamily: 'monospace', color: COLORS.primary }}>{formatCurrency(price)}</div>
          </div>
          <div style={{ textAlign: 'center', marginBottom: '12px' }}>
            <div style={{ fontSize: '13px', color: COLORS.textSecondary }}>Interest Rate: <strong style={{ color: COLORS.primary }}>{formatPercent(rate)}</strong></div>
          </div>
          <div style={{ padding: '0 4px' }}>
            <input type="range" min={CONSTANTS.MIN_RATE} max={CONSTANTS.MAX_RATE} step={0.01} value={rate} onChange={(e) => onChange(parseFloat(e.target.value))} style={{ width: '100%', height: '6px', borderRadius: '3px', cursor: 'pointer', accentColor: COLORS.primary }} />
            <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '8px', padding: '0 2px' }}>
              {markers.map((m) => (
                <span key={m.rate} style={{ fontSize: '11px', color: m.highlight ? COLORS.primary : COLORS.textMuted, fontWeight: m.highlight ? '600' : '400' }}>
                  {m.label}{m.highlight && ' (coupon)'}
                </span>
              ))}
            </div>
          </div>
        </div>
      );
    };

    const RateChangeTimeline = ({ scenario, showValue = false }) => {
      const isRising = scenario === 'rising';
      const newRate = isRising ? '8%' : '4%';
      const bondValue = isRising ? '$96.44' : '$103.85';
      const valueColor = isRising ? COLORS.error : COLORS.success;

      return (
        <div style={{ background: COLORS.surfaceAlt, borderRadius: '10px', padding: '20px', marginTop: '12px' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '16px' }}>
            {[
              { time: 'Time 0', event: 'Buy at $100', sub: 'Rate: 6%' },
              { time: 'Time 1', event: showValue ? bondValue : 'NOW', sub: `Rate: ${newRate}`, highlight: true, valueColor: showValue ? valueColor : null },
              { time: 'Time 2', event: '$6', sub: null },
              { time: 'Time 3', event: '$106', sub: null },
            ].map((t, i) => (
              <div key={i} style={{ textAlign: 'center', flex: 1 }}>
                <div style={{
                  background: t.highlight ? COLORS.primary : 'white',
                  color: t.highlight ? 'white' : (t.valueColor || COLORS.textPrimary),
                  padding: '8px 4px',
                  borderRadius: '6px',
                  fontSize: '13px',
                  fontWeight: t.highlight || t.valueColor ? '600' : '400',
                  border: t.highlight ? 'none' : `1px solid ${COLORS.border}`,
                  marginBottom: '4px'
                }}>
                  {t.event}
                </div>
                {t.sub && <div style={{ fontSize: '10px', color: COLORS.textSecondary }}>{t.sub}</div>}
                <div style={{ fontSize: '11px', color: t.highlight ? COLORS.primary : COLORS.textMuted, marginTop: '4px', fontWeight: t.highlight ? '600' : '400' }}>{t.time}</div>
              </div>
            ))}
          </div>
          <div style={{ borderTop: `1px solid ${COLORS.border}`, paddingTop: '12px', display: 'flex', justifyContent: 'center', gap: '24px', fontSize: '12px', color: COLORS.textSecondary }}>
            <span>Already received: <strong style={{ color: COLORS.success }}>$6</strong></span>
            <span>Remaining: <strong style={{ color: COLORS.textPrimary }}>$6 + $106</strong></span>
          </div>
        </div>
      );
    };

    const BondSummaryCard = () => (
      <div style={{ background: COLORS.surfaceAlt, borderRadius: '10px', padding: '16px', marginTop: '12px' }}>
        <h3 style={{ margin: '0 0 12px 0', fontSize: '14px', color: COLORS.primary }}>Your Bond</h3>
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '8px' }}>
          {[{ label: 'Face Value', value: '$100' }, { label: 'Coupon Rate', value: '6%' }, { label: 'Maturity', value: '3 periods' }, { label: 'You Paid', value: '$100' }].map((item) => (
            <div key={item.label} style={{ background: 'white', padding: '10px', borderRadius: '6px', border: `1px solid ${COLORS.border}` }}>
              <div style={{ fontSize: '10px', color: COLORS.textSecondary }}>{item.label}</div>
              <div style={{ fontSize: '14px', fontWeight: '600', color: COLORS.textPrimary, marginTop: '2px' }}>{item.value}</div>
            </div>
          ))}
        </div>
      </div>
    );

    const RabbitHoleButton = ({ rabbitHole, explored, onClick }) => (
      <button onClick={onClick} style={{ display: 'flex', alignItems: 'center', gap: '8px', width: '100%', padding: '12px 14px', border: `2px dashed ${COLORS.rabbitHoleBorder}`, borderRadius: '8px', background: explored ? COLORS.rabbitHoleLight : 'white', color: COLORS.rabbitHole, cursor: 'pointer', fontSize: '13px', textAlign: 'left', marginTop: '12px' }}>
        <LucideIcon name="Rabbit" size={18} style={{ flexShrink: 0 }} />
        <span style={{ flex: 1 }}>{rabbitHole.title}</span>
        {explored && <LucideIcon name="Check" size={16} />}
      </button>
    );

    const Modal = ({ title, color, icon, children, onClose, buttonText = 'Close' }) => (
      <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '16px', zIndex: 1000 }}>
        <div style={{ background: 'white', borderRadius: '12px', maxWidth: '500px', maxHeight: '80vh', overflow: 'auto', boxShadow: '0 20px 60px rgba(0,0,0,0.3)', width: '100%' }}>
          <div style={{ background: color, color: 'white', padding: '16px 20px', display: 'flex', alignItems: 'center', gap: '10px' }}>
            {icon}<h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600' }}>{title}</h2>
          </div>
          <div style={{ padding: '20px', fontSize: '14px', lineHeight: '1.6', color: COLORS.textPrimary }}>{children}</div>
          <div style={{ padding: '12px 20px', borderTop: `1px solid ${COLORS.border}`, display: 'flex', justifyContent: 'flex-end' }}>
            <button onClick={onClose} style={{ padding: '8px 20px', border: 'none', borderRadius: '6px', background: color, color: 'white', fontSize: '14px', fontWeight: '500', cursor: 'pointer' }}>{buttonText}</button>
          </div>
        </div>
      </div>
    );

    // --- Rabbit Hole List Modal ---
    const RabbitHoleListModal = ({ exploredRabbitHoles, onSelectRabbitHole, onClose }) => (
      <div style={{
        position: 'fixed',
        inset: 0,
        background: 'rgba(0,0,0,0.5)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '20px',
        zIndex: 1000,
      }}>
        <div style={{
          background: 'white',
          borderRadius: '16px',
          maxWidth: '500px',
          width: '100%',
          maxHeight: '80vh',
          overflow: 'auto',
          boxShadow: '0 20px 60px rgba(0,0,0,0.3)',
        }}>
          {/* Header */}
          <div style={{
            background: COLORS.rabbitHole,
            color: 'white',
            padding: '20px 24px',
            display: 'flex',
            alignItems: 'center',
            gap: '12px',
          }}>
            <LucideIcon name="Rabbit" size={24} />
            <h2 style={{ margin: 0, fontSize: '18px', fontWeight: '600' }}>
              Rabbit Holes
            </h2>
            <span style={{
              marginLeft: 'auto',
              background: 'rgba(255,255,255,0.2)',
              padding: '4px 10px',
              borderRadius: '12px',
              fontSize: '13px',
            }}>
              {exploredRabbitHoles.length}/{Object.keys(RABBIT_HOLES).length} explored
            </span>
          </div>

          {/* Content */}
          <div style={{ padding: '16px' }}>
            {Object.values(RABBIT_HOLES).map((rabbitHole) => {
              const isExplored = exploredRabbitHoles.includes(rabbitHole.id);
              return (
                <button
                  key={rabbitHole.id}
                  onClick={() => onSelectRabbitHole(rabbitHole)}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    width: '100%',
                    padding: '14px 16px',
                    marginBottom: '8px',
                    border: `2px solid ${isExplored ? COLORS.rabbitHoleBorder : COLORS.border}`,
                    borderRadius: '10px',
                    background: isExplored ? COLORS.rabbitHoleLight : 'white',
                    color: COLORS.textPrimary,
                    cursor: 'pointer',
                    textAlign: 'left',
                    transition: 'all 0.2s ease',
                  }}
                >
                  <LucideIcon name="Rabbit" size={20} color={isExplored ? COLORS.rabbitHole : COLORS.textMuted} />
                  <span style={{ flex: 1, fontWeight: '500' }}>{rabbitHole.title}</span>
                  {isExplored && <LucideIcon name="Check" size={18} color={COLORS.rabbitHole} />}
                </button>
              );
            })}
          </div>

          {/* Footer */}
          <div style={{
            padding: '16px 24px',
            borderTop: `1px solid ${COLORS.border}`,
            display: 'flex',
            justifyContent: 'flex-end',
          }}>
            <button
              onClick={onClose}
              style={{
                padding: '10px 24px',
                border: 'none',
                borderRadius: '8px',
                background: COLORS.rabbitHole,
                color: 'white',
                fontSize: '15px',
                fontWeight: '500',
                cursor: 'pointer',
              }}
            >
              Close
            </button>
          </div>
        </div>
      </div>
    );

    // Main Component
    function Tutorial02ERateChanges() {
      const [currentPartIndex, setCurrentPartIndex] = useState(0);
      const [currentStep, setCurrentStep] = useState(0);
      const [soundEnabled, setSoundEnabled] = useState(true);
      const [currentRate, setCurrentRate] = useState(0.06);
      const [showGlossary, setShowGlossary] = useState(false);
      const [showRabbitHoleList, setShowRabbitHoleList] = useState(false);
      const [showRestartConfirm, setShowRestartConfirm] = useState(false);
      const [activeRabbitHole, setActiveRabbitHole] = useState(null);
      const [exploredRabbitHoles, setExploredRabbitHoles] = useState([]);
      const [completedSteps, setCompletedSteps] = useState({});
      const [inverseQuestion, setInverseQuestion] = useState({ choice: null, submitted: false, attempts: 0 });
      const [rateRiseCalcComplete, setRateRiseCalcComplete] = useState(false);
      const [rateFallCalcComplete, setRateFallCalcComplete] = useState(false);
      const [devMode, setDevMode] = useState(false);
      const [clickCount, setClickCount] = useState(0);
      const [lastClick, setLastClick] = useState(0);

      const handleContinue = () => {
        const part = PARTS[currentPartIndex];
        if (currentStep < part.steps - 1) setCurrentStep(s => s + 1);
        else if (currentPartIndex < PARTS.length - 1) { setCurrentPartIndex(p => p + 1); setCurrentStep(0); }
      };

      const handleBack = () => {
        if (currentStep > 0) setCurrentStep(s => s - 1);
        else if (currentPartIndex > 0) { const prev = currentPartIndex - 1; setCurrentPartIndex(prev); setCurrentStep(PARTS[prev].steps - 1); }
      };

      const handleRestart = () => {
        setCurrentPartIndex(0); setCurrentStep(0); setExploredRabbitHoles([]); setCompletedSteps({});
        setCurrentRate(0.06); setInverseQuestion({ choice: null, submitted: false, attempts: 0 });
        setRateRiseCalcComplete(false); setRateFallCalcComplete(false); setShowRestartConfirm(false);
      };

      const handleRabbitHoleClick = (id) => {
        setActiveRabbitHole(RABBIT_HOLES[id]);
        if (!exploredRabbitHoles.includes(id)) setExploredRabbitHoles(e => [...e, id]);
      };

      const handleRabbitHoleFromList = (rabbitHole) => {
        setShowRabbitHoleList(false);
        setActiveRabbitHole(rabbitHole);
        if (!exploredRabbitHoles.includes(rabbitHole.id)) setExploredRabbitHoles(e => [...e, rabbitHole.id]);
      };

      const handleHeaderClick = () => {
        const now = Date.now();
        if (now - lastClick < 500) { const n = clickCount + 1; setClickCount(n); if (n >= 3) { setDevMode(d => !d); setClickCount(0); } }
        else setClickCount(1);
        setLastClick(now);
      };

      const handleInverseSubmit = () => {
        if (inverseQuestion.choice === 'B') {
          setInverseQuestion(q => ({ ...q, submitted: true }));
          setCompletedSteps(s => ({ ...s, inverseQuestion: true }));
        } else {
          const newAttempts = inverseQuestion.attempts + 1;
          if (newAttempts >= 3) { setInverseQuestion(q => ({ ...q, submitted: true, attempts: newAttempts })); setCompletedSteps(s => ({ ...s, inverseQuestion: true })); }
          else setInverseQuestion(q => ({ ...q, attempts: newAttempts }));
        }
      };

      const currentPart = PARTS[currentPartIndex];
      const canGoBack = currentPartIndex > 0 || currentStep > 0;
      const canContinue = (() => {
        if (currentPartIndex === 2 && currentStep === 0) return completedSteps.inverseQuestion === true;
        if (currentPartIndex === 3 && currentStep === 1) return rateRiseCalcComplete;
        if (currentPartIndex === 3 && currentStep === 2) return rateFallCalcComplete;
        return true;
      })();

      // Render parts
      const renderPart = () => {
        const { id } = currentPart;

        if (id === 'setup') {
          if (currentStep === 0) return (<div>
            <h2 style={{ color: COLORS.primary, marginBottom: '12px', fontSize: '20px' }}>Your Bond, Changing Rates</h2>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary }}>Imagine you bought a bond yesterday.</p>
            <BondSummaryCard />
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary, marginTop: '16px' }}>You wake up this morning and check the news: <strong>interest rates have changed</strong>.</p>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary, marginTop: '12px' }}>What happened to your bond's value?</p>
          </div>);
          return (<div>
            <h2 style={{ color: COLORS.primary, marginBottom: '12px', fontSize: '20px' }}>Let's Find Out</h2>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary }}>We'll give you a tool to change the interest rate and watch the price respond in real time.</p>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary, marginTop: '12px' }}>Pay attention to the pattern. There's something important hiding in the numbers.</p>
          </div>);
        }

        if (id === 'interactive') {
          if (currentStep === 0) return (<div>
            <h2 style={{ color: COLORS.primary, marginBottom: '12px', fontSize: '20px' }}>Try It Yourself</h2>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary }}>Use the slider to change the market interest rate. Watch what happens to your bond's price.</p>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary, marginTop: '8px' }}>Start at 6%, then try moving it up and down.</p>
            <RateSlider rate={currentRate} onChange={setCurrentRate} />
            <RabbitHoleButton rabbitHole={RABBIT_HOLES.negativeRates} explored={exploredRabbitHoles.includes('negativeRates')} onClick={() => handleRabbitHoleClick('negativeRates')} />
          </div>);
          return (<div>
            <h2 style={{ color: COLORS.primary, marginBottom: '12px', fontSize: '20px' }}>What Did You Notice?</h2>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary }}>As you moved the slider:</p>
            <div style={{ background: COLORS.surfaceAlt, borderRadius: '10px', padding: '16px', marginTop: '12px' }}>
              <p style={{ margin: 0, fontSize: '15px', lineHeight: '1.7', color: COLORS.textPrimary }}>When you <strong>raised</strong> the rate, the price <strong style={{ color: COLORS.error }}>fell</strong>.</p>
              <p style={{ margin: '8px 0 0 0', fontSize: '15px', lineHeight: '1.7', color: COLORS.textPrimary }}>When you <strong>lowered</strong> the rate, the price <strong style={{ color: COLORS.success }}>rose</strong>.</p>
            </div>
            <InsightBox><p style={{ margin: 0 }}>Rates and prices moved in <strong>opposite directions</strong>. Every time.</p></InsightBox>
          </div>);
        }

        if (id === 'inverse') {
          if (currentStep === 0) return (<div>
            <h2 style={{ color: COLORS.primary, marginBottom: '12px', fontSize: '20px' }}>The Pattern</h2>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary }}>Based on what you observed, what's the relationship between interest rates and bond prices?</p>
            <div style={{ marginTop: '16px' }}>
              <ChoiceButton label="Same direction — rates up, prices up" selected={inverseQuestion.choice === 'A'} correct={false} submitted={inverseQuestion.submitted} onClick={() => setInverseQuestion(q => ({ ...q, choice: 'A' }))} />
              <ChoiceButton label="Opposite directions — rates up, prices down" selected={inverseQuestion.choice === 'B'} correct={true} submitted={inverseQuestion.submitted} onClick={() => setInverseQuestion(q => ({ ...q, choice: 'B' }))} />
              <ChoiceButton label="No consistent pattern" selected={inverseQuestion.choice === 'C'} correct={false} submitted={inverseQuestion.submitted} onClick={() => setInverseQuestion(q => ({ ...q, choice: 'C' }))} />
            </div>
            {inverseQuestion.choice && !inverseQuestion.submitted && <button onClick={handleInverseSubmit} style={{ marginTop: '12px', padding: '10px 20px', border: 'none', borderRadius: '6px', background: COLORS.primary, color: 'white', fontSize: '14px', fontWeight: '500', cursor: 'pointer' }}>Submit</button>}
            {inverseQuestion.submitted && <InsightBox><p style={{ margin: 0 }}><strong>Exactly!</strong> This is called the <strong>"inverse relationship"</strong> — one of the most important principles in bond investing.</p></InsightBox>}
            {inverseQuestion.attempts > 0 && !inverseQuestion.submitted && <p style={{ marginTop: '10px', padding: '8px 10px', background: COLORS.warningBg, borderRadius: '6px', fontSize: '13px', color: COLORS.warning }}>Think about what you saw. When the rate went up, did the price go up or down?</p>}
          </div>);
          return (<div>
            <h2 style={{ color: COLORS.primary, marginBottom: '12px', fontSize: '20px' }}>The Inverse Relationship</h2>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary }}>Bond prices move <strong>opposite</strong> to interest rates. Always.</p>
            <div style={{ background: COLORS.surfaceAlt, borderRadius: '10px', padding: '16px', marginTop: '16px' }}>
              <p style={{ margin: 0, fontSize: '16px', color: COLORS.textPrimary }}>Rates <strong style={{ color: COLORS.error }}>↑</strong> → Prices <strong style={{ color: COLORS.error }}>↓</strong></p>
              <p style={{ margin: '8px 0 0 0', fontSize: '16px', color: COLORS.textPrimary }}>Rates <strong style={{ color: COLORS.success }}>↓</strong> → Prices <strong style={{ color: COLORS.success }}>↑</strong></p>
            </div>
            <div style={{ background: COLORS.accentLight, borderRadius: '6px', padding: '12px', marginTop: '16px' }}>
              <p style={{ margin: 0, fontSize: '13px', color: COLORS.accent }}><strong>Why?</strong> When rates rise, future cash flows are discounted more heavily, so they're worth less today. When rates fall, the opposite happens.</p>
            </div>
            <RabbitHoleButton rabbitHole={RABBIT_HOLES.perpetuities} explored={exploredRabbitHoles.includes('perpetuities')} onClick={() => handleRabbitHoleClick('perpetuities')} />
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary, marginTop: '16px' }}>Now let's put real numbers to this. What exactly happens to your bond's value when rates change?</p>
          </div>);
        }

        if (id === 'rateChange') {
          if (currentStep === 0) return (<div>
            <h2 style={{ color: COLORS.primary, marginBottom: '12px', fontSize: '20px' }}>When Rates Change Over Time</h2>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary }}>Here's the scenario:</p>
            <div style={{ background: COLORS.surfaceAlt, borderRadius: '10px', padding: '16px', marginTop: '12px' }}>
              <p style={{ margin: 0, fontSize: '14px', lineHeight: '1.7', color: COLORS.textPrimary }}><strong>Time 0:</strong> You buy a 3-period bond at par ($100) when rates are 6%.</p>
              <p style={{ margin: '8px 0 0 0', fontSize: '14px', lineHeight: '1.7', color: COLORS.textPrimary }}><strong>Time 1:</strong> One period passes. You receive your first $6 coupon.</p>
              <p style={{ margin: '8px 0 0 0', fontSize: '14px', lineHeight: '1.7', color: COLORS.textPrimary }}><strong>Then:</strong> Interest rates change.</p>
            </div>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary, marginTop: '16px' }}>If you wanted to sell your bond now, what would it be worth?</p>
            <InsightBox><p style={{ margin: 0 }}><strong>Key insight:</strong> Bonds can be sold at any time. The price is always the present value of the <strong>remaining</strong> cash flows — discounted at the <strong>current</strong> rate.</p></InsightBox>
          </div>);

          if (currentStep === 1) return (<div>
            <h2 style={{ color: COLORS.primary, marginBottom: '12px', fontSize: '20px' }}>Scenario 1: Rates Rise to 8%</h2>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary }}>You're at Time 1. You've already received $6. What remains?</p>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary, marginTop: '8px' }}><strong>$6</strong> at Time 2 and <strong>$106</strong> at Time 3.</p>
            <RateChangeTimeline scenario="rising" />
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary, marginTop: '12px' }}>Discount these at the <strong>new</strong> rate of 8%:</p>
            <div style={{ background: COLORS.surfaceAlt, borderRadius: '6px', padding: '12px', marginTop: '8px', fontFamily: 'monospace', fontSize: '14px' }}>
              <p style={{ margin: 0 }}>PV = $6 / 1.08 + $106 / (1.08)^2</p>
            </div>
            <CalculationBox prompt="What is the bond worth at Time 1?" correctAnswer={96.44} hint1="$6 / 1.08 = $5.56" hint2="$106 / 1.1664 = $90.88. Now add them." tolerance={0.10} onCorrect={() => setRateRiseCalcComplete(true)} />
          </div>);

          if (currentStep === 2) return (<div>
            <h2 style={{ color: COLORS.primary, marginBottom: '12px', fontSize: '20px' }}>Scenario 2: Rates Fall to 4%</h2>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary }}>Now imagine rates fell instead. Same remaining cash flows ($6 and $106), but now discounted at 4%:</p>
            <RateChangeTimeline scenario="falling" />
            <div style={{ background: COLORS.surfaceAlt, borderRadius: '6px', padding: '12px', marginTop: '12px', fontFamily: 'monospace', fontSize: '14px' }}>
              <p style={{ margin: 0 }}>PV = $6 / 1.04 + $106 / (1.04)^2</p>
            </div>
            <CalculationBox prompt="What is the bond worth at Time 1?" correctAnswer={103.85} hint1="$6 / 1.04 = $5.77" hint2="$106 / 1.0816 = $98.08. Now add them." tolerance={0.10} onCorrect={() => setRateFallCalcComplete(true)} />
          </div>);

          return (<div>
            <h2 style={{ color: COLORS.primary, marginBottom: '12px', fontSize: '20px' }}>Same Bond, Opposite Outcomes</h2>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary }}>You invested $100. After one period with the $6 coupon received:</p>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginTop: '16px' }}>
              <div style={{ background: COLORS.errorBg, border: `2px solid #fecaca`, borderRadius: '10px', padding: '16px' }}>
                <div style={{ fontSize: '13px', fontWeight: '600', color: COLORS.error, marginBottom: '8px' }}>If rates rose to 8%</div>
                <div style={{ fontSize: '13px', color: COLORS.textPrimary, marginBottom: '4px' }}>Cash: $6.00</div>
                <div style={{ fontSize: '13px', color: COLORS.textPrimary, marginBottom: '4px' }}>Bond: $96.44</div>
                <div style={{ fontSize: '15px', fontWeight: '700', color: COLORS.error, borderTop: `1px solid #fecaca`, paddingTop: '8px', marginTop: '8px' }}>Total: $102.44</div>
                <div style={{ fontSize: '12px', color: COLORS.error, marginTop: '4px' }}>Loss vs. 6%: -$3.56</div>
              </div>
              <div style={{ background: COLORS.successBg, border: `2px solid ${COLORS.successBorder}`, borderRadius: '10px', padding: '16px' }}>
                <div style={{ fontSize: '13px', fontWeight: '600', color: COLORS.success, marginBottom: '8px' }}>If rates fell to 4%</div>
                <div style={{ fontSize: '13px', color: COLORS.textPrimary, marginBottom: '4px' }}>Cash: $6.00</div>
                <div style={{ fontSize: '13px', color: COLORS.textPrimary, marginBottom: '4px' }}>Bond: $103.85</div>
                <div style={{ fontSize: '15px', fontWeight: '700', color: COLORS.success, borderTop: `1px solid ${COLORS.successBorder}`, paddingTop: '8px', marginTop: '8px' }}>Total: $109.85</div>
                <div style={{ fontSize: '12px', color: COLORS.success, marginTop: '4px' }}>Gain vs. 6%: +$3.85</div>
              </div>
            </div>
            <InsightBox warning={true}><p style={{ margin: 0 }}>This is <strong>interest rate risk</strong>. The issuer didn't miss any payments — you got exactly what was promised. But rate movements created gains or losses anyway.</p></InsightBox>
          </div>);
        }

        if (id === 'realWorld') {
          if (currentStep === 0) return (<div>
            <h2 style={{ color: COLORS.primary, marginBottom: '12px', fontSize: '20px' }}>A 40-Year Tailwind</h2>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary }}>For nearly <strong>40 years</strong>, interest rates trended downward. In 1981, the Fed's rate peaked above 19%. By 2020, it was near zero.</p>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary, marginTop: '12px' }}>During this long decline, bond investors enjoyed a tailwind — falling rates meant rising prices. Many forgot the relationship works both ways.</p>
            <InsightBox><p style={{ margin: 0 }}>The math you just practiced explains why bond investors loved this era. Every time rates fell, their bonds became more valuable.</p></InsightBox>
          </div>);
          return (<div>
            <h2 style={{ color: COLORS.primary, marginBottom: '12px', fontSize: '20px' }}>The 2022 Reversal</h2>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary }}>To fight inflation, the Fed raised rates from near zero to over 5% in 18 months — the fastest pace in decades.</p>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary, marginTop: '12px' }}>The inverse relationship kicked in with brutal force. Bond funds had their worst year in decades. Banks that had loaded up on bonds at low rates discovered billions in paper losses.</p>
            <InsightBox warning={true}><p style={{ margin: 0 }}>The calculation you just did — discounting remaining cash flows at a new, higher rate — explains exactly what happened to those portfolios.</p></InsightBox>
            <RabbitHoleButton rabbitHole={RABBIT_HOLES.rateShock2022} explored={exploredRabbitHoles.includes('rateShock2022')} onClick={() => handleRabbitHoleClick('rateShock2022')} />
          </div>);
        }

        if (id === 'lookingAhead') {
          if (currentStep === 0) return (<div>
            <h2 style={{ color: COLORS.primary, marginBottom: '12px', fontSize: '20px' }}>One Rate Isn't the Whole Story</h2>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary }}>We've used <strong>one interest rate</strong> for all periods. But in reality, the rate for borrowing 1 year is often different from 10 years.</p>
            <div style={{ background: COLORS.surfaceAlt, borderRadius: '10px', padding: '16px', marginTop: '16px' }}>
              <p style={{ margin: 0, fontSize: '14px', lineHeight: '1.7', color: COLORS.textPrimary }}>Sometimes short-term rates are higher.</p>
              <p style={{ margin: '6px 0 0 0', fontSize: '14px', lineHeight: '1.7', color: COLORS.textPrimary }}>Sometimes long-term rates are higher.</p>
              <p style={{ margin: '6px 0 0 0', fontSize: '14px', lineHeight: '1.7', color: COLORS.textPrimary }}>Sometimes the pattern inverts.</p>
            </div>
          </div>);
          return (<div>
            <h2 style={{ color: COLORS.primary, marginBottom: '12px', fontSize: '20px' }}>Coming Up Next</h2>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary }}>This pattern is called the <strong>term structure of interest rates</strong>.</p>
            <p style={{ fontSize: '15px', lineHeight: '1.6', color: COLORS.textPrimary, marginTop: '12px' }}>Understanding it helps explain:</p>
            <ul style={{ fontSize: '14px', lineHeight: '1.8', color: COLORS.textPrimary, marginTop: '8px', paddingLeft: '20px' }}>
              <li>Why some bonds are more sensitive to rate changes</li>
              <li>How market expectations get reflected in bond prices</li>
              <li>What an "inverted yield curve" means</li>
            </ul>
            <div style={{ background: COLORS.goldLight, border: `2px solid ${COLORS.goldBorder}`, borderRadius: '10px', padding: '16px', marginTop: '20px', textAlign: 'center' }}>
              <p style={{ margin: 0, fontSize: '15px', color: COLORS.textPrimary }}>That's where we're headed next.</p>
            </div>
          </div>);
        }

        // Complete
        return (<div style={{ textAlign: 'center' }}>
          <div style={{ fontSize: '40px', marginBottom: '12px' }}>&#127881;</div>
          <h2 style={{ color: COLORS.primary, marginBottom: '12px', fontSize: '20px' }}>Tutorial Complete!</h2>
          <div style={{ background: COLORS.surfaceAlt, borderRadius: '10px', padding: '20px', marginBottom: '20px', textAlign: 'left' }}>
            <h3 style={{ color: COLORS.textPrimary, marginBottom: '12px', fontSize: '16px' }}>What You Learned</h3>
            <ul style={{ margin: 0, paddingLeft: '20px', color: COLORS.textPrimary, lineHeight: '1.8', fontSize: '14px' }}>
              <li>Bond prices move opposite to rates (inverse relationship)</li>
              <li>Bond value = PV of <strong>remaining</strong> cash flows at <strong>current</strong> rate</li>
              <li>Rising rates = losses; Falling rates = gains</li>
              <li>This "interest rate risk" has real consequences</li>
            </ul>
          </div>
          <div style={{ background: COLORS.rabbitHoleLight, borderRadius: '10px', padding: '16px', marginBottom: '20px' }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
              <LucideIcon name="Rabbit" size={20} color={COLORS.rabbitHole} />
              <span style={{ color: COLORS.rabbitHole, fontWeight: '500', fontSize: '14px' }}>You explored {exploredRabbitHoles.length} of 3 rabbit holes</span>
            </div>
            {exploredRabbitHoles.length < 3 && (
              <div style={{ marginTop: '12px', display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {Object.keys(RABBIT_HOLES).filter(id => !exploredRabbitHoles.includes(id)).map(id => (
                  <button key={id} onClick={() => handleRabbitHoleClick(id)} style={{ padding: '8px 12px', border: `1px solid ${COLORS.rabbitHoleBorder}`, borderRadius: '6px', background: 'white', color: COLORS.rabbitHole, fontSize: '13px', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '6px' }}>
                    <LucideIcon name="Rabbit" size={14} /> {RABBIT_HOLES[id].title}
                  </button>
                ))}
              </div>
            )}
          </div>
          <a href="Tutorial-F-BeyondBonds.html" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '10px', background: COLORS.primary, color: 'white', borderRadius: '6px', padding: '14px', textDecoration: 'none', fontWeight: '500', fontSize: '14px' }}>
            <span>Next: Tutorial F — Beyond Bonds</span>
            <LucideIcon name="ArrowRight" size={18} />
          </a>
          <button onClick={handleRestart} style={{ marginTop: '20px', padding: '8px 20px', border: `1px solid ${COLORS.border}`, borderRadius: '6px', background: 'white', color: COLORS.textPrimary, fontSize: '14px', cursor: 'pointer', display: 'inline-flex', alignItems: 'center', gap: '6px' }}>
            <LucideIcon name="RotateCcw" size={14} />Restart
          </button>
        </div>);
      };

      return (
        <div style={{ minHeight: '100vh', background: COLORS.background, fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif' }}>
          <Header currentPartIndex={currentPartIndex} currentStep={currentStep} exploredRabbitHoles={exploredRabbitHoles} onGlossaryClick={() => setShowGlossary(true)} onRabbitHoleListClick={() => setShowRabbitHoleList(true)} onRestartClick={() => setShowRestartConfirm(true)} onHeaderClick={handleHeaderClick} soundEnabled={soundEnabled} onSoundToggle={() => setSoundEnabled(s => !s)} />
          <main style={{ maxWidth: '700px', margin: '0 auto', padding: '20px 16px' }}>
            <div style={{ background: 'white', borderRadius: '12px', padding: '24px', boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
              {renderPart()}
              {currentPart.id !== 'complete' && <NavButtons onBack={handleBack} onContinue={handleContinue} canGoBack={canGoBack} canContinue={canContinue} />}
            </div>
          </main>

          {/* Tutorial Navigation Footer */}
          <div style={{
            background: '#00356b',
            padding: '24px',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            gap: '16px',
            marginTop: '40px',
          }}>
            <a href="Tutorial-D-FindingInterestRates.html" style={{
              padding: '12px 24px',
              background: 'rgba(255,255,255,0.15)',
              borderRadius: '8px',
              color: 'white',
              textDecoration: 'none',
              textAlign: 'center',
              minWidth: '140px',
            }}>
              <div style={{ fontSize: '14px', fontWeight: '500' }}>&larr; Previous</div>
              <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>Finding Interest Rates</div>
            </a>
            <a href="index.html" style={{
              padding: '12px 24px',
              background: '#b8860b',
              borderRadius: '8px',
              color: 'white',
              textDecoration: 'none',
              textAlign: 'center',
              minWidth: '140px',
              fontWeight: '500',
            }}>
              Hub
            </a>
            <a href="Tutorial-F-BeyondBonds.html" style={{
              padding: '12px 24px',
              background: 'rgba(255,255,255,0.15)',
              borderRadius: '8px',
              color: 'white',
              textDecoration: 'none',
              textAlign: 'center',
              minWidth: '140px',
            }}>
              <div style={{ fontSize: '14px', fontWeight: '500' }}>Next &rarr;</div>
              <div style={{ fontSize: '12px', opacity: 0.8, marginTop: '4px' }}>Beyond Bonds</div>
            </a>
          </div>

          {showGlossary && <Modal title="Glossary" color={COLORS.primary} icon={<LucideIcon name="BookOpen" size={20} />} onClose={() => setShowGlossary(false)}>
            {Object.values(GLOSSARY).map((item, i) => (<div key={item.term} style={{ padding: '12px 0', borderBottom: i < Object.values(GLOSSARY).length - 1 ? `1px solid ${COLORS.border}` : 'none' }}>
              <h3 style={{ margin: '0 0 4px 0', fontSize: '15px', fontWeight: '600', color: COLORS.primary }}>{item.term}</h3>
              <p style={{ margin: 0, fontSize: '13px', lineHeight: '1.4', color: COLORS.textSecondary }}>{item.definition}</p>
            </div>))}
          </Modal>}

          {showRabbitHoleList && (
            <RabbitHoleListModal
              exploredRabbitHoles={exploredRabbitHoles}
              onSelectRabbitHole={handleRabbitHoleFromList}
              onClose={() => setShowRabbitHoleList(false)}
            />
          )}

          {showRestartConfirm && <Modal title="Restart Tutorial?" color={COLORS.warning} icon={<LucideIcon name="AlertCircle" size={20} />} onClose={() => setShowRestartConfirm(false)} buttonText="Cancel">
            <p style={{ margin: 0 }}>Are you sure? All progress will be lost.</p>
            <button onClick={handleRestart} style={{ marginTop: '12px', padding: '8px 16px', border: 'none', borderRadius: '6px', background: COLORS.warning, color: 'white', fontSize: '14px', fontWeight: '500', cursor: 'pointer' }}>Yes, Restart</button>
          </Modal>}

          {activeRabbitHole && <Modal title={activeRabbitHole.title} color={COLORS.rabbitHole} icon={<LucideIcon name="Rabbit" size={20} />} onClose={() => setActiveRabbitHole(null)} buttonText="Back to Tutorial">
            {activeRabbitHole.content.split('\n\n').map((p, i) => <p key={i} style={{ margin: i === 0 ? 0 : '12px 0 0 0' }}>{p}</p>)}
          </Modal>}

          {devMode && <div style={{ position: 'fixed', bottom: '16px', right: '16px', background: 'white', border: `2px solid ${COLORS.warning}`, borderRadius: '10px', padding: '12px', boxShadow: '0 4px 20px rgba(0,0,0,0.15)', zIndex: 999 }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
              <span style={{ fontSize: '12px', fontWeight: '600', color: COLORS.warning }}>Dev Mode</span>
              <button onClick={() => setDevMode(false)} style={{ background: 'none', border: 'none', cursor: 'pointer', color: COLORS.textMuted, padding: '2px' }}><LucideIcon name="X" size={14} /></button>
            </div>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
              {PARTS.map((part, i) => <button key={part.id} onClick={() => { setCurrentPartIndex(i); setCurrentStep(0); }} style={{ padding: '6px 10px', border: `1px solid ${i === currentPartIndex ? COLORS.warning : COLORS.border}`, borderRadius: '4px', background: i === currentPartIndex ? COLORS.warningBg : 'white', color: COLORS.textPrimary, fontSize: '11px', textAlign: 'left', cursor: 'pointer' }}>{i + 1}. {part.title}</button>)}
            </div>
          </div>}
        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Tutorial02ERateChanges />);
  </script>
</body>
</html>
